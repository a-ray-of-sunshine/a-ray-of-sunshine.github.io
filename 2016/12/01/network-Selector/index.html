<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Selector | Shawshank</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Selector</h1><a id="logo" href="/.">Shawshank</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Selector</h1><div class="post-meta">Dec 1, 2016</div><div class="post-content"><h2 id="1-socket-的-I-O-编程模型"><a href="#1-socket-的-I-O-编程模型" class="headerlink" title="1. socket 的 I/O 编程模型"></a>1. socket 的 I/O 编程模型</h2><p>socket 在 c 中的使用 select / poll / epoll</p>
<h3 id="select"><a href="#select" class="headerlink" title="select"></a>select</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> nfds, fd_set *readfds, fd_set *writefds,</span></span></span><br><span class="line"><span class="function"><span class="params">           fd_set *exceptfds, struct timeval *timeout)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// Removes the descriptor fd from set.</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_CLR</span><span class="params">(<span class="keyword">int</span> fd, fd_set *<span class="built_in">set</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Nonzero if fd is a member of the set. Otherwise, zero.</span></span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">FD_ISSET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *<span class="built_in">set</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Adds descriptor fd to set.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_SET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *<span class="built_in">set</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initializes the set to the null set.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_ZERO</span><span class="params">(fd_set *<span class="built_in">set</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span>    tv_sec;         <span class="comment">/* seconds */</span></span><br><span class="line">    <span class="keyword">long</span>    tv_usec;        <span class="comment">/* microseconds */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>select() and pselect() allow a program to monitor multiple file descriptors, waiting until one or more of the file descriptors become “ready” for some class of I/O operation (e.g., input possible). A file descriptor is considered ready if it is possible to perform the corresponding I/O operation (e.g., read(2)) without blocking.</p>
<p>Three independent sets of file descriptors are watched. </p>
<p>On exit, the sets are modified in place to indicate which file descriptors actually changed status. Each of the three file descriptor sets may be specified as NULL if no file descriptors are to be watched for the corresponding class of events.</p>
<p>On success, select() and pselect() return the number of file descriptors contained in the three returned descriptor sets (that is, the total number of bits that are set in readfds, writefds, exceptfds) which may be zero if the timeout expires before anything interesting happens. On error, -1 is returned, and errno is set appropriately; the sets and timeout become undefined, so do not rely on their contents after an error.</p>
<p>FD_ZERO() clears a set. FD_SET() and FD_CLR() respectively add and remove a given file descriptor from a set. FD_ISSET() tests to see if a file descriptor is part of the set;</p>
</blockquote>
<h3 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span><span class="params">(struct pollfd *fds, <span class="keyword">nfds_t</span> nfds, <span class="keyword">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span>   fd;         <span class="comment">/* file descriptor */</span></span><br><span class="line">    <span class="keyword">short</span> events;     <span class="comment">/* requested events */</span></span><br><span class="line">    <span class="keyword">short</span> revents;    <span class="comment">/* returned events */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>poll() performs a similar task to select(2): it waits for one of a set of file descriptors to become ready to perform I/O.</p>
<p><strong>fds:</strong> The set of file descriptors to be monitored is specified in the fds argument, which is an array of structures of pollfd</p>
<p><strong>nfds:</strong> specify the number of items in the fds array</p>
<p><strong>timeout:</strong> specifies the minimum number of milliseconds that poll() will block.</p>
</blockquote>
<p>poll 调用后执行的效果</p>
<blockquote>
<p>On success, a positive number is returned; this is the number of structures which have nonzero revents fields (in other words, those descriptors with events or errors reported). A value of 0 indicates that the call timed out and no file descriptors were ready. On error, -1 is returned, and errno is set appropriately.</p>
</blockquote>
<p>其中 pollfd 结构体中的 <code>revents</code>, The field revents is an <strong>output parameter</strong>, filled by the kernel with the events that actually occurred. </p>
<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><blockquote>
<p>The epoll API performs a similar task to poll(2): monitoring multiple file descriptors to see if I/O is possible on any of them.</p>
<p>Three system calls are provided to set up and control an epoll set: epoll_create(2), epoll_ctl(2), epoll_wait(2).</p>
<p>An epoll set is connected to a file descriptor created by epoll_create(2). Interest for certain file descriptors is then registered via epoll_ctl(2). Finally, the actual wait is started by epoll_wait(2).</p>
</blockquote>
<h4 id="epoll-create"><a href="#epoll-create" class="headerlink" title="epoll_create"></a>epoll_create</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_create</span><span class="params">(<span class="keyword">int</span> size)</span></span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>epoll_create() creates an epoll(7) instance. Since Linux 2.6.8, the size argument is ignored, but must be greater than zero;</p>
<p><strong>epoll_create() returns a file descriptor referring to the new epoll instance. This file descriptor is used for all the subsequent calls to the epoll interface.</strong> When no longer required, the file descriptor returned by epoll_create() should be closed by using close(2). When all file descriptors referring to an epoll instance have been closed, the kernel destroys the instance and releases the associated resources for reuse.</p>
</blockquote>
<h4 id="epoll-ctl"><a href="#epoll-ctl" class="headerlink" title="epoll_ctl"></a>epoll_ctl</h4><p>This system call performs control operations on the epoll(7) instance referred to by the file descriptor epfd. It requests that the operation op be performed for the target file descriptor fd.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> op, <span class="keyword">int</span> fd, struct epoll_event *event)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> epoll_data &#123;</span><br><span class="line">    <span class="keyword">void</span>        *ptr;</span><br><span class="line">    <span class="keyword">int</span>          fd;</span><br><span class="line">    <span class="keyword">uint32_t</span>     u32;</span><br><span class="line">    <span class="keyword">uint64_t</span>     u64;</span><br><span class="line">&#125; <span class="keyword">epoll_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span>     events;      <span class="comment">/* Epoll events */</span></span><br><span class="line">    <span class="keyword">epoll_data_t</span> data;        <span class="comment">/* User data variable */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>epfd</p>
<p>  the epoll(7) instance referred to by the file descriptor epfd.</p>
</li>
<li><p>op</p>
<p>  the operation op be performed for the target file descriptor <strong>fd</strong></p>
<ul>
<li><p>EPOLL_CTL_ADD</p>
<p>  Register the target file descriptor fd on the epoll instance referred to by the file descriptor epfd and associate the event event with the internal file linked to fd.</p>
</li>
<li><p>EPOLL_CTL_MOD</p>
<p>  Change the event event associated with the target file descriptor fd.</p>
</li>
<li><p>EPOLL_CTL_DEL</p>
<p>  Remove (deregister) the target file descriptor fd from the epoll instance referred to by epfd. The event is ignored and can be NUL.</p>
</li>
</ul>
</li>
<li><p>fd</p>
<p>  执行上述操作的目标 file descriptor</p>
</li>
<li><p>event</p>
<p>  The event argument describes the object linked to the file descriptor <strong>fd</strong>.</p>
<p>  这个参数是一个 epoll_event 结构体的对象</p>
<p>  其中的 events 表示关注的事件类型，可以是以下值：</p>
<ul>
<li><p>EPOLLIN</p>
<p>  The associated file is available for read(2) operations.</p>
</li>
<li><p>EPOLLOUT</p>
<p>  The associated file is available for write(2) operations.</p>
</li>
</ul>
</li>
</ul>
<h4 id="epoll-wait"><a href="#epoll-wait" class="headerlink" title="epoll_wait"></a>epoll_wait</h4><h5 id="函数定义"><a href="#函数定义" class="headerlink" title="函数定义"></a>函数定义</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd, struct epoll_event *events,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">int</span> maxevents, <span class="keyword">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure>
<h5 id="函数行为"><a href="#函数行为" class="headerlink" title="函数行为"></a>函数行为</h5><p>The epoll_wait() system call waits for events on the epoll(7) instance referred to by the file descriptor epfd.</p>
<h5 id="函数参数"><a href="#函数参数" class="headerlink" title="函数参数"></a>函数参数</h5><ul>
<li><p>epfd</p>
<p>  the epoll(7) instance referred to by the file descriptor epfd</p>
</li>
<li><p>events</p>
<p>  The memory area pointed to by events will contain the events that will be available for the caller.</p>
</li>
<li><p>maxevents</p>
<p>  Up to maxevents are returned by epoll_wait(). The maxevents argument must be greater than zero.</p>
</li>
<li><p>timeout</p>
<p>  The timeout argument specifies the minimum number of milliseconds that epoll_wait() will block. </p>
</li>
</ul>
<h5 id="函数返回值"><a href="#函数返回值" class="headerlink" title="函数返回值"></a>函数返回值</h5><blockquote>
<p>When successful, epoll_wait() returns the number of file descriptors ready for the requested I/O, or zero if no file descriptor became ready during the requested timeout milliseconds. When an error occurs, epoll_wait() returns -1 and errno is set appropriately.</p>
</blockquote>
<h2 id="2-jdk-中实现的-select"><a href="#2-jdk-中实现的-select" class="headerlink" title="2. jdk 中实现的 select"></a>2. jdk 中实现的 select</h2><h3 id="2-1-SelectableChannel"><a href="#2-1-SelectableChannel" class="headerlink" title="2.1 SelectableChannel"></a>2.1 SelectableChannel</h3><blockquote>
<p>A channel that can be multiplexed via a Selector. </p>
<p>SelectableChannel 是一种可以被 Selector 使用多路复用的 Channel</p>
<p><strong>In order to be used with a selector, an instance of this class must first be registered via the register method.</strong> This method returns a new SelectionKey object that represents the channel’s registration with the selector. </p>
<p><strong>A channel must be placed into non-blocking mode before being registered with a selector,</strong> and may not be returned to blocking mode until it has been deregistered.</p>
</blockquote>
<p>调用 <code>register</code> 返回一个 SelectionKey</p>
<p>这个接口的功能：</p>
<ul>
<li><p>注册 channel 到一个 selector</p>
<p>  调用 <code>register</code> 将当前 channel 注册到 selector</p>
</li>
<li><p>一个 channel 可以注册到多个 selector</p>
<p>  一个 channel 可以注册到多个完全不同的 selector，同时对于同一个 selector 多次调用 <code>register</code> 只是改变当前已经注册的 SelectionKey 的相关属性。</p>
</li>
<li><p>channel 取消注册</p>
<p>  channel 关闭时，默认将从 selector 取消注册。（调用其 cancel 方法）</p>
</li>
</ul>
<p>由于 SelectableChannel 可以注册到多个 selector 上，所有这个接口的实现中持有一个SelectionKey 的数组，用来维护，所有已经注册到当前Channel上的 selector。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractSelectableChannel</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSelectableChannel</span> <span class="keyword">extends</span> <span class="title">SelectableChannel</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Keys that have been created by registering this channel with selectors.</span></span><br><span class="line">    <span class="comment">// They are saved because if this channel is closed the keys must be</span></span><br><span class="line">    <span class="comment">// deregistered.  Protected by keyLock.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">private</span> SelectionKey[] keys = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> keyCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SelectionKey <span class="title">register</span><span class="params">(Selector sel, <span class="keyword">int</span> ops,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Object att)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ClosedChannelException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isOpen())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClosedChannelException();</span><br><span class="line">        <span class="keyword">if</span> ((ops &amp; ~validOps()) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">		<span class="comment">// 在注册时对 regLock 进行加锁操作，保证线程安全</span></span><br><span class="line">        <span class="keyword">synchronized</span> (regLock) &#123;</span><br><span class="line">			<span class="comment">// 使用 select io模型时，channel 必须牌 non-blocking 模式。</span></span><br><span class="line">            <span class="keyword">if</span> (blocking)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalBlockingModeException();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 查找待注册的 Selector 的 SelectionKey</span></span><br><span class="line">            SelectionKey k = findKey(sel);</span><br><span class="line">            <span class="keyword">if</span> (k != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// k 不为空，则表示当前 channel 已经在 sel 注册过了</span></span><br><span class="line">				<span class="comment">// 所以只是改变下面的属性即可。</span></span><br><span class="line">				<span class="comment">// 覆盖 interestOps</span></span><br><span class="line">                k.interestOps(ops);</span><br><span class="line">				<span class="comment">// 覆盖 attachment</span></span><br><span class="line">                k.attach(att);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// 表明是第一次注册，调用 sel 的 register 方法进行注册。</span></span><br><span class="line">                k = ((AbstractSelector)sel).register(<span class="keyword">this</span>, ops, att);</span><br><span class="line">				<span class="comment">// 将注册成功之后的 SelectionKey 添加到 当前 channel 维护的</span></span><br><span class="line">				<span class="comment">// keys 数组中。</span></span><br><span class="line">                addKey(k);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> k;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于不同的 SelectableChannel 可能关注的操作不同，所以这个类的 <code>validOps</code> 方法由子类来实现。只有具体的子类才知道，自己关注什么操作。</p>
<p>同时 <code>AbstractSelectableChannel</code> 重写了 <code>implCloseChannel</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">implCloseChannel</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    implCloseSelectableChannel();</span><br><span class="line">    <span class="keyword">synchronized</span> (keyLock) &#123;</span><br><span class="line">        <span class="keyword">int</span> count = (keys == <span class="keyword">null</span>) ? <span class="number">0</span> : keys.length;</span><br><span class="line">		<span class="comment">// 当 channel 被关闭的时候，释放 channel 在 selector 的注册。</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            SelectionKey k = keys[i];</span><br><span class="line">            <span class="keyword">if</span> (k != <span class="keyword">null</span>)</span><br><span class="line">                k.cancel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>keyFor</code> 方法用来，查询 channel 在 selector 上的注册关系 SelectionKey</p>
<h3 id="2-2-SelectionKey"><a href="#2-2-SelectionKey" class="headerlink" title="2.2 SelectionKey"></a>2.2 SelectionKey</h3><blockquote>
<p>A token representing the registration of a SelectableChannel with a Selector. </p>
<p>代表 Channel 和 Selector 的注册关系</p>
</blockquote>
<p>所以 SelectionKey 持有具有注册关系的 &lt;Channel, Selector&gt; 对。</p>
<p>其 <code>channel</code> 方法返回注册关系中的 SelectableChannel 对象</p>
<p>其 <code>selector</code> 方法返回注册关系中的 Selector 对象</p>
<h4 id="2-2-1-断开注册关系"><a href="#2-2-1-断开注册关系" class="headerlink" title="2.2.1 断开注册关系"></a>2.2.1 断开注册关系</h4><p>SelectionKey 的 <code>cancel</code> 方法可以断开这种注册关系</p>
<h4 id="2-2-2-注册关系的属性"><a href="#2-2-2-注册关系的属性" class="headerlink" title="2.2.2 注册关系的属性"></a>2.2.2 注册关系的属性</h4><ul>
<li><p>attachment</p>
<p>  表示当前 key 对象，附加的一个参数。</p>
<p>  可以使用 <code>attach</code> 方法将一个对象附加到这个 key 上，同时这个方法将返回之前已经附加过的对象。</p>
<p>  使用 <code>attachment</code> 返回当前附加的对象。</p>
<p>  <strong>这个属性存在的意义：<code>register</code> 方法的调用(SelectionKey对象的创建)和 SelectionKey的使用通常不在一个线程中，所以可以通过这个对象，实现，跨线程传递参数。</strong></p>
</li>
<li><p>interestOps</p>
<p>  表示这个 key 所关注的操作。</p>
<p>  使用 <code>interestOps</code> 方法可以进行设置，注意这个设置是完全覆盖，而不是和已经存在的值进行异或。</p>
</li>
</ul>
<h4 id="2-2-3-用来标识在-Selector-上注册的某种操作，已经准备就绪"><a href="#2-2-3-用来标识在-Selector-上注册的某种操作，已经准备就绪" class="headerlink" title="2.2.3 用来标识在 Selector 上注册的某种操作，已经准备就绪"></a>2.2.3 用来标识在 Selector 上注册的某种操作，已经准备就绪</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SelectionKeyImpl</span> <span class="keyword">extends</span> <span class="title">AbstractSelectionKey</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 用来标识，已经准备就绪的操作。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> readyOps;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 读取 readyOps</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readyOps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ensureValid();</span><br><span class="line">        <span class="keyword">return</span> readyOps;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">nioReadyOps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> readyOps;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置 readyOps</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">nioReadyOps</span><span class="params">(<span class="keyword">int</span> ops)</span> </span>&#123;</span><br><span class="line">        readyOps = ops;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 来自父类 SelectionKey</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_READ = <span class="number">1</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WRITE = <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_CONNECT = <span class="number">1</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_ACCEPT = <span class="number">1</span> &lt;&lt; <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tests whether this key's channel is ready for reading. </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isReadable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (readyOps() &amp; OP_READ) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tests whether this key's channel is ready for writing. </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isWritable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (readyOps() &amp; OP_WRITE) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tests whether this key's channel has either finished, or failed to finish, its socket-connection operation.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isConnectable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (readyOps() &amp; OP_CONNECT) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tests whether this key's channel is ready to accept a new socket connection. </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isAcceptable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (readyOps() &amp; OP_ACCEPT) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-Selector"><a href="#2-3-Selector" class="headerlink" title="2.3 Selector"></a>2.3 Selector</h3><blockquote>
<p>A multiplexor of SelectableChannel objects. </p>
<p>多路复用器 for SelectableChannel 对象</p>
</blockquote>
<p><strong>select 方法的实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectorImpl</span> <span class="keyword">extends</span> <span class="title">AbstractSelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 由具体的子类实现 select 方法。</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doSelect</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">lockAndDoSelect</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isOpen())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ClosedSelectorException();</span><br><span class="line">            <span class="keyword">synchronized</span> (publicKeys) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (publicSelectedKeys) &#123;</span><br><span class="line">                    <span class="keyword">return</span> doSelect(timeout);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">long</span> timeout)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Negative timeout"</span>);</span><br><span class="line">        <span class="keyword">return</span> lockAndDoSelect((timeout == <span class="number">0</span>) ? -<span class="number">1</span> : timeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">select</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> select(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">selectNow</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lockAndDoSelect(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-1-linux-平台下的实现"><a href="#2-3-1-linux-平台下的实现" class="headerlink" title="2.3.1 linux 平台下的实现"></a>2.3.1 linux 平台下的实现</h4><ul>
<li><p>SunOS</p>
<p>  <code>DevPollSelectorImpl</code></p>
</li>
<li><p>Linux &amp; Linux kernels &gt;= 2.6</p>
<p>  <code>EPollSelectorImpl</code></p>
</li>
<li><p>Linux</p>
<p>  <code>PollSelectorImpl</code></p>
</li>
</ul>
<h4 id="2-3-2-windows-平台下的实现"><a href="#2-3-2-windows-平台下的实现" class="headerlink" title="2.3.2 windows 平台下的实现"></a>2.3.2 windows 平台下的实现</h4><p><code>WindowsSelectorImpl</code></p>
<ul>
<li><p>register 的实现</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SelectorImpl</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> SelectionKey <span class="title">register</span><span class="params">(AbstractSelectableChannel ch,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         <span class="keyword">int</span> ops,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         Object attachment)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (!(ch <span class="keyword">instanceof</span> SelChImpl))</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalSelectorException();</span><br><span class="line">	<span class="comment">// 创建 SelectionKey</span></span><br><span class="line">       SelectionKeyImpl k = <span class="keyword">new</span> SelectionKeyImpl((SelChImpl)ch, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加附件</span></span><br><span class="line">       k.attach(attachment);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">synchronized</span> (publicKeys) &#123;</span><br><span class="line">		<span class="comment">// 调用子类的实现，进行注册。</span></span><br><span class="line">           implRegister(k);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置 interestOps</span></span><br><span class="line">       k.interestOps(ops);</span><br><span class="line">       <span class="keyword">return</span> k;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> INIT_CAP = <span class="number">8</span>;</span><br><span class="line">   <span class="keyword">private</span> SelectionKeyImpl[] channelArray = <span class="keyword">new</span> SelectionKeyImpl[INIT_CAP];</span><br><span class="line"><span class="comment">// WindowsSelectorImpl</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">implRegister</span><span class="params">(SelectionKeyImpl ski)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">synchronized</span> (closeLock) &#123;</span><br><span class="line">           <span class="keyword">if</span> (pollWrapper == <span class="keyword">null</span>)</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> ClosedSelectorException();</span><br><span class="line">           growIfNeeded();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 将 SelectionKey 存储到 Selector 相关的结构中</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 以数组的形式存储 SelectionKey</span></span><br><span class="line">           channelArray[totalChannels] = ski;</span><br><span class="line">           <span class="comment">// 设置 SelectionKey 在 channelArray 数组中的索引</span></span><br><span class="line">           ski.setIndex(totalChannels);</span><br><span class="line">           <span class="comment">// 可以通过 fdMap.get(fd); 查找到 fd 对应的 SelectionKey 对象，</span></span><br><span class="line">           <span class="comment">// 用在当 select 操作完成之后，需要对 fd 所对应的 SelectionKey 进行设置时。</span></span><br><span class="line">           fdMap.put(ski);</span><br><span class="line">           <span class="comment">// The set of keys registered with this Selector</span></span><br><span class="line">           <span class="comment">// keys 存储所有在 Selector 上注册的 SelectionKey</span></span><br><span class="line">           <span class="comment">// Selector.keys 方法将返回这个集合</span></span><br><span class="line">           keys.add(ski);</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// totalChannels 表示 ski 在 channelArray 中的索引位置</span></span><br><span class="line">           <span class="comment">// 将注册的Socket的 fd 存储到 pollWrapper 中的 pollArray 中</span></span><br><span class="line">           <span class="comment">// pollArray 的结构如下：</span></span><br><span class="line">           <span class="comment">//  +---+---+---+---+---+---+---+---+---+---+---+---+</span></span><br><span class="line">           <span class="comment">//  |       | fd  e | fd  e | fd  e | fd  e | fd  e |</span></span><br><span class="line">           <span class="comment">//  +---+---+---+---+---+---+---+---+---+---+---+---+</span></span><br><span class="line">           <span class="comment">// 其中 fd 占4个字节，表示 socket 的文件描述符</span></span><br><span class="line">           <span class="comment">//      e  占4个字节，表示 fd 此时的关注的事件</span></span><br><span class="line">           pollWrapper.addEntry(totalChannels, ski);</span><br><span class="line"></span><br><span class="line">           totalChannels++;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>doSelect</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doSelect</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (channelArray == <span class="keyword">null</span>)</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> ClosedSelectorException();</span><br><span class="line">      <span class="keyword">this</span>.timeout = timeout; <span class="comment">// set selector timeout</span></span><br><span class="line">      processDeregisterQueue();</span><br><span class="line">      <span class="keyword">if</span> (interruptTriggered) &#123;</span><br><span class="line">          resetWakeupSocket();</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Calculate number of helper threads needed for poll. If necessary</span></span><br><span class="line">      <span class="comment">// threads are created here and start waiting on startLock</span></span><br><span class="line">      adjustThreadsCount();</span><br><span class="line">      finishLock.reset(); <span class="comment">// reset finishLock</span></span><br><span class="line">      <span class="comment">// Wakeup helper threads, waiting on startLock, so they start polling.</span></span><br><span class="line">      <span class="comment">// Redundant threads will exit here after wakeup.</span></span><br><span class="line">      startLock.startThreads();</span><br><span class="line">      <span class="comment">// do polling in the main thread. Main thread is responsible for</span></span><br><span class="line">      <span class="comment">// first MAX_SELECTABLE_FDS entries in pollArray.</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          begin();</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// poll 方法最终调用 系统底层的 select 方法</span></span><br><span class="line">              subSelector.poll();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              finishLock.setException(e); <span class="comment">// Save this exception</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Main thread is out of poll(). Wakeup others and wait for them</span></span><br><span class="line">          <span class="keyword">if</span> (threads.size() &gt; <span class="number">0</span>)</span><br><span class="line">              finishLock.waitForHelperThreads();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            end();</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// Done with poll(). Set wakeupSocket to nonsignaled  for the next run.</span></span><br><span class="line">      finishLock.checkForException();</span><br><span class="line">      processDeregisterQueue();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新 selectedKeys, 则 Selector.selectedKeys 返回这些值</span></span><br><span class="line">      <span class="keyword">int</span> updated = updateSelectedKeys();</span><br><span class="line">      <span class="comment">// Done with poll(). Set wakeupSocket to nonsignaled  for the next run.</span></span><br><span class="line">      resetWakeupSocket();</span><br><span class="line">      <span class="keyword">return</span> updated;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>updateSelectedKeys 方法的使用主要有两个：</p>
<ol>
<li><p>更新 selectedKeys </p>
<p> SelectorImpl.selectedKeys 中存储着已经可以进行操作的 SelectionKey，这里的操作是指 read, write, connection 等操作。</p>
<p> 也就是说 selectedKeys 集合里面的 SelectionKey 所指向的 Socket 可以进行上述操作，而不会被 block.</p>
</li>
<li><p>设置 SelectionKey 中的兴趣集</p>
<p> 上面更新的 selectedKeys 集合，可以通过 Selecor.selectedKeys 方法获得。但是对于 selectedKeys 中的每一个 SelectionKey， 还需要知道它此时是可以进行什么操作，所以需要对其进行设置。</p>
<p> 也就是设置 SelectionKeyImpl.readyOps 字段。</p>
<p> 这样 SelectionKey 的 isWritable， isReadable， isConnectable，isAcceptable 就可以依据 readyOps 进行判断了。</p>
<p> 核心实现在 SocketChannelImpl.translateReadyOps 方法中。</p>
</li>
</ol>
<ul>
<li>subSelector.poll() 的实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">processSelectedKeys</span><span class="params">(<span class="keyword">long</span> updateCount)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> numKeysUpdated = <span class="number">0</span>;</span><br><span class="line">    numKeysUpdated += processFDSet(updateCount, readFds,</span><br><span class="line">                                   PollArrayWrapper.POLLIN,</span><br><span class="line">                                   <span class="keyword">false</span>);</span><br><span class="line">    numKeysUpdated += processFDSet(updateCount, writeFds,</span><br><span class="line">                                   PollArrayWrapper.POLLCONN |</span><br><span class="line">                                   PollArrayWrapper.POLLOUT,</span><br><span class="line">                                   <span class="keyword">false</span>);</span><br><span class="line">    numKeysUpdated += processFDSet(updateCount, exceptFds,</span><br><span class="line">                                   PollArrayWrapper.POLLIN |</span><br><span class="line">                                   PollArrayWrapper.POLLCONN |</span><br><span class="line">                                   PollArrayWrapper.POLLOUT,</span><br><span class="line">                                   <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> numKeysUpdated;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    jint fd;</span><br><span class="line">    jshort events;</span><br><span class="line">&#125; pollfd;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_sun_nio_ch_WindowsSelectorImpl_00024SubSelector_poll0(JNIEnv *env, jobject <span class="keyword">this</span>,</span><br><span class="line">                                   jlong pollAddress, jint numfds,</span><br><span class="line">                                   jintArray returnReadFds, jintArray returnWriteFds,</span><br><span class="line">                                   jintArray returnExceptFds, jlong timeout)</span><br><span class="line">&#123;</span><br><span class="line">    DWORD result = <span class="number">0</span>;</span><br><span class="line">    pollfd *fds = (pollfd *) pollAddress;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    FD_SET readfds, writefds, exceptfds;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timevalue</span>, *<span class="title">tv</span>;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">zerotime</span> = &#123;</span><span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> read_count = <span class="number">0</span>, write_count = <span class="number">0</span>, except_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化 timeval 参数</span></span><br><span class="line">    <span class="keyword">if</span> (timeout == <span class="number">0</span>) &#123;</span><br><span class="line">        tv = &amp;zerotime;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        tv = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tv = &amp;timevalue;</span><br><span class="line">        tv-&gt;tv_sec =  (<span class="keyword">long</span>)(timeout / <span class="number">1000</span>);</span><br><span class="line">        tv-&gt;tv_usec = (<span class="keyword">long</span>)((timeout % <span class="number">1000</span>) * <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set FD_SET structures required for select */</span></span><br><span class="line">    <span class="comment">// 初始化 三个 FD_SET</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; numfds; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fds[i].events &amp; sun_nio_ch_PollArrayWrapper_POLLIN) &#123;</span><br><span class="line">           readfds.fd_array[read_count] = fds[i].fd;</span><br><span class="line">           read_count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fds[i].events &amp; (sun_nio_ch_PollArrayWrapper_POLLOUT |</span><br><span class="line">                             sun_nio_ch_PollArrayWrapper_POLLCONN))</span><br><span class="line">        &#123;</span><br><span class="line">           writefds.fd_array[write_count] = fds[i].fd;</span><br><span class="line">           write_count++;</span><br><span class="line">        &#125;</span><br><span class="line">        exceptfds.fd_array[except_count] = fds[i].fd;</span><br><span class="line">        except_count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    readfds.fd_count = read_count;</span><br><span class="line">    writefds.fd_count = write_count;</span><br><span class="line">    exceptfds.fd_count = except_count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 调用 select */</span></span><br><span class="line">    <span class="keyword">if</span> ((result = select(<span class="number">0</span> , &amp;readfds, &amp;writefds, &amp;exceptfds, tv))</span><br><span class="line">			== SOCKET_ERROR) &#123;</span><br><span class="line">   		<span class="comment">// handle error</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return selected sockets. */</span></span><br><span class="line">    <span class="comment">/* Each Java array consists of sockets count followed by sockets list */</span></span><br><span class="line">    <span class="comment">// 处理返回值 returnReadFds, returnWriteFds, returnExceptFds</span></span><br><span class="line">    (*env)-&gt;SetIntArrayRegion(env, returnReadFds, <span class="number">0</span>,</span><br><span class="line">                              readfds.fd_count + <span class="number">1</span>, (jint *)&amp;readfds);</span><br><span class="line"></span><br><span class="line">    (*env)-&gt;SetIntArrayRegion(env, returnWriteFds, <span class="number">0</span>,</span><br><span class="line">                              writefds.fd_count + <span class="number">1</span>, (jint *)&amp;writefds);</span><br><span class="line">    (*env)-&gt;SetIntArrayRegion(env, returnExceptFds, <span class="number">0</span>,</span><br><span class="line">                              exceptfds.fd_count + <span class="number">1</span>, (jint *)&amp;exceptfds);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://linux.die.net/man/2/select" target="_blank" rel="noopener">select</a></li>
<li><a href="https://linux.die.net/man/2/poll" target="_blank" rel="noopener">poll</a></li>
<li><a href="https://linux.die.net/man/4/epoll" target="_blank" rel="noopener">epoll</a></li>
<li><a href="https://linux.die.net/man/2/epoll_create" target="_blank" rel="noopener">epoll_create</a></li>
<li><a href="https://linux.die.net/man/2/epoll_ctl" target="_blank" rel="noopener">epoll_ctl</a></li>
<li><a href="https://linux.die.net/man/2/epoll_wait" target="_blank" rel="noopener">epoll_wait</a></li>
<li><a href="http://www.cnblogs.com/Anker/p/3265058.html" target="_blank" rel="noopener">select、poll、epoll之间的区别总结</a></li>
<li><a href="https://www.zhihu.com/question/32163005" target="_blank" rel="noopener">IO 多路复用是什么意思</a></li>
<li><a href="http://www.cnblogs.com/fanzhidongyzby/p/4098546.html" target="_blank" rel="noopener">高性能IO模型浅析</a></li>
<li><a href="http://www.artima.com/articles/io_design_patternsP.html" target="_blank" rel="noopener">Comparing Two High-Performance I/O Design Patterns: Reactor and Proactor</a></li>
<li><a href="https://www.zhihu.com/question/20122137" target="_blank" rel="noopener">epoll 或者 kqueue 的原理是什么</a></li>
<li><a href="http://www.kegel.com/c10k.html" target="_blank" rel="noopener">The C10K problem</a></li>
<li><a href="http://www.blogjava.net/DLevin/archive/2015/09/02/427045.html" target="_blank" rel="noopener">Reactor模式详解</a></li>
<li><a href="https://segmentfault.com/a/1190000002715832" target="_blank" rel="noopener">IO设计模式：Reactor和Proactor对比</a></li>
<li><a href="http://ifeve.com/selectors/" target="_blank" rel="noopener">Java NIO系列教程（六） Selector</a></li>
</ol>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2016/12/02/pinpoint-项目概况/">pinpoint-项目概况</a><a class="next" href="/2016/12/01/network-Channel总结/">Channel总结</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/interface/" style="font-size: 15px;">interface</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/Collections/" style="font-size: 15px;">Collections</a> <a href="/tags/Collection/" style="font-size: 15px;">Collection</a> <a href="/tags/J-U-C/" style="font-size: 15px;">J.U.C</a> <a href="/tags/lock/" style="font-size: 15px;">lock</a> <a href="/tags/Semaphore/" style="font-size: 15px;">Semaphore</a> <a href="/tags/CountDownLatch/" style="font-size: 15px;">CountDownLatch</a> <a href="/tags/CyclicBarrier/" style="font-size: 15px;">CyclicBarrier</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/LinkedList/" style="font-size: 15px;">LinkedList</a> <a href="/tags/Queue/" style="font-size: 15px;">Queue</a> <a href="/tags/Set/" style="font-size: 15px;">Set</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/collection/" style="font-size: 15px;">collection</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/mvc/" style="font-size: 15px;">mvc</a> <a href="/tags/context/" style="font-size: 15px;">context</a> <a href="/tags/component-scan/" style="font-size: 15px;">component-scan</a> <a href="/tags/storm/" style="font-size: 15px;">storm</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/命令行/" style="font-size: 15px;">命令行</a> <a href="/tags/cmder/" style="font-size: 15px;">cmder</a> <a href="/tags/win/" style="font-size: 15px;">win</a> <a href="/tags/效率/" style="font-size: 15px;">效率</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/extends/" style="font-size: 15px;">extends</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/svn/" style="font-size: 15px;">svn</a> <a href="/tags/BlockingQueue/" style="font-size: 15px;">BlockingQueue</a> <a href="/tags/LinkedBlockingQueue/" style="font-size: 15px;">LinkedBlockingQueue</a> <a href="/tags/PriorityBlockingQueue/" style="font-size: 15px;">PriorityBlockingQueue</a> <a href="/tags/ConcurrentLinkedQueue/" style="font-size: 15px;">ConcurrentLinkedQueue</a> <a href="/tags/CopyOnWriteArrayList/" style="font-size: 15px;">CopyOnWriteArrayList</a> <a href="/tags/接口/" style="font-size: 15px;">接口</a> <a href="/tags/抽象类/" style="font-size: 15px;">抽象类</a> <a href="/tags/Executor/" style="font-size: 15px;">Executor</a> <a href="/tags/ExecutorService/" style="font-size: 15px;">ExecutorService</a> <a href="/tags/CompletionService/" style="font-size: 15px;">CompletionService</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 15px;">ThreadPoolExecutor</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/vundle/" style="font-size: 15px;">vundle</a> <a href="/tags/ArrayList/" style="font-size: 15px;">ArrayList</a> <a href="/tags/log/" style="font-size: 15px;">log</a> <a href="/tags/index/" style="font-size: 15px;">index</a> <a href="/tags/concepts/" style="font-size: 15px;">concepts</a> <a href="/tags/Timer/" style="font-size: 15px;">Timer</a> <a href="/tags/TimerTask/" style="font-size: 15px;">TimerTask</a> <a href="/tags/ConcurrentMap/" style="font-size: 15px;">ConcurrentMap</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 15px;">ConcurrentHashMap</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a> <a href="/tags/ReentrantReadWriteLock/" style="font-size: 15px;">ReentrantReadWriteLock</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/SynchronousQueue/" style="font-size: 15px;">SynchronousQueue</a> <a href="/tags/ScheduledExecutorService/" style="font-size: 15px;">ScheduledExecutorService</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/BigData-docker/">Windows 上安装 docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-0.路线/">Mysql学习路线</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-索引/">Mysql安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/Qunar基础框架-QSchedule/">Qunar基础框架-QSchedule</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/java集合构架中使用到的数据结构和算法/">java集合构架中使用到的数据结构和算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/20/reids-调试环境搭建/">redis-调试环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/OpenStack-安装/">OpenStack-安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/26/JVM-hotspot-GC机制/">JVM-hotspot-GC机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/11/netty-socketio + socket.io 实现消息推送/">netty-socketio + socket.io 实现消息推送</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/26/mongodb-安装/">mongodb-安装</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/a-ray-of-sunshine" title="github" target="_blank">github</a><ul></ul><a href="http://www.cnblogs.com/a-ray-of-sunshine" title="cnblog" target="_blank">cnblog</a><ul></ul><a href="http://blog.csdn.net/a_ray_of_sunshine" title="csdn" target="_blank">csdn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Shawshank.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>