<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>network-URLConnection | Shawshank</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">network-URLConnection</h1><a id="logo" href="/.">Shawshank</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">network-URLConnection</h1><div class="post-meta">Dec 28, 2016</div><div class="post-content"><h2 id="1-URLConnection-对象的创建过程"><a href="#1-URLConnection-对象的创建过程" class="headerlink" title="1. URLConnection 对象的创建过程"></a>1. URLConnection 对象的创建过程</h2><p>摘自 rfc7230</p>
<blockquote>
<p>If the port subcomponent is empty or not given, TCP port 80 (the reserved port for WWW services) is the default.</p>
</blockquote>
<p>Http 协议默认 80 端口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// URLConnection 的使用。</span></span><br><span class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"http://www.cnblogs.com"</span>);</span><br><span class="line"><span class="comment">// 依据 URL String 中的 schema</span></span><br><span class="line"><span class="comment">// 选择适当的 URLConnection 的子类，进行实例化</span></span><br><span class="line"><span class="comment">// 下面的 connection 实例，自然是 HttpURLConnection 对象</span></span><br><span class="line">URLConnection connection = url.openConnection();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行下面的命令的时候，会进行 DNS 查询</span></span><br><span class="line"><span class="comment">// 将 www.cnblogs.com 这个域名对应的 IP 查询出来</span></span><br><span class="line"><span class="comment">// 这个ip和http协议默认的端口（80）,将共同组成</span></span><br><span class="line"><span class="comment">// server 端的 Socket。有了这个 Socket，</span></span><br><span class="line"><span class="comment">// 客户端就可以和服务端进行通信了。</span></span><br><span class="line"><span class="comment">// connect 方法的作用：</span></span><br><span class="line"><span class="comment">// 1. 查询 DNS 将 域名解析成 IP</span></span><br><span class="line"><span class="comment">// 2. 创建 &lt;serverIP, 80&gt; 的TCP 连接 </span></span><br><span class="line">connection.connect();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从创建连接到下面的获得数据，可能</span></span><br><span class="line"><span class="comment">// 出现过时的情况，例如 server 端默认 60 秒，后超时</span></span><br><span class="line"><span class="comment">// 则 server 端就会主动关闭 http 连接.</span></span><br><span class="line"><span class="comment">// 而当下面的请求，用来用来请求数据的时候，</span></span><br><span class="line"><span class="comment">// 上面创建的Socket已经连接超时了，则 HttpURLConnection</span></span><br><span class="line"><span class="comment">// 就会创建新的 socket 进行连接。获取数据。</span></span><br><span class="line">InputStream inputStream = connection.getInputStream();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于 http 协议，规定，连接的释放在</span></span><br><span class="line"><span class="comment">// 一次请求完就需要主动释放，所以</span></span><br><span class="line"><span class="comment">// 下面的 close 方法，调用时 tcp 连接可能已经被释放了。</span></span><br><span class="line">inputStream.close();</span><br></pre></td></tr></table></figure>
<p>可以使用 wireshark 工具来分析上面代码中出现的网络请求。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 过滤 http 协议中主机是 "cnblogs.com" 的流量</span></span><br><span class="line">http.host contains <span class="string">"cnblogs.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤 ip 42.121.252.58 的流量</span></span><br><span class="line">ip.addr == <span class="number">42.121</span><span class="number">.252</span><span class="number">.58</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤 域名为 www.cnblogs.com 的 DNS 查询请求</span></span><br><span class="line">dns.qry.name==www.cnblogs.com</span><br><span class="line"></span><br><span class="line">dns.qry.name==www.cnblogs.com or ip.addr == <span class="number">42.121</span><span class="number">.252</span><span class="number">.58</span></span><br></pre></td></tr></table></figure>
<h2 id="2-实现"><a href="#2-实现" class="headerlink" title="2. 实现"></a>2. 实现</h2><h3 id="openConnection"><a href="#openConnection" class="headerlink" title="openConnection"></a>openConnection</h3><p>URL 的 openConnection 方法，最终是创建了一个 <code>sun.net.www.protocol.http.HttpURLConnection</code> 类，这个类继承自 <code>java.net.HttpURLConnection</code></p>
<h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><p>HttpURLConnection 的 <code>connect</code> 方法则负责创建一个 <code>sun.net.www.http.HttpClient</code> 对象。</p>
<p>然后调用这个 HttpClient 对象的 openServer 方法。</p>
<p>openServer方法，将创建一个 <code>Socket</code> 对象。并调用 <code>Socket</code> 的 <code>connect</code> 方法和 URL 中指定的 &lt;server, port&gt; 建立 socket 连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HttpClient 创建过程中，最终调用 openServer 方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openServer</span><span class="params">(String server, <span class="keyword">int</span> port)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="comment">// doConnect 方法做两件事情</span></span><br><span class="line">	<span class="comment">// 1. 创建一个 &lt;server, port&gt; 的 socket</span></span><br><span class="line">	<span class="comment">// 2. 调用这个 socket 的 connect 方法，创建 tcp 连接。</span></span><br><span class="line">    serverSocket = doConnect(server, port);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        OutputStream out = serverSocket.getOutputStream();</span><br><span class="line">        <span class="keyword">if</span> (capture != <span class="keyword">null</span>) &#123;</span><br><span class="line">            out = <span class="keyword">new</span> HttpCaptureOutputStream(out, capture);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化 serverOutput 方法。</span></span><br><span class="line">        <span class="comment">/** Stream for printing to the server. */</span></span><br><span class="line">    	<span class="comment">//  public PrintStream  serverOutput;</span></span><br><span class="line">    	<span class="comment">// 向 serverSocket 传输数据就使用到它</span></span><br><span class="line">        serverOutput = <span class="keyword">new</span> PrintStream(</span><br><span class="line">            <span class="keyword">new</span> BufferedOutputStream(out),</span><br><span class="line">                                     <span class="keyword">false</span>, encoding);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(encoding+<span class="string">" encoding not found"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置 tcp 参数。</span></span><br><span class="line">    serverSocket.setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="getInputStream"><a href="#getInputStream" class="headerlink" title="getInputStream"></a>getInputStream</h3><p>下面的整个过程是阻塞的，就是使用 socket 的 InputStream 的 read 方法进行数据的读取。</p>
<h4 id="1-初始化-HTTP-请求头"><a href="#1-初始化-HTTP-请求头" class="headerlink" title="1. 初始化 HTTP 请求头"></a>1. 初始化 HTTP 请求头</h4><p>将请求参数封装到 MessageHeader 对象中。</p>
<h4 id="2-发送-HTTP-请求"><a href="#2-发送-HTTP-请求" class="headerlink" title="2. 发送 HTTP 请求"></a>2. 发送 HTTP 请求</h4><p>使用上面的 serverOutput 将 MessageHeader 输出</p>
<h4 id="3-等待-HTTP-响应"><a href="#3-等待-HTTP-响应" class="headerlink" title="3. 等待 HTTP 响应"></a>3. 等待 HTTP 响应</h4><p>将响应数据解析出来，封装到 <code>HttpInputStream</code> 对象中和 <code>MessageHeader</code> 对象中</p>
<p>MessageHeader 存储 Http 响应头信息</p>
<p>HttpInputStream 存储传输过来的数据</p>
<h4 id="4-返回-InputStream"><a href="#4-返回-InputStream" class="headerlink" title="4. 返回 InputStream"></a>4. 返回 InputStream</h4><p>返回上面解析好的 HttpInputStream</p>
<h3 id="Http-关闭连接"><a href="#Http-关闭连接" class="headerlink" title="Http 关闭连接"></a>Http 关闭连接</h3><h3 id="Http-的超时"><a href="#Http-的超时" class="headerlink" title="Http 的超时"></a>Http 的超时</h3><p>URLConnection 有下面两个方法。用来设置连接超时时间和，socket读取超时时间。</p>
<ul>
<li>setConnectTimeout</li>
<li>setReadTimeout</li>
</ul>
<p>这两个方法最终调用 HttpClient 类所持有的 Socket 方法的 setSoTimeout 来设置超时。</p>
<p>而 setSoTimeout 方法的实现，则是调用系统的 socket API <code>setsockopt</code> 来设置 <code>SO_RCVTIMEO</code> 和 <code>SO_SNDTIMEO</code> 进行超时设置。</p>
<blockquote>
<p>If the timeout is set to zero (the default) then the operation will never timeout.</p>
</blockquote>
<p>对于 URLConnection 的实现来说，其默认的超时值就是 0, 所以也就是不会超时。</p>
<p>Keep-Alive 保持连接。可以让一个请求连接，被复用多次。当创建一个 HTTP 请求的时候，其底层对应的是一个 TCP 连接。在 http 1.0 时，一个 http 响应完成之后其所对应的 tcp 连接就立即释放了。</p>
<p>但是，对于一个页面，可能出现大量的资源需要请求，例如图片，js, css 等等文件。所以创建的 tcp 可以被复用的。因为创建一个tcp连接也是非常的耗时和耗费资源的。所以使用 keep-alive 来保持一个连接。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="$. 参考"></a>$. 参考</h2><ol>
<li><a href="http://blog.csdn.net/zhaqiwen/article/details/18048791" target="_blank" rel="noopener">结合Wireshark捕获分组深入理解DNS协议</a></li>
<li><a href="http://369369.blog.51cto.com/319630/812889/" target="_blank" rel="noopener">DNS原理及其解析过程</a></li>
<li><a href="https://tools.ietf.org/html/rfc2616" target="_blank" rel="noopener">rfc2616-Hypertext Transfer Protocol</a></li>
<li><a href="https://tools.ietf.org/html/rfc3986" target="_blank" rel="noopener">Uniform Resource Identifier (URI): Generic Syntax</a></li>
<li><a href="https://tools.ietf.org/html/rfc2396" target="_blank" rel="noopener">Uniform Resource Identifiers (URI): Generic Syntax</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/system.uri" target="_blank" rel="noopener">Uri Class(c#)</a></li>
<li><a href="https://www.w3.org/Protocols/" target="_blank" rel="noopener">HTTP - Hypertext Transfer Protocol</a></li>
</ol>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2016/12/31/2016-年终总结/">2016-年终总结</a><a class="next" href="/2016/12/19/pinpoint-数据结构/">pinpoint-数据结构</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/interface/" style="font-size: 15px;">interface</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/Collections/" style="font-size: 15px;">Collections</a> <a href="/tags/Collection/" style="font-size: 15px;">Collection</a> <a href="/tags/J-U-C/" style="font-size: 15px;">J.U.C</a> <a href="/tags/lock/" style="font-size: 15px;">lock</a> <a href="/tags/Semaphore/" style="font-size: 15px;">Semaphore</a> <a href="/tags/CountDownLatch/" style="font-size: 15px;">CountDownLatch</a> <a href="/tags/CyclicBarrier/" style="font-size: 15px;">CyclicBarrier</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/LinkedList/" style="font-size: 15px;">LinkedList</a> <a href="/tags/Queue/" style="font-size: 15px;">Queue</a> <a href="/tags/Set/" style="font-size: 15px;">Set</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/collection/" style="font-size: 15px;">collection</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/mvc/" style="font-size: 15px;">mvc</a> <a href="/tags/context/" style="font-size: 15px;">context</a> <a href="/tags/component-scan/" style="font-size: 15px;">component-scan</a> <a href="/tags/storm/" style="font-size: 15px;">storm</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/命令行/" style="font-size: 15px;">命令行</a> <a href="/tags/cmder/" style="font-size: 15px;">cmder</a> <a href="/tags/win/" style="font-size: 15px;">win</a> <a href="/tags/效率/" style="font-size: 15px;">效率</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/extends/" style="font-size: 15px;">extends</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/svn/" style="font-size: 15px;">svn</a> <a href="/tags/BlockingQueue/" style="font-size: 15px;">BlockingQueue</a> <a href="/tags/LinkedBlockingQueue/" style="font-size: 15px;">LinkedBlockingQueue</a> <a href="/tags/PriorityBlockingQueue/" style="font-size: 15px;">PriorityBlockingQueue</a> <a href="/tags/ConcurrentLinkedQueue/" style="font-size: 15px;">ConcurrentLinkedQueue</a> <a href="/tags/CopyOnWriteArrayList/" style="font-size: 15px;">CopyOnWriteArrayList</a> <a href="/tags/接口/" style="font-size: 15px;">接口</a> <a href="/tags/抽象类/" style="font-size: 15px;">抽象类</a> <a href="/tags/Executor/" style="font-size: 15px;">Executor</a> <a href="/tags/ExecutorService/" style="font-size: 15px;">ExecutorService</a> <a href="/tags/CompletionService/" style="font-size: 15px;">CompletionService</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 15px;">ThreadPoolExecutor</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/vundle/" style="font-size: 15px;">vundle</a> <a href="/tags/ArrayList/" style="font-size: 15px;">ArrayList</a> <a href="/tags/log/" style="font-size: 15px;">log</a> <a href="/tags/index/" style="font-size: 15px;">index</a> <a href="/tags/concepts/" style="font-size: 15px;">concepts</a> <a href="/tags/Timer/" style="font-size: 15px;">Timer</a> <a href="/tags/TimerTask/" style="font-size: 15px;">TimerTask</a> <a href="/tags/ConcurrentMap/" style="font-size: 15px;">ConcurrentMap</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 15px;">ConcurrentHashMap</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a> <a href="/tags/ReentrantReadWriteLock/" style="font-size: 15px;">ReentrantReadWriteLock</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/SynchronousQueue/" style="font-size: 15px;">SynchronousQueue</a> <a href="/tags/ScheduledExecutorService/" style="font-size: 15px;">ScheduledExecutorService</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/BigData-docker/">Windows 上安装 docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-0.路线/">Mysql学习路线</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-索引/">Mysql安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/Qunar基础框架-QSchedule/">Qunar基础框架-QSchedule</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/java集合构架中使用到的数据结构和算法/">java集合构架中使用到的数据结构和算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/20/reids-调试环境搭建/">redis-调试环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/OpenStack-安装/">OpenStack-安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/26/JVM-hotspot-GC机制/">JVM-hotspot-GC机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/11/netty-socketio + socket.io 实现消息推送/">netty-socketio + socket.io 实现消息推送</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/26/mongodb-安装/">mongodb-安装</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/a-ray-of-sunshine" title="github" target="_blank">github</a><ul></ul><a href="http://www.cnblogs.com/a-ray-of-sunshine" title="cnblog" target="_blank">cnblog</a><ul></ul><a href="http://blog.csdn.net/a_ray_of_sunshine" title="csdn" target="_blank">csdn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Shawshank.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>