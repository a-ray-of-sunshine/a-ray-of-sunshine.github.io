<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>IO-FileInputStream | Shawshank</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">IO-FileInputStream</h1><a id="logo" href="/.">Shawshank</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">IO-FileInputStream</h1><div class="post-meta">Sep 8, 2016</div><div class="post-content"><h2 id="FileInputStream-的初始化"><a href="#FileInputStream-的初始化" class="headerlink" title="FileInputStream 的初始化"></a>FileInputStream 的初始化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileInputStream</span><span class="params">(File file)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">	<span class="comment">// FileInputStream 类并没有存储 file 引用，只是使用了</span></span><br><span class="line">	<span class="comment">// file.getPath() 来获得文件的存储路径。</span></span><br><span class="line">    String name = (file != <span class="keyword">null</span> ? file.getPath() : <span class="keyword">null</span>);</span><br><span class="line">    SecurityManager security = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">        security.checkRead(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (file.isInvalid()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"Invalid file path"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 FileDescriptor 对象，</span></span><br><span class="line">    fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">    fd.incrementAndGetUseCount();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.path = name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 打开文件</span></span><br><span class="line">    open(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(String name)</span> <span class="keyword">throws</span> FileNotFoundException</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileInputStream.c</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_io_FileInputStream_open(JNIEnv *env, jobject <span class="keyword">this</span>, jstring path) &#123;</span><br><span class="line">    fileOpen(env, <span class="keyword">this</span>, path, fis_fd, O_RDONLY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jdk/windows/native/java/io/io_utils_md.c</span></span><br><span class="line"><span class="comment">// io 在 windows 上的实现</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">fileOpen(JNIEnv *env, jobject <span class="keyword">this</span>, jstring path, jfieldID fid, <span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// winFileHandleOpen 将以读模式打开文件，并且其共享模式是</span></span><br><span class="line">	<span class="comment">// 可读可写，也就是其它线程也可以并发的对该文件进行读写</span></span><br><span class="line">	<span class="comment">// 如果文件不存在，则抛异常：FileNotFoundException</span></span><br><span class="line">    jlong h = winFileHandleOpen(env, path, flags);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (h &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    	<span class="comment">// h &gt;= 0 表示文件句柄有效</span></span><br><span class="line">    	<span class="comment">// 初始化 java.io.FileInputStream.fd 对象</span></span><br><span class="line">    	<span class="comment">// fd 的类型是 FileDescriptor</span></span><br><span class="line">    	<span class="comment">// 这里的参数： </span></span><br><span class="line">    	<span class="comment">// 		this 表示当前 FileInputStream 对象对应的 oop</span></span><br><span class="line">    	<span class="comment">// 		h 是 打开的文件的 句柄</span></span><br><span class="line">    	<span class="comment">//		fid 是 全局变量:fis_fd 在 FileInputStream 加载的时候，</span></span><br><span class="line">    	<span class="comment">//			初始化，表示 FileInputStream 的 字段 fd 的 fieldId </span></span><br><span class="line">        SET_FD(<span class="keyword">this</span>, h, fid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">jlong</span><br><span class="line">winFileHandleOpen(JNIEnv *env, jstring path, <span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// flags == O_RDONLY</span></span><br><span class="line">	<span class="comment">// access = GENERIC_READ</span></span><br><span class="line">	<span class="comment">// 当前进程，对文件的访问模式：</span></span><br><span class="line">	<span class="comment">// 读模式，规定了当前线程可以对该文件进行的操作</span></span><br><span class="line">    <span class="keyword">const</span> DWORD access = </span><br><span class="line">        (flags &amp; O_WRONLY) ?  GENERIC_WRITE :</span><br><span class="line">        (flags &amp; O_RDWR)   ? (GENERIC_READ | GENERIC_WRITE) :</span><br><span class="line">        GENERIC_READ;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// FILE_SHARE_READ 文件读共享</span></span><br><span class="line">    <span class="comment">// FILE_SHARE_WRITE 文件写共享</span></span><br><span class="line">    <span class="comment">// 表示其它进程，可以打开这个文件，并进行读写操作。</span></span><br><span class="line">    <span class="comment">// 规定当前线程对该文件的占用模式</span></span><br><span class="line">    <span class="keyword">const</span> DWORD sharing =</span><br><span class="line">        FILE_SHARE_READ | FILE_SHARE_WRITE;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// disposition = OPEN_EXISTING</span></span><br><span class="line">    <span class="comment">// 表示 如果文件不存在时，如何处理</span></span><br><span class="line">	<span class="comment">// OPEN_EXISTING 表示：如果文件不存在</span></span><br><span class="line">	<span class="comment">// CreateFile 将返回 INVALID_HANDLE_VALUE，</span></span><br><span class="line">	<span class="comment">// 并用 last-error code == ERROR_FILE_NOT_FOUND</span></span><br><span class="line">    <span class="keyword">const</span> DWORD disposition =</span><br><span class="line">        <span class="comment">/* Note: O_TRUNC overrides O_CREAT */</span></span><br><span class="line">        (flags &amp; O_TRUNC) ? CREATE_ALWAYS :</span><br><span class="line">        (flags &amp; O_CREAT) ? OPEN_ALWAYS   :</span><br><span class="line">        OPEN_EXISTING;</span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> DWORD  maybeWriteThrough =</span><br><span class="line">        (flags &amp; (O_SYNC | O_DSYNC)) ?</span><br><span class="line">        FILE_FLAG_WRITE_THROUGH :</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL;</span><br><span class="line">    <span class="keyword">const</span> DWORD maybeDeleteOnClose =</span><br><span class="line">        (flags &amp; O_TEMPORARY) ?</span><br><span class="line">        FILE_FLAG_DELETE_ON_CLOSE :</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL;</span><br><span class="line">    <span class="comment">// 用来确定文件具有的属性</span></span><br><span class="line">    <span class="comment">// 一般情况下是：FILE_ATTRIBUTE_NORMAL</span></span><br><span class="line">    <span class="comment">// 表示：The file does not have other attributes set.</span></span><br><span class="line">    <span class="keyword">const</span> DWORD flagsAndAttributes = maybeWriteThrough | maybeDeleteOnClose;</span><br><span class="line">    </span><br><span class="line">    HANDLE h = <span class="literal">NULL</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// path 是文件所在的路径</span></span><br><span class="line">    <span class="keyword">if</span> (onNT) &#123;</span><br><span class="line">        WCHAR *pathbuf = pathToNTPath(env, path, JNI_TRUE);</span><br><span class="line">        <span class="keyword">if</span> (pathbuf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">/* Exception already pending */</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// win32api CreateFileW 用来创建文件</span></span><br><span class="line">        <span class="comment">// 返回文件的句柄</span></span><br><span class="line">        h = CreateFileW(</span><br><span class="line">            pathbuf,            <span class="comment">/* Wide char path name */</span></span><br><span class="line">            access,             <span class="comment">/* Read and/or write permission */</span></span><br><span class="line">            sharing,            <span class="comment">/* File sharing flags */</span></span><br><span class="line">            <span class="literal">NULL</span>,               <span class="comment">/* Security attributes */</span></span><br><span class="line">            disposition,        <span class="comment">/* creation disposition */</span></span><br><span class="line">            flagsAndAttributes, <span class="comment">/* flags and attributes */</span></span><br><span class="line">            <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">free</span>(pathbuf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        WITH_PLATFORM_STRING(env, path, _ps) &#123;</span><br><span class="line">            h = CreateFile(_ps, access, sharing, <span class="literal">NULL</span>, disposition,</span><br><span class="line">                           flagsAndAttributes, <span class="literal">NULL</span>);</span><br><span class="line">        &#125; END_PLATFORM_STRING(env, _ps);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果打开文件失败，抛异常，返回 -1</span></span><br><span class="line">    <span class="keyword">if</span> (h == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="keyword">int</span> error = GetLastError();</span><br><span class="line">        <span class="keyword">if</span> (error == ERROR_TOO_MANY_OPEN_FILES) &#123;</span><br><span class="line">            JNU_ThrowByName(env, JNU_JAVAIOPKG <span class="string">"IOException"</span>,</span><br><span class="line">                            <span class="string">"Too many open files"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        throwFileNotFoundException(env, path);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回文件的句柄</span></span><br><span class="line">    <span class="keyword">return</span> (jlong) h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化-java-io-FileInputStream-fd-对象"><a href="#初始化-java-io-FileInputStream-fd-对象" class="headerlink" title="初始化 java.io.FileInputStream.fd 对象"></a>初始化 java.io.FileInputStream.fd 对象</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// windows/native/java/io/io_util_md.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Macros to use the right data type for file descriptors</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FD jlong</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Macros to set/get fd from the java.io.FileDescriptor.</span></span><br><span class="line"><span class="comment"> * If GetObjectField returns null, SET_FD will stop and GET_FD</span></span><br><span class="line"><span class="comment"> * will simply return -1 to avoid crashing VM.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SET_FD(this, fd, fid) \</span></span><br><span class="line">    <span class="keyword">if</span> ((*env)-&gt;GetObjectField(env, (<span class="keyword">this</span>), (fid)) != <span class="literal">NULL</span>) \</span><br><span class="line">        (*env)-&gt;SetLongField(env, (*env)-&gt;GetObjectField(env, (<span class="keyword">this</span>), (fid)), IO_handle_fdID, (fd))</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET_FD(this, fid) \</span></span><br><span class="line">    ((*env)-&gt;GetObjectField(env, (<span class="keyword">this</span>), (fid)) == <span class="literal">NULL</span>) ? \</span><br><span class="line">      <span class="number">-1</span> : (*env)-&gt;GetLongField(env, (*env)-&gt;GetObjectField(env, (<span class="keyword">this</span>), (fid)), IO_handle_fdID)</span><br><span class="line">      </span><br><span class="line"><span class="comment">// SET_FD 在 fileOpen 中被调用，由于其是宏，所以在编译阶段将被展开，所以</span></span><br><span class="line"><span class="comment">// fileOpen 就变成：</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fileOpen</span><span class="params">(JNIEnv *env, jobject <span class="keyword">this</span>, jstring path, jfieldID fid, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    jlong h = winFileHandleOpen(env, path, flags);</span><br><span class="line">    <span class="keyword">if</span> (h &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    	<span class="comment">// GetObjectField 和 SetLongField 都是 JNI 函数，</span></span><br><span class="line">    	<span class="comment">// 用来操作 Java对象 FileInputStream，对应的底层的 oop 对象 this</span></span><br><span class="line">    	<span class="comment">// GetObjectField 应该是获得 this 对象的 fd 字段</span></span><br><span class="line">    	<span class="comment">// SetLongField 设置 fd(FileDescriptor) 所以对应的对象的</span></span><br><span class="line">    	<span class="comment">// 字段：</span></span><br><span class="line">    	<span class="comment">// 		private int fd;</span></span><br><span class="line">    	<span class="comment">//		private long handle;</span></span><br><span class="line">    	<span class="comment">// fid 表示 this 对象的 fd 字段的id,</span></span><br><span class="line">    	<span class="comment">// IO_handle_fdID 表示 </span></span><br><span class="line">    	<span class="comment">//		java.io.FileDescriptor.handle 的 fieldId</span></span><br><span class="line">    	<span class="comment">// 所以 GetObjectField 返回 this 对象的 fd 对象。</span></span><br><span class="line">    	<span class="comment">// 所以下面的 SetLongField 调用将 创建的文件 句柄 h 设置到</span></span><br><span class="line">    	<span class="comment">// FileDescriptor 对象的 handle 字段中。</span></span><br><span class="line">    	<span class="comment">// 在 win32 的实现中将 创建好的 文件句柄 设置到 handle 字段</span></span><br><span class="line">		<span class="comment">// 在 linux 版本中则使用的是 FileDescriptor 的 fd 字段</span></span><br><span class="line">		<span class="comment">// 由此，可知 handle 和 fd 是共存的但并不同时在使用，</span></span><br><span class="line">		<span class="comment">// 在 win32 平台上使用 handle 字段</span></span><br><span class="line">		<span class="comment">// 在 linux 平台上使用 fd 字段</span></span><br><span class="line">        <span class="keyword">if</span> ((*env)-&gt;GetObjectField(env, (<span class="keyword">this</span>), (fid)) != <span class="literal">NULL</span>)</span><br><span class="line">        (*env)-&gt;SetLongField(env, (*env)-&gt;GetObjectField(env, (<span class="keyword">this</span>), (fid)), IO_handle_fdID, (h))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FileInputStream 类加载的会执行下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.io.FileInputStream</span></span><br><span class="line"><span class="comment">/* File Descriptor - handle to the open file */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FileDescriptor fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">initIDs</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    initIDs();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initIDs的实现：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// share/native/java/io/FileInputStream.c</span></span><br><span class="line"></span><br><span class="line">jfieldID fis_fd; <span class="comment">/* id for jobject 'fd' in java.io.FileInputStream */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************************************</span></span><br><span class="line"><span class="comment"> * static methods to store field ID's in initializers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_io_FileInputStream_initIDs(JNIEnv *env, jclass fdClass) &#123;</span><br><span class="line">    fis_fd = (*env)-&gt;GetFieldID(env, fdClass, <span class="string">"fd"</span>, <span class="string">"Ljava/io/FileDescriptor;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initIDs 在 FileInputStream 被加载的时候，将其字段 fd 的 FieldID进行初始化，存储到全局变量 fis_fd 中。</p>
<p>同样的得到，fd 对象之后要操作，其字段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.io.FileDescriptor</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> handle;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This routine initializes JNI field offsets for the class */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">initIDs</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    initIDs();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对应的 native 实现:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* field id for jint 'fd' in java.io.FileDescriptor */</span></span><br><span class="line">jfieldID IO_fd_fdID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* field id for jlong 'handle' in java.io.FileDescriptor */</span></span><br><span class="line">jfieldID IO_handle_fdID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************************************</span></span><br><span class="line"><span class="comment"> * static methods to store field IDs in initializers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_io_FileDescriptor_initIDs(JNIEnv *env, jclass fdClass) &#123;</span><br><span class="line">    IO_fd_fdID = (*env)-&gt;GetFieldID(env, fdClass, <span class="string">"fd"</span>, <span class="string">"I"</span>);</span><br><span class="line">    IO_handle_fdID = (*env)-&gt;GetFieldID(env, fdClass, <span class="string">"handle"</span>, <span class="string">"J"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="打开文件的流程总结"><a href="#打开文件的流程总结" class="headerlink" title="打开文件的流程总结"></a>打开文件的流程总结</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"1.txt"</span>);</span><br></pre></td></tr></table></figure>
<p>这个调用的过程如下：</p>
<ol>
<li><p>创建 FileDescriptor 对象</p>
<p> 每一个 FileInputStream 有一个 FileDescriptor，代表这个流底层的文件的handle</p>
</li>
<li><p>调用 native 方法 open, 打开文件</p>
<p> 内部调用 CreateFile 打开文件，返回文件句柄 handle</p>
</li>
<li><p>初始化 FileDescriptor 对象</p>
<p> 将 文件句柄 handle 设置到，FileDescriptor 对象的 handle 中</p>
</li>
</ol>
<h2 id="read-的实现"><a href="#read-的实现" class="headerlink" title="read 的实现"></a>read 的实现</h2><p>其实现在 FileInputStream.c 和</p>
<p>src/windows/native/java/io/Io_util_md.h 中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_java_io_FileInputStream_read(JNIEnv *env, jobject <span class="keyword">this</span>) &#123;</span><br><span class="line">	<span class="comment">// fis_fd ： java.io.FileInputStream.fd 的 fieldId</span></span><br><span class="line">    <span class="keyword">return</span> readSingle(env, <span class="keyword">this</span>, fis_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jint</span><br><span class="line">readSingle(JNIEnv *env, jobject <span class="keyword">this</span>, jfieldID fid) &#123;</span><br><span class="line">    jint nread;</span><br><span class="line">    <span class="keyword">char</span> ret;</span><br><span class="line">    <span class="comment">// 获得 fd</span></span><br><span class="line">    FD fd = GET_FD(<span class="keyword">this</span>, fid);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, <span class="string">"Stream Closed"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// fd 文件句柄，</span></span><br><span class="line">    <span class="comment">// ret 读取到数据</span></span><br><span class="line">    <span class="comment">// 读取数据的数量</span></span><br><span class="line">    nread = (jint)IO_Read(fd, &amp;ret, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">0</span>) &#123; <span class="comment">/* EOF */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nread == JVM_IO_ERR) &#123; <span class="comment">/* error */</span></span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Read error"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nread == JVM_IO_INTR) &#123;</span><br><span class="line">        JNU_ThrowByName(env, <span class="string">"java/io/InterruptedIOException"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret &amp; <span class="number">0xFF</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Route the routines away from VM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Append handleAppend</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Write handleWrite</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Sync handleSync</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Read handleRead</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Lseek handleLseek</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Available handleAvailable</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_SetLength handleSetLength</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/windows/native/java/io/Io_util_md.c</span></span><br><span class="line"><span class="comment">// IO_Read(fd, &amp;ret, 1);</span></span><br><span class="line">JNIEXPORT</span><br><span class="line"><span class="keyword">size_t</span></span><br><span class="line">handleRead(jlong fd, <span class="keyword">void</span> *buf, jint len)</span><br><span class="line">&#123;</span><br><span class="line">    DWORD read = <span class="number">0</span>;</span><br><span class="line">    BOOL result = <span class="number">0</span>;</span><br><span class="line">    HANDLE h = (HANDLE)fd;</span><br><span class="line">    <span class="keyword">if</span> (h == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// h 文件句柄，len = 1</span></span><br><span class="line">    result = ReadFile(h,          <span class="comment">/* File handle to read */</span></span><br><span class="line">                      buf,        <span class="comment">/* address to put data */</span></span><br><span class="line">                      len,        <span class="comment">/* number of bytes to read */</span></span><br><span class="line">                      &amp;read,      <span class="comment">/* number of bytes read */</span></span><br><span class="line">                      <span class="literal">NULL</span>);      <span class="comment">/* no overlapped struct */</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> error = GetLastError();</span><br><span class="line">        <span class="keyword">if</span> (error == ERROR_BROKEN_PIPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* EOF */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> read;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ReadFile win32 api 用来读取文件。</p>
<h3 id="文件的读取模型"><a href="#文件的读取模型" class="headerlink" title="文件的读取模型"></a>文件的读取模型</h3><p>在windows 和 linux 中都提供了读取文件的操作</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// win32 API</span></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">ReadFile</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_        HANDLE       hFile,</span></span></span><br><span class="line"><span class="function"><span class="params">  _Out_       LPVOID       lpBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_        DWORD        nNumberOfBytesToRead,</span></span></span><br><span class="line"><span class="function"><span class="params">  _Out_opt_   LPDWORD      lpNumberOfBytesRead,</span></span></span><br><span class="line"><span class="function"><span class="params">  _Inout_opt_ LPOVERLAPPED lpOverlapped</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">SetFilePointer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_        HANDLE hFile,</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_        LONG   lDistanceToMove,</span></span></span><br><span class="line"><span class="function"><span class="params">  _Inout_opt_ PLONG  lpDistanceToMoveHigh,</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_        DWORD  dwMoveMethod</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// linux API</span></span><br><span class="line"><span class="keyword">ssize_t</span> read(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count);</span><br><span class="line"><span class="keyword">off_t</span> lseek(<span class="keyword">int</span> fildes, <span class="keyword">off_t</span> offset, <span class="keyword">int</span> whence);</span><br></pre></td></tr></table></figure>
<p>对于这两个API，都没有提供读取的位置，那么当第一次调用的时候，应该从文件的什么位置去读取数据呢？</p>
<ul>
<li>linux</li>
</ul>
<blockquote>
<p>open &amp; read &amp; lseek:</p>
<p>The file offset is set to the beginning of the file</p>
<p>On success, the number of bytes read is returned (zero indicates end of file), and the file position is advanced by this number.</p>
</blockquote>
<ul>
<li>win32</li>
</ul>
<blockquote>
<p>ReadFile &amp; SetFilePointer</p>
<p>If hFile is opened with FILE_FLAG_OVERLAPPED, it is an asynchronous file handle; otherwise it is synchronous.</p>
<p>File pointer position for a synchronous handle is maintained by the system as data is read or written and can also be updated using the SetFilePointer or SetFilePointerEx function.</p>
<p>Reads data from the specified file or input/output (I/O) device. Reads occur at the position specified by the file pointer if supported by the device.</p>
<p>If lpOverlapped is NULL, the read operation starts at the current file position and ReadFile does not return until the operation is complete, and the system updates the file pointer before ReadFile returns.</p>
<p>When an application calls CreateFile to open a file for the first time, Windows places the file pointer at the beginning of the file. As bytes are read from or written to the file, Windows advances the file pointer the number of bytes read or written.</p>
</blockquote>
<p><a href="https://msdn.microsoft.com/zh-cn/library/windows/desktop/aa364397(v=vs.85" target="_blank" rel="noopener">File Pointers</a>.aspx)</p>
<p><a href="https://msdn.microsoft.com/zh-cn/library/windows/desktop/aa365457(v=vs.85" target="_blank" rel="noopener">Positioning a File Pointer</a>.aspx)</p>
<p>msdn: System Services &gt; File Services &gt; File Systems &gt; File System Components &gt; Files and Clusters</p>
<p>可以看到当使用 CreateFile 和 open 打开一个文件的时候，系统会将文件的 offset 放置到文件的开头。offset = 0, 后续的 ReadFile 和 read 的时候，offset 会被移动到下一次读取的文件的位置。所以，读取的位置 offset 是由系统来维护的。</p>
<p>但是，可以使用 SetFilePointer 和 lseek 来设置文件的 offset. 然后，下次的读取将使用新的 offset 来，读取数据。</p>
<h2 id="FileInputStream-关闭"><a href="#FileInputStream-关闭" class="headerlink" title="FileInputStream 关闭"></a>FileInputStream 关闭</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jdk\src\windows\native\java\io\FileInputStream_md.c</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_io_FileInputStream_close0(JNIEnv *env, jobject <span class="keyword">this</span>) &#123;</span><br><span class="line">    handleClose(env, <span class="keyword">this</span>, fis_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// jdk\src\windows\native\java\io\io_util_md.c</span></span><br><span class="line"><span class="function">jint <span class="title">handleClose</span><span class="params">(JNIEnv *env, jobject <span class="keyword">this</span>, jfieldID fid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 获得 FileInputStream.fd.handle 对象</span></span><br><span class="line">    <span class="comment">// 其存储，当前文件的句柄</span></span><br><span class="line">    FD fd = GET_FD(<span class="keyword">this</span>, fid);</span><br><span class="line">    HANDLE h = (HANDLE)fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (h == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the fd to -1 before closing it so that the timing window</span></span><br><span class="line"><span class="comment">     * of other threads using the wrong fd (closed but recycled fd,</span></span><br><span class="line"><span class="comment">     * that gets re-opened with some other filename) is reduced.</span></span><br><span class="line"><span class="comment">     * Practically the chance of its occurance is low, however, we are</span></span><br><span class="line"><span class="comment">     * taking extra precaution over here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="comment">// 将 FileInputStream.fd.handle 设置成 -1,</span></span><br><span class="line">	<span class="comment">// 表示 fd 已经无效，如果后续调用 在当前文件流上 继续调用 read 方法</span></span><br><span class="line">	<span class="comment">// 将导致 IOException "Stream Closed"</span></span><br><span class="line">    SET_FD(<span class="keyword">this</span>, <span class="number">-1</span>, fid);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用 win32 API CloseHandle 来关闭文件</span></span><br><span class="line">	<span class="comment">// CloseHandle invalidates the specified object handle, decrements the object's handle count, </span></span><br><span class="line">	<span class="comment">// and performs object retention checks. After the last handle to an object is closed, </span></span><br><span class="line">	<span class="comment">// the object is removed from the system.</span></span><br><span class="line">	<span class="comment">// CloseHandle 最终将释放 打开文件时所创建的内核对象。</span></span><br><span class="line">    <span class="keyword">if</span> (CloseHandle(h) == <span class="number">0</span>) &#123; <span class="comment">/* Returns zero on failure */</span></span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"close failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="skip-amp-available"><a href="#skip-amp-available" class="headerlink" title="skip &amp; available"></a>skip &amp; available</h2><h3 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jlong JNICALL</span><br><span class="line">Java_java_io_FileInputStream_skip(JNIEnv *env, jobject <span class="keyword">this</span>, jlong toSkip) &#123;</span><br><span class="line">    jlong cur = jlong_zero;</span><br><span class="line">    jlong end = jlong_zero;</span><br><span class="line">    FD fd = GET_FD(<span class="keyword">this</span>, fis_fd);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException (env, <span class="string">"Stream Closed"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((cur = IO_Lseek(fd, (jlong)<span class="number">0</span>, (jint)SEEK_CUR)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Seek error"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((end = IO_Lseek(fd, toSkip, (jint)SEEK_CUR)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Seek error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (end - cur);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Lseek handleLseek</span></span><br><span class="line"></span><br><span class="line">jlong</span><br><span class="line">handleLseek(jlong fd, jlong offset, jint whence)</span><br><span class="line">&#123;</span><br><span class="line">    LARGE_INTEGER pos, distance;</span><br><span class="line">    DWORD lowPos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> highPos = <span class="number">0</span>;</span><br><span class="line">    DWORD op = FILE_CURRENT;</span><br><span class="line">    HANDLE h = (HANDLE)fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (whence == SEEK_END) &#123;</span><br><span class="line">        op = FILE_END;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (whence == SEEK_CUR) &#123;</span><br><span class="line">        op = FILE_CURRENT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (whence == SEEK_SET) &#123;</span><br><span class="line">        op = FILE_BEGIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    distance.QuadPart = offset;</span><br><span class="line">    <span class="keyword">if</span> (SetFilePointerEx(h, distance, &amp;pos, op) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> long_to_jlong(pos.QuadPart);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetFilePointerEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE hFile,</span></span></span><br><span class="line"><span class="function"><span class="params">  LARGE_INTEGER liDistanceToMove,</span></span></span><br><span class="line"><span class="function"><span class="params">  PLARGE_INTEGER lpNewFilePointer,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwMoveMethod</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<p>SetFilePointerEx win32 API:</p>
<p>The SetFilePointerEx function moves the file pointer of the specified file.</p>
<h3 id="available"><a href="#available" class="headerlink" title="available"></a>available</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_java_io_FileInputStream_available(JNIEnv *env, jobject <span class="keyword">this</span>) &#123;</span><br><span class="line">    jlong ret;</span><br><span class="line">    FD fd = GET_FD(<span class="keyword">this</span>, fis_fd);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException (env, <span class="string">"Stream Closed"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (IO_Available(fd, &amp;ret)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ret &gt; INT_MAX) &#123;</span><br><span class="line">            ret = (jlong) INT_MAX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jlong_to_jint(ret);</span><br><span class="line">    &#125;</span><br><span class="line">    JNU_ThrowIOExceptionWithLastError(env, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Available handleAvailable</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">handleAvailable(jlong fd, jlong *pbytes) &#123;</span><br><span class="line">    HANDLE h = (HANDLE)fd;</span><br><span class="line">    DWORD type = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    type = GetFileType(h);</span><br><span class="line">    <span class="comment">/* Handle is for keyboard or pipe */</span></span><br><span class="line">    <span class="keyword">if</span> (type == FILE_TYPE_CHAR || type == FILE_TYPE_PIPE) &#123;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="keyword">long</span> lpbytes;</span><br><span class="line">        HANDLE stdInHandle = GetStdHandle(STD_INPUT_HANDLE);</span><br><span class="line">        <span class="keyword">if</span> (stdInHandle == h) &#123;</span><br><span class="line">            ret = handleStdinAvailable(fd, &amp;lpbytes); <span class="comment">/* keyboard */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ret = handleNonSeekAvailable(fd, &amp;lpbytes); <span class="comment">/* pipe */</span></span><br><span class="line">        &#125;</span><br><span class="line">        (*pbytes) = (jlong)(lpbytes);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Handle is for regular file */</span></span><br><span class="line">    <span class="keyword">if</span> (type == FILE_TYPE_DISK) &#123;</span><br><span class="line">        jlong current, end;</span><br><span class="line"></span><br><span class="line">        LARGE_INTEGER filesize;</span><br><span class="line">        current = handleLseek(fd, <span class="number">0</span>, SEEK_CUR);</span><br><span class="line">        <span class="keyword">if</span> (current &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (GetFileSizeEx(h, &amp;filesize) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        end = long_to_jlong(filesize.QuadPart);</span><br><span class="line">        *pbytes = end - current;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>GetFileType</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">GetFileType</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE hFile</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<p>  The GetFileType function retrieves the file type of the specified file.</p>
<p>  FILE_TYPE_DISK: The specified file is a disk file.</p>
</li>
<li><p>GetFileSizeEx</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">GetFileSizeEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE hFile,</span></span></span><br><span class="line"><span class="function"><span class="params">  PLARGE_INTEGER lpFileSize</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<p>  The GetFileSizeEx function retrieves the size of the specified file.</p>
</li>
</ul>
<h2 id="FileOutputStream"><a href="#FileOutputStream" class="headerlink" title="FileOutputStream"></a>FileOutputStream</h2><ul>
<li>write</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/share/native/java/io/io_util.c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">writeSingle(JNIEnv *env, jobject <span class="keyword">this</span>, jint byte, jboolean append, jfieldID fid) &#123;</span><br><span class="line">    <span class="comment">// Discard the 24 high-order bits of byte. See OutputStream#write(int)</span></span><br><span class="line">    <span class="keyword">char</span> c = (<span class="keyword">char</span>) byte;</span><br><span class="line">    jint n;</span><br><span class="line">    FD fd = GET_FD(<span class="keyword">this</span>, fid);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, <span class="string">"Stream Closed"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (append == JNI_TRUE) &#123;</span><br><span class="line">        n = (jint)IO_Append(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        n = (jint)IO_Write(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n == JVM_IO_ERR) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Write error"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n == JVM_IO_INTR) &#123;</span><br><span class="line">        JNU_ThrowByName(env, <span class="string">"java/io/InterruptedIOException"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/windows/native/java/io/io_util_md.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Append handleAppend</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Write handleWrite</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/windows/native/java/io/io_util_md.c</span></span><br><span class="line">JNIEXPORT</span><br><span class="line"><span class="keyword">size_t</span> handleWrite(jlong fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, jint len) &#123;</span><br><span class="line">    <span class="keyword">return</span> writeInternal(fd, buf, len, JNI_FALSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT</span><br><span class="line"><span class="keyword">size_t</span> handleAppend(jlong fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, jint len) &#123;</span><br><span class="line">    <span class="keyword">return</span> writeInternal(fd, buf, len, JNI_TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> size_t <span class="title">writeInternal</span><span class="params">(jlong fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, jint len, jboolean append)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BOOL result = <span class="number">0</span>;</span><br><span class="line">    DWORD written = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 获得文件句柄</span></span><br><span class="line">    HANDLE h = (HANDLE)fd;</span><br><span class="line">    <span class="keyword">if</span> (h != INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        OVERLAPPED ov;</span><br><span class="line">        LPOVERLAPPED lpOv;</span><br><span class="line">        <span class="keyword">if</span> (append == JNI_TRUE) &#123;</span><br><span class="line">            ov.Offset = (DWORD)<span class="number">0xFFFFFFFF</span>;</span><br><span class="line">            ov.OffsetHigh = (DWORD)<span class="number">0xFFFFFFFF</span>;</span><br><span class="line">            ov.hEvent = <span class="literal">NULL</span>;</span><br><span class="line">            lpOv = &amp;ov;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lpOv = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        result = WriteFile(h,                <span class="comment">/* File handle to write */</span></span><br><span class="line">                           buf,              <span class="comment">/* pointers to the buffers */</span></span><br><span class="line">                           len,              <span class="comment">/* number of bytes to write */</span></span><br><span class="line">                           &amp;written,         <span class="comment">/* receives number of bytes written */</span></span><br><span class="line">                           lpOv);            <span class="comment">/* overlapped struct */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((h == INVALID_HANDLE_VALUE) || (result == <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">size_t</span>)written;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 win32 平台下调用 WriteFile 来写入文件。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">WriteFile</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE hFile,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCVOID lpBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD nNumberOfBytesToWrite,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpNumberOfBytesWritten,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPOVERLAPPED lpOverlapped</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>If hFile was not opened with FILE_FLAG_OVERLAPPED and lpOverlapped is NULL, the write operation starts at the current file position and WriteFile does not return until the operation has been completed. The system updates the file pointer upon completion.</p>
<p>If hFile was not opened with FILE_FLAG_OVERLAPPED and lpOverlapped is not NULL, the write operation starts at the offset specified in the OVERLAPPED structure and WriteFile does not return until the write operation has been completed. The system updates the file pointer upon completion.</p>
</blockquote>
<p>文件在 open 的时候，并没有使用 FILE_FLAG_OVERLAPPED 标志，所以在调用 WriteFile 的时候，遵循上面的行为。同时，由上面的描述可知，这种写入是 block 的，直到操作完成，才返回。同时，系统也会维护文件指针，使其指向下次写入的位置。</p>
<p>FileOutputStream 的构造函数，提供一个 append 参数，用来表示，文件的写入是从头开始（相当于覆盖），还是从文件的最后 apped 数据。这个参数，默认是 false, 也就是文件默认是覆盖写入的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FileOutputStream(String name, <span class="keyword">boolean</span> append)</span><br></pre></td></tr></table></figure></div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2016/09/09/IO-File/">IO-File</a><a class="next" href="/2016/08/31/JVM-java对象模型的实现/">JVM-java对象模型的实现</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/interface/" style="font-size: 15px;">interface</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/Collections/" style="font-size: 15px;">Collections</a> <a href="/tags/Collection/" style="font-size: 15px;">Collection</a> <a href="/tags/J-U-C/" style="font-size: 15px;">J.U.C</a> <a href="/tags/lock/" style="font-size: 15px;">lock</a> <a href="/tags/Semaphore/" style="font-size: 15px;">Semaphore</a> <a href="/tags/CountDownLatch/" style="font-size: 15px;">CountDownLatch</a> <a href="/tags/CyclicBarrier/" style="font-size: 15px;">CyclicBarrier</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/LinkedList/" style="font-size: 15px;">LinkedList</a> <a href="/tags/Queue/" style="font-size: 15px;">Queue</a> <a href="/tags/Set/" style="font-size: 15px;">Set</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/collection/" style="font-size: 15px;">collection</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/mvc/" style="font-size: 15px;">mvc</a> <a href="/tags/context/" style="font-size: 15px;">context</a> <a href="/tags/component-scan/" style="font-size: 15px;">component-scan</a> <a href="/tags/storm/" style="font-size: 15px;">storm</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/命令行/" style="font-size: 15px;">命令行</a> <a href="/tags/cmder/" style="font-size: 15px;">cmder</a> <a href="/tags/win/" style="font-size: 15px;">win</a> <a href="/tags/效率/" style="font-size: 15px;">效率</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/extends/" style="font-size: 15px;">extends</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/svn/" style="font-size: 15px;">svn</a> <a href="/tags/BlockingQueue/" style="font-size: 15px;">BlockingQueue</a> <a href="/tags/LinkedBlockingQueue/" style="font-size: 15px;">LinkedBlockingQueue</a> <a href="/tags/PriorityBlockingQueue/" style="font-size: 15px;">PriorityBlockingQueue</a> <a href="/tags/ConcurrentLinkedQueue/" style="font-size: 15px;">ConcurrentLinkedQueue</a> <a href="/tags/CopyOnWriteArrayList/" style="font-size: 15px;">CopyOnWriteArrayList</a> <a href="/tags/接口/" style="font-size: 15px;">接口</a> <a href="/tags/抽象类/" style="font-size: 15px;">抽象类</a> <a href="/tags/Executor/" style="font-size: 15px;">Executor</a> <a href="/tags/ExecutorService/" style="font-size: 15px;">ExecutorService</a> <a href="/tags/CompletionService/" style="font-size: 15px;">CompletionService</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 15px;">ThreadPoolExecutor</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/vundle/" style="font-size: 15px;">vundle</a> <a href="/tags/ArrayList/" style="font-size: 15px;">ArrayList</a> <a href="/tags/log/" style="font-size: 15px;">log</a> <a href="/tags/index/" style="font-size: 15px;">index</a> <a href="/tags/concepts/" style="font-size: 15px;">concepts</a> <a href="/tags/Timer/" style="font-size: 15px;">Timer</a> <a href="/tags/TimerTask/" style="font-size: 15px;">TimerTask</a> <a href="/tags/ConcurrentMap/" style="font-size: 15px;">ConcurrentMap</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 15px;">ConcurrentHashMap</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a> <a href="/tags/ReentrantReadWriteLock/" style="font-size: 15px;">ReentrantReadWriteLock</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/SynchronousQueue/" style="font-size: 15px;">SynchronousQueue</a> <a href="/tags/ScheduledExecutorService/" style="font-size: 15px;">ScheduledExecutorService</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/BigData-docker/">Windows 上安装 docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-0.路线/">Mysql学习路线</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-索引/">Mysql安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/Qunar基础框架-QSchedule/">Qunar基础框架-QSchedule</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/java集合构架中使用到的数据结构和算法/">java集合构架中使用到的数据结构和算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/20/reids-调试环境搭建/">redis-调试环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/OpenStack-安装/">OpenStack-安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/26/JVM-hotspot-GC机制/">JVM-hotspot-GC机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/11/netty-socketio + socket.io 实现消息推送/">netty-socketio + socket.io 实现消息推送</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/26/mongodb-安装/">mongodb-安装</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/a-ray-of-sunshine" title="github" target="_blank">github</a><ul></ul><a href="http://www.cnblogs.com/a-ray-of-sunshine" title="cnblog" target="_blank">cnblog</a><ul></ul><a href="http://blog.csdn.net/a_ray_of_sunshine" title="csdn" target="_blank">csdn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Shawshank.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>