<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>FileChannel | Shawshank</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">FileChannel</h1><a id="logo" href="/.">Shawshank</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">FileChannel</h1><div class="post-meta">Oct 17, 2016</div><div class="post-content"><h2 id="FileChannel"><a href="#FileChannel" class="headerlink" title="FileChannel"></a>FileChannel</h2><p>FileChannel对象的获得：</p>
<ul>
<li>FileInputStream.getChannel</li>
<li>FileOutputStream.getChannel</li>
<li>RandomAccessFile.getChannel</li>
<li>FileChannel.open</li>
<li>Files.newByteChannel</li>
</ul>
<h3 id="FileChannelImpl"><a href="#FileChannelImpl" class="headerlink" title="FileChannelImpl"></a>FileChannelImpl</h3><p>openjdk\jdk\src\share\classes\sun\nio\ch\FileChannelImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">FileChannelImpl</span><span class="params">(FileDescriptor fd, <span class="keyword">boolean</span> readable,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">boolean</span> writable, <span class="keyword">boolean</span> append, Object parent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.fd = fd;</span><br><span class="line">    <span class="keyword">this</span>.readable = readable;</span><br><span class="line">    <span class="keyword">this</span>.writable = writable;</span><br><span class="line">    <span class="keyword">this</span>.append = append;</span><br><span class="line">    <span class="keyword">this</span>.parent = parent;</span><br><span class="line">    <span class="keyword">this</span>.nd = <span class="keyword">new</span> FileDispatcherImpl(append);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Used by FileInputStream.getChannel() and RandomAccessFile.getChannel()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FileChannel <span class="title">open</span><span class="params">(FileDescriptor fd,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">boolean</span> readable, <span class="keyword">boolean</span> writable,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Object parent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FileChannelImpl(fd, readable, writable, <span class="keyword">false</span>, parent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Used by FileOutputStream.getChannel</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FileChannel <span class="title">open</span><span class="params">(FileDescriptor fd,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">boolean</span> readable, <span class="keyword">boolean</span> writable,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">boolean</span> append, Object parent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FileChannelImpl(fd, readable, writable, append, parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FileDispatcherImpl"><a href="#FileDispatcherImpl" class="headerlink" title="FileDispatcherImpl"></a>FileDispatcherImpl</h3><p>不同的操作系统有不同的实现。</p>
<ul>
<li><p>windows</p>
<p>  openjdk\jdk\src\windows\classes\sun\nio\ch\FileDispatcherImpl.java</p>
<p>  openjdk\jdk\src\windows\native\sun\nio\ch\FileDispatcherImpl.c</p>
</li>
<li><p>linux</p>
<p>  openjdk\jdk\src\solaris\classes\sun\nio\ch\FileDispatcherImpl.java</p>
<p>  openjdk\jdk\src\solaris\native\sun\nio\ch\FileDispatcherImpl.c</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileChannelImpl</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(ByteBuffer dst)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ensureOpen();</span><br><span class="line">    <span class="keyword">if</span> (!readable)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NonReadableChannelException();</span><br><span class="line">    <span class="keyword">synchronized</span> (positionLock) &#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> ti = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            begin();</span><br><span class="line">            ti = threads.add();</span><br><span class="line">            <span class="keyword">if</span> (!isOpen())</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                n = IOUtil.read(fd, dst, -<span class="number">1</span>, nd, positionLock);</span><br><span class="line">            &#125; <span class="keyword">while</span> ((n == IOStatus.INTERRUPTED) &amp;&amp; isOpen());</span><br><span class="line">            <span class="keyword">return</span> IOStatus.normalize(n);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            threads.remove(ti);</span><br><span class="line">            end(n &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">assert</span> IOStatus.check(n);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IOUtil.read</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(FileDescriptor fd, ByteBuffer dst, <span class="keyword">long</span> position,</span></span></span><br><span class="line"><span class="function"><span class="params">                NativeDispatcher nd, Object lock)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dst.isReadOnly())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Read-only buffer"</span>);</span><br><span class="line">    <span class="keyword">if</span> (dst <span class="keyword">instanceof</span> DirectBuffer)</span><br><span class="line">		<span class="comment">// 如果Buffer是DirectBuffer，则调用下面的进行</span></span><br><span class="line">        <span class="keyword">return</span> readIntoNativeBuffer(fd, dst, position, nd, lock);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果不是 DirectBuffer， 则临时创建一个。</span></span><br><span class="line">    <span class="comment">// Substitute a native buffer</span></span><br><span class="line">    ByteBuffer bb = Util.getTemporaryDirectBuffer(dst.remaining());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> n = readIntoNativeBuffer(fd, bb, position, nd, lock);</span><br><span class="line">		<span class="comment">// bb 中存储数据</span></span><br><span class="line">		<span class="comment">// 读取到 dst 中。</span></span><br><span class="line">        bb.flip();</span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>)</span><br><span class="line">            dst.put(bb);</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Util.offerFirstTemporaryDirectBuffer(bb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">readIntoNativeBuffer</span><span class="params">(FileDescriptor fd, ByteBuffer bb,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">long</span> position, NativeDispatcher nd, Object lock)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = bb.position();</span><br><span class="line">    <span class="keyword">int</span> lim = bb.limit();</span><br><span class="line">    <span class="keyword">assert</span> (pos &lt;= lim);</span><br><span class="line">    <span class="keyword">int</span> rem = (pos &lt;= lim ? lim - pos : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 注意，如果 Buffer 的剩余空间不够了，直接返回0</span></span><br><span class="line">	<span class="comment">// 而不会抛出异常。</span></span><br><span class="line">    <span class="keyword">if</span> (rem == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (position != -<span class="number">1</span>) &#123;</span><br><span class="line">        n = nd.pread(fd, ((DirectBuffer)bb).address() + pos,</span><br><span class="line">                     rem, position, lock);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 进入到这个分支</span></span><br><span class="line">		<span class="comment">// 调用 NativeDispatcher 的 read 方法读取数据。</span></span><br><span class="line">		<span class="comment">// 这是个抽象类，由不同的平台提供实现。</span></span><br><span class="line">        n = nd.read(fd, ((DirectBuffer)bb).address() + pos, rem);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span>)</span><br><span class="line">        bb.position(pos + n);</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allows different platforms to call different native methods</span></span><br><span class="line"><span class="comment"> * for read and write operations.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// abstract class FileDispatcher extends NativeDispatcher</span></span><br><span class="line"><span class="comment">// FileDispatcher 不同的平台提供不同的实现 子类 FileDispatcherImpl</span></span><br><span class="line"><span class="comment">// sun\nio\ch\FileDispatcherImpl.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// openjdk\jdk\src\windows\classes\sun\nio\ch\FileDispatcherImpl.java</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read</span><span class="params">(FileDescriptor fd, <span class="keyword">long</span> address, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> read0(fd, address, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// openjdk\jdk\src\windows\native\sun\nio\ch\FileDispatcherImpl.c</span></span><br><span class="line"><span class="comment">// 这个文件是实现整个FileChannel的核心，FileChannel中与操作系统相关的</span></span><br><span class="line"><span class="comment">// 所以操作全部都在这个文件中实现。</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_read0(JNIEnv *env, jclass clazz, jobject fdo,</span><br><span class="line">                                      jlong address, jint len)</span><br><span class="line">&#123;</span><br><span class="line">    DWORD read = <span class="number">0</span>;</span><br><span class="line">    BOOL result = <span class="number">0</span>;</span><br><span class="line">    HANDLE h = (HANDLE)(handleval(env, fdo));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (h == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Invalid handle"</span>);</span><br><span class="line">        <span class="keyword">return</span> IOS_THROWN;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 调用 win32 API ReadFile 读取数据</span></span><br><span class="line">	<span class="comment">// result 返回非0值，表示读取成功。</span></span><br><span class="line">    result = ReadFile(h,          <span class="comment">/* File handle to read */</span></span><br><span class="line">                      (LPVOID)address,    <span class="comment">/* address to put data */</span></span><br><span class="line">                      len,        <span class="comment">/* number of bytes to read */</span></span><br><span class="line">                      &amp;read,      <span class="comment">/* number of bytes read */</span></span><br><span class="line">                      NULL);      <span class="comment">/* no overlapped struct */</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> error = GetLastError();</span><br><span class="line">        <span class="keyword">if</span> (error == ERROR_BROKEN_PIPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> IOS_EOF;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (error == ERROR_NO_DATA) &#123;</span><br><span class="line">            <span class="keyword">return</span> IOS_UNAVAILABLE;</span><br><span class="line">        &#125;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Read failed"</span>);</span><br><span class="line">        <span class="keyword">return</span> IOS_THROWN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> convertReturnVal(env, (jint)read, JNI_TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// FileDispatcherImpl 的 linux 实现：</span></span><br><span class="line"><span class="comment">// openjdk\jdk\src\solaris\classes\sun\nio\ch\FileDispatcherImpl.java</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read</span><span class="params">(FileDescriptor fd, <span class="keyword">long</span> address, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> read0(fd, address, len);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// openjdk\jdk\src\solaris\native\sun\nio\ch\FileDispatcherImpl.c</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_read0(JNIEnv *env, jclass clazz,</span><br><span class="line">                             jobject fdo, jlong address, jint len)</span><br><span class="line">&#123;</span><br><span class="line">    jint fd = fdval(env, fdo);</span><br><span class="line">    <span class="keyword">void</span> *buf = (<span class="keyword">void</span> *)jlong_to_ptr(address);</span><br><span class="line">	<span class="comment">// 调用 linux 系统调用 read </span></span><br><span class="line">	<span class="comment">// read() attempts to read up to count bytes </span></span><br><span class="line">	<span class="comment">// from file descriptor fd into the buffer starting at buf.</span></span><br><span class="line">	<span class="comment">// On success, the number of bytes read is returned</span></span><br><span class="line">    <span class="keyword">return</span> convertReturnVal(env, read(fd, buf, len), JNI_TRUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="FileDispatcherImpl-实现的写操作"><a href="#FileDispatcherImpl-实现的写操作" class="headerlink" title="FileDispatcherImpl 实现的写操作"></a>FileDispatcherImpl 实现的写操作</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// windows</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_write0(JNIEnv *env, jclass clazz, jobject fdo,</span><br><span class="line">                                          jlong address, jint len, jboolean append)</span><br><span class="line">&#123;</span><br><span class="line">    BOOL result = <span class="number">0</span>;</span><br><span class="line">    DWORD written = <span class="number">0</span>;</span><br><span class="line">    HANDLE h = (HANDLE)(handleval(env, fdo));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (h != INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        OVERLAPPED ov;</span><br><span class="line">        LPOVERLAPPED lpOv;</span><br><span class="line">        <span class="comment">// append 为 true,表示从文件最后面进行写入</span></span><br><span class="line">        <span class="keyword">if</span> (append == JNI_TRUE) &#123;</span><br><span class="line">        	<span class="comment">// To write to the end of file, specify both the </span></span><br><span class="line">        	<span class="comment">// Offset and OffsetHigh members of the OVERLAPPED structure as 0xFFFFFFFF. </span></span><br><span class="line">            ov.Offset = (DWORD)<span class="number">0xFFFFFFFF</span>;</span><br><span class="line">            ov.OffsetHigh = (DWORD)<span class="number">0xFFFFFFFF</span>;</span><br><span class="line">            ov.hEvent = <span class="literal">NULL</span>;</span><br><span class="line">            lpOv = &amp;ov;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="comment">// 写入到当前文件指针的位置。</span></span><br><span class="line">            lpOv = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        result = WriteFile(h,           <span class="comment">/* File handle to write */</span></span><br><span class="line">                      (LPCVOID)address, <span class="comment">/* pointers to the buffers */</span></span><br><span class="line">                      len,              <span class="comment">/* number of bytes to write */</span></span><br><span class="line">                      &amp;written,         <span class="comment">/* receives number of bytes written */</span></span><br><span class="line">                      lpOv);            <span class="comment">/* overlapped struct */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((h == INVALID_HANDLE_VALUE) || (result == <span class="number">0</span>)) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Write failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> convertReturnVal(env, (jint)written, JNI_FALSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// linux</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_write0(JNIEnv *env, jclass clazz,</span><br><span class="line">                              jobject fdo, jlong address, jint len)</span><br><span class="line">&#123;</span><br><span class="line">    jint fd = fdval(env, fdo);</span><br><span class="line">    <span class="keyword">void</span> *buf = (<span class="keyword">void</span> *)jlong_to_ptr(address);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// write() writes up to count bytes from the buffer pointed buf</span></span><br><span class="line">	<span class="comment">// to the file referred to by the file descriptor fd.</span></span><br><span class="line">	<span class="comment">// On success, the number of bytes written is returned</span></span><br><span class="line">    <span class="keyword">return</span> convertReturnVal(env, write(fd, buf, len), JNI_FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Channel的关闭"><a href="#Channel的关闭" class="headerlink" title="Channel的关闭"></a>Channel的关闭</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileChannelImpl.java</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">implCloseChannel</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 释放 channel 持有的锁</span></span><br><span class="line">    <span class="comment">// Release and invalidate any locks that we still hold</span></span><br><span class="line">    <span class="keyword">if</span> (fileLockTable != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (FileLock fl: fileLockTable.removeAll()) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (fl) &#123;</span><br><span class="line">                <span class="keyword">if</span> (fl.isValid()) &#123;</span><br><span class="line">                    nd.release(fd, fl.position(), fl.size());</span><br><span class="line">                    ((FileLockImpl)fl).invalidate();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nd.preClose(fd);</span><br><span class="line">    threads.signalAndWait();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// 如果 channel 是由 FileInputStream.getChannel 获得的</span></span><br><span class="line">		<span class="comment">// 则 parent 就是 FileInputStream，所以 fd 的关闭操作</span></span><br><span class="line">		<span class="comment">// 应该委托给 parent 进行。</span></span><br><span class="line">        <span class="comment">// Close the fd via the parent stream's close method.  The parent</span></span><br><span class="line">        <span class="comment">// will reinvoke our close method, which is defined in the</span></span><br><span class="line">        <span class="comment">// superclass AbstractInterruptibleChannel, but the isOpen logic in</span></span><br><span class="line">        <span class="comment">// that method will prevent this method from being reinvoked.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        ((java.io.Closeable)parent).close();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">// 调用 FileDispatcherImpl 关闭 fd.</span></span><br><span class="line">        nd.close(fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FileDispatcherImpl 关闭 fd 的实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// windows</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeFile</span><span class="params">(JNIEnv *env, jlong fd)</span> </span>&#123;</span><br><span class="line">    HANDLE h = (HANDLE)fd;</span><br><span class="line">    <span class="keyword">if</span> (h != INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">    	<span class="comment">// Closes an open object handle.</span></span><br><span class="line">        <span class="keyword">int</span> result = CloseHandle(h);</span><br><span class="line">        <span class="keyword">if</span> (result &lt; <span class="number">0</span>)</span><br><span class="line">            JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Close failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_close0(JNIEnv *env, jclass clazz, jobject fdo)</span><br><span class="line">&#123;</span><br><span class="line">    jlong fd = handleval(env, fdo);</span><br><span class="line">    closeFile(env, fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// linux</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeFileDescriptor</span><span class="params">(JNIEnv *env, <span class="keyword">int</span> fd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">    	<span class="comment">// close() closes a file descriptor, so that it no longer </span></span><br><span class="line">    	<span class="comment">// refers to any file and may be reused.</span></span><br><span class="line">        <span class="keyword">int</span> result = close(fd);</span><br><span class="line">        <span class="keyword">if</span> (result &lt; <span class="number">0</span>)</span><br><span class="line">            JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Close failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_close0(JNIEnv *env, jclass clazz, jobject fdo)</span><br><span class="line">&#123;</span><br><span class="line">    jint fd = fdval(env, fdo);</span><br><span class="line">    closeFileDescriptor(env, fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="lock-方法"><a href="#lock-方法" class="headerlink" title="lock 方法"></a>lock 方法</h3><ul>
<li>public abstract FileLock lock(long position, long size, boolean shared)</li>
<li>public final FileLock lock()</li>
<li>public abstract FileLock tryLock(long position, long size, boolean shared)</li>
<li>public final FileLock tryLock()</li>
</ul>
<blockquote>
<p>Acquires a lock on the given region of this channel’s file. </p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileChannelImpl</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FileLock <span class="title">lock</span><span class="params">(<span class="keyword">long</span> position, <span class="keyword">long</span> size, boolean shared)</span></span></span><br><span class="line"><span class="function">    throws IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ensureOpen();</span><br><span class="line">    <span class="keyword">if</span> (shared &amp;&amp; !readable)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NonReadableChannelException();</span><br><span class="line">    <span class="keyword">if</span> (!shared &amp;&amp; !writable)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NonWritableChannelException();</span><br><span class="line">    FileLockImpl fli = <span class="keyword">new</span> FileLockImpl(<span class="keyword">this</span>, position, size, shared);</span><br><span class="line">    FileLockTable flt = fileLockTable();</span><br><span class="line">    flt.add(fli);</span><br><span class="line">    boolean completed = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">int</span> ti = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        begin();</span><br><span class="line">        ti = threads.add();</span><br><span class="line">        <span class="keyword">if</span> (!isOpen())</span><br><span class="line">            <span class="keyword">return</span> null;</span><br><span class="line">        <span class="keyword">int</span> n;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">        	<span class="comment">// 以 block 形式不断尝试获取锁</span></span><br><span class="line">            n = nd.lock(fd, <span class="literal">true</span>, position, size, shared);</span><br><span class="line">        &#125; <span class="keyword">while</span> ((n == FileDispatcher.INTERRUPTED) &amp;&amp; isOpen());</span><br><span class="line">        <span class="keyword">if</span> (isOpen()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (n == FileDispatcher.RET_EX_LOCK) &#123;</span><br><span class="line">                assert shared;</span><br><span class="line">                <span class="comment">// 锁获得成功，创建 FileLock 对象。</span></span><br><span class="line">                FileLockImpl fli2 = <span class="keyword">new</span> FileLockImpl(<span class="keyword">this</span>, position, size,</span><br><span class="line">                                                     <span class="literal">false</span>);</span><br><span class="line">                flt.replace(fli, fli2);</span><br><span class="line">                fli = fli2;</span><br><span class="line">            &#125;</span><br><span class="line">            completed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        <span class="keyword">if</span> (!completed)</span><br><span class="line">            flt.remove(fli);</span><br><span class="line">        threads.remove(ti);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            end(completed);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClosedByInterruptException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileLockInterruptionException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fli;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// windows</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_lock0(JNIEnv *env, jobject <span class="keyword">this</span>, jobject fdo,</span><br><span class="line">                                      jboolean block, jlong pos, jlong size,</span><br><span class="line">                                      jboolean shared)</span><br><span class="line">&#123;</span><br><span class="line">    HANDLE h = (HANDLE)(handleval(env, fdo));</span><br><span class="line">    DWORD lowPos = (DWORD)pos;</span><br><span class="line">    <span class="keyword">long</span> highPos = (<span class="keyword">long</span>)(pos &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    DWORD lowNumBytes = (DWORD)size;</span><br><span class="line">    DWORD highNumBytes = (DWORD)(size &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    BOOL result;</span><br><span class="line">    DWORD flags = <span class="number">0</span>;</span><br><span class="line">    OVERLAPPED o;</span><br><span class="line">    o.hEvent = <span class="number">0</span>;</span><br><span class="line">    o.Offset = lowPos;</span><br><span class="line">    o.OffsetHigh = highPos;</span><br><span class="line">    <span class="keyword">if</span> (block == JNI_FALSE) &#123;</span><br><span class="line">        flags |= LOCKFILE_FAIL_IMMEDIATELY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shared == JNI_FALSE) &#123;</span><br><span class="line">        flags |= LOCKFILE_EXCLUSIVE_LOCK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Locks the specified file for exclusive access by the calling process. </span></span><br><span class="line">    result = LockFileEx(h, flags, <span class="number">0</span>, lowNumBytes, highNumBytes, &amp;o);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> error = GetLastError();</span><br><span class="line">        <span class="keyword">if</span> (error != ERROR_LOCK_VIOLATION) &#123;</span><br><span class="line">            JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Lock failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> sun_nio_ch_FileDispatcherImpl_NO_LOCK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (flags &amp; LOCKFILE_FAIL_IMMEDIATELY) &#123;</span><br><span class="line">            <span class="keyword">return</span> sun_nio_ch_FileDispatcherImpl_NO_LOCK;</span><br><span class="line">        &#125;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Lock failed"</span>);</span><br><span class="line">        <span class="keyword">return</span> sun_nio_ch_FileDispatcherImpl_NO_LOCK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sun_nio_ch_FileDispatcherImpl_LOCKED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// linux</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_lock0(JNIEnv *env, jobject <span class="keyword">this</span>, jobject fdo,</span><br><span class="line">                                      jboolean block, jlong pos, jlong size,</span><br><span class="line">                                      jboolean shared)</span><br><span class="line">&#123;</span><br><span class="line">    jint fd = fdval(env, fdo);</span><br><span class="line">    jint lockResult = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> cmd = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">flock64</span> <span class="title">fl</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Specifies the starting offset of the lock </span></span><br><span class="line">	<span class="comment">// segment in the file. Valid settings are:</span></span><br><span class="line">	<span class="comment">// 0. l_whence 参数表明：偏移量 l_start 相对于文件的起始位置。</span></span><br><span class="line">    fl.l_whence = SEEK_SET;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. l_len 表明：被锁segment的长度。</span></span><br><span class="line">    <span class="keyword">if</span> (size == (jlong)java_lang_Long_MAX_VALUE) &#123;</span><br><span class="line">        fl.l_len = (<span class="keyword">off64_t</span>)<span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fl.l_len = (<span class="keyword">off64_t</span>)size;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. l_start 被锁方法的偏移量</span></span><br><span class="line">    fl.l_start = (<span class="keyword">off64_t</span>)pos;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. l_type 表示操作类型</span></span><br><span class="line">    <span class="comment">// 如果 l_type 是 F_UNLCK，表示：Remove a lock. 释放锁。 </span></span><br><span class="line">    <span class="keyword">if</span> (shared == JNI_TRUE) &#123;</span><br><span class="line">    	<span class="comment">// F_RDLCK: Create a shared lock.</span></span><br><span class="line">        fl.l_type = F_RDLCK;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">// F_WRLCK: Create an exclusive lock.</span></span><br><span class="line">        fl.l_type = F_WRLCK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 要执行的命令</span></span><br><span class="line">    <span class="comment">// Set or clear a file segment lock for the file </span></span><br><span class="line">    <span class="comment">// to which the specified file descriptor refers.</span></span><br><span class="line">    <span class="keyword">if</span> (block == JNI_TRUE) &#123;</span><br><span class="line">    	<span class="comment">// 和 F_SETLK64 功能相同，不过，它是block的：</span></span><br><span class="line">    	<span class="comment">// if a shared or exclusive lock is blocked by other locks, </span></span><br><span class="line">    	<span class="comment">// the thread waits until the request can be satisfied.</span></span><br><span class="line">    	<span class="comment">// 阻塞到获得锁，或者线程被中断</span></span><br><span class="line">        cmd = F_SETLKW64;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">// If the lock cannot be immediately obtained, </span></span><br><span class="line">    	<span class="comment">// fcntl() returns -1 with errno set to EACCES.</span></span><br><span class="line">    	<span class="comment">// 如果不能获得锁，则立即返回-1</span></span><br><span class="line">        cmd = F_SETLK64;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    lockResult = fcntl(fd, cmd, &amp;fl);</span><br><span class="line">    <span class="keyword">if</span> (lockResult &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((cmd == F_SETLK64) &amp;&amp; (errno == EAGAIN))</span><br><span class="line">            <span class="keyword">return</span> sun_nio_ch_FileDispatcherImpl_NO_LOCK;</span><br><span class="line">        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">            <span class="keyword">return</span> sun_nio_ch_FileDispatcherImpl_INTERRUPTED;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Lock failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 lock 方法获得锁成功之后，会创建一个 FileLock 对象来表示这个锁:</p>
<p><code>FileLockImpl fli2 = new FileLockImpl(this, position, size, false);</code></p>
<p>使用这个对象可以用来释放锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileLockImpl.release</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Channel ch = acquiredBy();</span><br><span class="line">    <span class="keyword">if</span> (!ch.isOpen())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClosedChannelException();</span><br><span class="line">    <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ch <span class="keyword">instanceof</span> FileChannelImpl)</span><br><span class="line">            ((FileChannelImpl)ch).release(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ch <span class="keyword">instanceof</span> AsynchronousFileChannelImpl)</span><br><span class="line">            ((AsynchronousFileChannelImpl)ch).release(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">        valid = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FileChannelImpl.release</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release</span><span class="params">(FileLockImpl fli)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ti = threads.add();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ensureOpen();</span><br><span class="line">        nd.release(fd, fli.position(), fli.size());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        threads.remove(ti);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">assert</span> fileLockTable != <span class="keyword">null</span>;</span><br><span class="line">    fileLockTable.remove(fli);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// windows</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_release0(JNIEnv *env, jobject <span class="keyword">this</span>, jobject fdo, jlong pos, jlong size)</span><br><span class="line">&#123;</span><br><span class="line">    HANDLE h = (HANDLE)(handleval(env, fdo));</span><br><span class="line">    DWORD lowPos = (DWORD)pos;</span><br><span class="line">    <span class="keyword">long</span> highPos = (<span class="keyword">long</span>)(pos &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    DWORD lowNumBytes = (DWORD)size;</span><br><span class="line">    DWORD highNumBytes = (DWORD)(size &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    jint result = <span class="number">0</span>;</span><br><span class="line">    OVERLAPPED o;</span><br><span class="line">    o.hEvent = <span class="number">0</span>;</span><br><span class="line">    o.Offset = lowPos;</span><br><span class="line">    o.OffsetHigh = highPos;</span><br><span class="line">    <span class="comment">// Unlocks a region in the specified file.</span></span><br><span class="line">    result = UnlockFileEx(h, <span class="number">0</span>, lowNumBytes, highNumBytes, &amp;o);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">0</span> &amp;&amp; GetLastError() != ERROR_NOT_LOCKED) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Release failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// linux</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_release0(JNIEnv *env, jobject <span class="keyword">this</span>,</span><br><span class="line">                                         jobject fdo, jlong pos, jlong size)</span><br><span class="line">&#123;</span><br><span class="line">    jint fd = fdval(env, fdo);</span><br><span class="line">    jint lockResult = <span class="number">0</span>;</span><br><span class="line">    struct flock64 fl;</span><br><span class="line">    <span class="keyword">int</span> cmd = F_SETLK64;</span><br><span class="line"></span><br><span class="line">    fl.l_whence = SEEK_SET;</span><br><span class="line">    <span class="keyword">if</span> (size == (jlong)java_lang_Long_MAX_VALUE) &#123;</span><br><span class="line">        fl.l_len = (off64_t)<span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fl.l_len = (off64_t)size;</span><br><span class="line">    &#125;</span><br><span class="line">    fl.l_start = (off64_t)pos;</span><br><span class="line">    <span class="comment">// F_UNLCK: Remove a lock.</span></span><br><span class="line">    fl.l_type = F_UNLCK;</span><br><span class="line">    lockResult = fcntl(fd, cmd, &amp;fl);</span><br><span class="line">    <span class="keyword">if</span> (lockResult &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Release failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="map-内存映射文件"><a href="#map-内存映射文件" class="headerlink" title="map 内存映射文件"></a>map 内存映射文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MappedByteBuffer <span class="title">map</span><span class="params">(MapMode mode, <span class="keyword">long</span> position, <span class="keyword">long</span> size)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ensureOpen();</span><br><span class="line">    <span class="keyword">if</span> (position &lt; <span class="number">0L</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Negative position"</span>);</span><br><span class="line">    <span class="keyword">if</span> (size &lt; <span class="number">0L</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Negative size"</span>);</span><br><span class="line">    <span class="keyword">if</span> (position + size &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Position + size overflow"</span>);</span><br><span class="line">    <span class="keyword">if</span> (size &gt; Integer.MAX_VALUE)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Size exceeds Integer.MAX_VALUE"</span>);</span><br><span class="line">    <span class="keyword">int</span> imode = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode == MapMode.READ_ONLY)</span><br><span class="line">        imode = MAP_RO;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode == MapMode.READ_WRITE)</span><br><span class="line">        imode = MAP_RW;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode == MapMode.PRIVATE)</span><br><span class="line">        imode = MAP_PV;</span><br><span class="line">    <span class="keyword">assert</span> (imode &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((mode != MapMode.READ_ONLY) &amp;&amp; !writable)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NonWritableChannelException();</span><br><span class="line">    <span class="keyword">if</span> (!readable)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NonReadableChannelException();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> addr = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ti = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        begin();</span><br><span class="line">        ti = threads.add();</span><br><span class="line">        <span class="keyword">if</span> (!isOpen())</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (size() &lt; position + size) &#123; <span class="comment">// Extend file size</span></span><br><span class="line">            <span class="keyword">if</span> (!writable) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Channel not open for writing "</span> +</span><br><span class="line">                    <span class="string">"- cannot extend file to required size"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> rv;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                rv = nd.truncate(fd, position + size);</span><br><span class="line">            &#125; <span class="keyword">while</span> ((rv == IOStatus.INTERRUPTED) &amp;&amp; isOpen());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">            addr = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// a valid file descriptor is not required</span></span><br><span class="line">            FileDescriptor dummy = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">            <span class="keyword">if</span> ((!writable) || (imode == MAP_RO))</span><br><span class="line">                <span class="keyword">return</span> Util.newMappedByteBufferR(<span class="number">0</span>, <span class="number">0</span>, dummy, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> Util.newMappedByteBuffer(<span class="number">0</span>, <span class="number">0</span>, dummy, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> pagePosition = (<span class="keyword">int</span>)(position % allocationGranularity);</span><br><span class="line">        <span class="keyword">long</span> mapPosition = position - pagePosition;</span><br><span class="line">        <span class="keyword">long</span> mapSize = size + pagePosition;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// If no exception was thrown from map0, the address is valid</span></span><br><span class="line">            <span class="comment">// 调用native方法进行内存映射</span></span><br><span class="line">            addr = map0(imode, mapPosition, mapSize);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</span><br><span class="line">            <span class="comment">// An OutOfMemoryError may indicate that we've exhausted memory</span></span><br><span class="line">            <span class="comment">// so force gc and re-attempt map</span></span><br><span class="line">            System.gc();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException y) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                addr = map0(imode, mapPosition, mapSize);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (OutOfMemoryError y) &#123;</span><br><span class="line">                <span class="comment">// After a second OOME, fail</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Map failed"</span>, y);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// On Windows, and potentially other platforms, we need an open</span></span><br><span class="line">        <span class="comment">// file descriptor for some mapping operations.</span></span><br><span class="line">        FileDescriptor mfd;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mfd = nd.duplicateForMapping(fd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            unmap0(addr, mapSize);</span><br><span class="line">            <span class="keyword">throw</span> ioe;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> (IOStatus.checkAll(addr));</span><br><span class="line">        <span class="keyword">assert</span> (addr % allocationGranularity == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">int</span> isize = (<span class="keyword">int</span>)size;</span><br><span class="line">        Unmapper um = <span class="keyword">new</span> Unmapper(addr, mapSize, isize, mfd);</span><br><span class="line">        <span class="comment">// 映射成功，将 addr 作为 MappedByteBuffer 的基址</span></span><br><span class="line">        <span class="keyword">if</span> ((!writable) || (imode == MAP_RO)) &#123;</span><br><span class="line">        <span class="comment">// 相当于： return new DirectByteBufferR(isize,addr + pagePosition,mfd,um)</span></span><br><span class="line">            <span class="keyword">return</span> Util.newMappedByteBufferR(isize,</span><br><span class="line">                                             addr + pagePosition,</span><br><span class="line">                                             mfd,</span><br><span class="line">                                             um);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 相当于 return new DirectByteBuffer(isize,addr + pagePosition,mfd,um);</span></span><br><span class="line">            <span class="keyword">return</span> Util.newMappedByteBuffer(isize,</span><br><span class="line">                                            addr + pagePosition,</span><br><span class="line">                                            mfd,</span><br><span class="line">                                            um);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        threads.remove(ti);</span><br><span class="line">        end(IOStatus.checkAll(addr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// map0 的实现</span></span><br><span class="line"><span class="comment">// winodws</span></span><br><span class="line">JNIEXPORT jlong JNICALL</span><br><span class="line">Java_sun_nio_ch_FileChannelImpl_map0(JNIEnv *env, jobject <span class="keyword">this</span>,</span><br><span class="line">                               jint prot, jlong off, jlong len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> *mapAddress = <span class="number">0</span>;</span><br><span class="line">    jint lowOffset = (jint)off;</span><br><span class="line">    jint highOffset = (jint)(off &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    jlong maxSize = off + len;</span><br><span class="line">    jint lowLen = (jint)(maxSize);</span><br><span class="line">    jint highLen = (jint)(maxSize &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    jobject fdo = (*env)-&gt;GetObjectField(env, <span class="keyword">this</span>, chan_fd);</span><br><span class="line">    HANDLE fileHandle = (HANDLE)(handleval(env, fdo));</span><br><span class="line">    HANDLE mapping;</span><br><span class="line">    DWORD mapAccess = FILE_MAP_READ;</span><br><span class="line">    DWORD fileProtect = PAGE_READONLY;</span><br><span class="line">    DWORD mapError;</span><br><span class="line">    BOOL result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_RO) &#123;</span><br><span class="line">        fileProtect = PAGE_READONLY;</span><br><span class="line">        mapAccess = FILE_MAP_READ;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_RW) &#123;</span><br><span class="line">        fileProtect = PAGE_READWRITE;</span><br><span class="line">        mapAccess = FILE_MAP_WRITE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_PV) &#123;</span><br><span class="line">        fileProtect = PAGE_WRITECOPY;</span><br><span class="line">        mapAccess = FILE_MAP_COPY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Creates or opens a named or unnamed file mapping object for a specified file.</span></span><br><span class="line">    mapping = CreateFileMapping(</span><br><span class="line">        fileHandle,      <span class="comment">/* Handle of file */</span></span><br><span class="line">        NULL,            <span class="comment">/* Not inheritable */</span></span><br><span class="line">        fileProtect,     <span class="comment">/* Read and write */</span></span><br><span class="line">        highLen,         <span class="comment">/* High word of max size */</span></span><br><span class="line">        lowLen,          <span class="comment">/* Low word of max size */</span></span><br><span class="line">        NULL);           <span class="comment">/* No name for object */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mapping == NULL) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Map failed"</span>);</span><br><span class="line">        <span class="keyword">return</span> IOS_THROWN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Maps a view of a file mapping into the address space of a calling process.</span></span><br><span class="line">    mapAddress = MapViewOfFile(</span><br><span class="line">        mapping,             <span class="comment">/* Handle of file mapping object */</span></span><br><span class="line">        mapAccess,           <span class="comment">/* Read and write access */</span></span><br><span class="line">        highOffset,          <span class="comment">/* High word of offset */</span></span><br><span class="line">        lowOffset,           <span class="comment">/* Low word of offset */</span></span><br><span class="line">        (DWORD)len);         <span class="comment">/* Number of bytes to map */</span></span><br><span class="line">    mapError = GetLastError();</span><br><span class="line"></span><br><span class="line">    result = CloseHandle(mapping);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Map failed"</span>);</span><br><span class="line">        <span class="keyword">return</span> IOS_THROWN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mapAddress == NULL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mapError == ERROR_NOT_ENOUGH_MEMORY)</span><br><span class="line">            JNU_ThrowOutOfMemoryError(env, <span class="string">"Map failed"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Map failed"</span>);</span><br><span class="line">        <span class="keyword">return</span> IOS_THROWN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ptr_to_jlong(mapAddress);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// linux</span></span><br><span class="line">JNIEXPORT jlong JNICALL</span><br><span class="line">Java_sun_nio_ch_FileChannelImpl_map0(JNIEnv *env, jobject <span class="keyword">this</span>,</span><br><span class="line">                                     jint prot, jlong off, jlong len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> *mapAddress = <span class="number">0</span>;</span><br><span class="line">    jobject fdo = (*env)-&gt;GetObjectField(env, <span class="keyword">this</span>, chan_fd);</span><br><span class="line">    jint fd = fdval(env, fdo);</span><br><span class="line">    <span class="keyword">int</span> protections = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_RO) &#123;</span><br><span class="line">        protections = PROT_READ;</span><br><span class="line">        flags = MAP_SHARED;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_RW) &#123;</span><br><span class="line">        protections = PROT_WRITE | PROT_READ;</span><br><span class="line">        flags = MAP_SHARED;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_PV) &#123;</span><br><span class="line">        protections =  PROT_WRITE | PROT_READ;</span><br><span class="line">        flags = MAP_PRIVATE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// mmap() creates a new mapping in the virtual address space of the calling process.</span></span><br><span class="line">    mapAddress = mmap64(</span><br><span class="line">        <span class="number">0</span>,                    <span class="comment">/* Let OS decide location */</span></span><br><span class="line">        len,                  <span class="comment">/* Number of bytes to map */</span></span><br><span class="line">        protections,          <span class="comment">/* File permissions */</span></span><br><span class="line">        flags,                <span class="comment">/* Changes are shared */</span></span><br><span class="line">        fd,                   <span class="comment">/* File descriptor of mapped file */</span></span><br><span class="line">        off);                 <span class="comment">/* Offset into file */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mapAddress == MAP_FAILED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == ENOMEM) &#123;</span><br><span class="line">            JNU_ThrowOutOfMemoryError(env, <span class="string">"Map failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> IOS_THROWN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> handle(env, -<span class="number">1</span>, <span class="string">"Map failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ((jlong) (unsigned <span class="keyword">long</span>) mapAddress);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="可中断机制"><a href="#可中断机制" class="headerlink" title="可中断机制"></a>可中断机制</h3><p>FileChannel在实现I/O操作，其基本形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Operator</span><span class="params">(...)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (positionLock) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            begin();</span><br><span class="line">            <span class="comment">// Operator...</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            end(n &gt; <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 begin 将会在在设置当前线程线程中的 blocker 对象，这个对象将会在 Thread.interrupt 对象中被调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> != Thread.currentThread())</span><br><span class="line">        checkAccess();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (blockerLock) &#123;</span><br><span class="line">        Interruptible b = blocker;</span><br><span class="line">        <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">            interrupt0(); <span class="comment">// Just to set the interrupt flag</span></span><br><span class="line">            <span class="comment">// blocker 对象的 interrupt 方法</span></span><br><span class="line">            <span class="comment">// 会被调用</span></span><br><span class="line">            b.interrupt(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt0();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>blocker 对象的实现如下：</p>
<ul>
<li>open 设置为 false</li>
<li>调用 implCloseChannel 来清除资源，关闭 channel</li>
</ul>
<p>在 end 方法中，会检测是否被中断或者是被关闭，相应地抛出异常。</p>
<p>所以可以看到，其实对于任何一个线程来说，都是可以中断的，但是，由于 channel 对注册了 blocker 对象，使得对于阻塞在 channel 上进行 IO 操作的线程，当执行异步关闭或者中断时 channel 会将其所占用的资源全部释放。<strong>所以可以说 channel 是可以安全地进行异步关闭和中断。</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -- Interruption machinery --</span></span><br><span class="line"><span class="keyword">private</span> Interruptible interruptor;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Thread interrupted;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Set thread's blocker field. */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (interruptor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        interruptor = <span class="keyword">new</span> Interruptible() &#123;</span><br><span class="line">        </span><br><span class="line">        		<span class="comment">// 线程被中断时会调用这个函数</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">(Thread target)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (closeLock) &#123;</span><br><span class="line">                    </span><br><span class="line">                    	<span class="comment">// 清除状态位</span></span><br><span class="line">                        <span class="keyword">if</span> (!open)</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        open = <span class="keyword">false</span>;</span><br><span class="line">                        interrupted = target;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 调用implCloseChannel清理资源</span></span><br><span class="line">		AbstractInterruptibleChannel.<span class="keyword">this</span>.implCloseChannel();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException x) &#123; &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将上面的 interruptor 设置到当前线程的 blocker 对象上</span></span><br><span class="line">    <span class="comment">// private volatile Interruptible blocker;</span></span><br><span class="line">    <span class="comment">// 这个方法的最终实现就是调用 Thread.blockedOn 方法,类似于：</span></span><br><span class="line">    <span class="comment">// Thread.currentThread().blockedOn(interruptor);</span></span><br><span class="line">    blockedOn(interruptor);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其实下面的代码并不是必须的，因为上面已经将 interruptor 设置到</span></span><br><span class="line">    <span class="comment">// 当前线程 me 的 blocker 字段中，如果有其它线程调用了 me.interrupt</span></span><br><span class="line">    <span class="comment">// 方法使得线程被中断，则 interruptor.interrupt(me) 方法也会被调用</span></span><br><span class="line">    Thread me = Thread.currentThread();</span><br><span class="line">    <span class="keyword">if</span> (me.isInterrupted())</span><br><span class="line">        interruptor.interrupt(me);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">(<span class="keyword">boolean</span> completed)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> AsynchronousCloseException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 将当前线程的 blocker 清除</span></span><br><span class="line">    blockedOn(<span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果线程被中断，则this.interrupted会被设置，那个中断当前线程的线程</span></span><br><span class="line">    Thread interrupted = <span class="keyword">this</span>.interrupted;</span><br><span class="line">    <span class="keyword">if</span> (interrupted != <span class="keyword">null</span> &amp;&amp; interrupted == Thread.currentThread()) &#123;</span><br><span class="line">    	<span class="comment">// 当前线程自己中断了自己</span></span><br><span class="line">        interrupted = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClosedByInterruptException();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果操作失败（!completed） 且 </span></span><br><span class="line">    <span class="comment">// 当前线程被其它线程中断（!open，代码执行到这里，open变成false的惟一的原因就是被其它线程中断或者是当前channel被其它线程关闭）</span></span><br><span class="line">    <span class="comment">// 则表明当前线程被异步中断了</span></span><br><span class="line">    <span class="keyword">if</span> (!completed &amp;&amp; !open)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AsynchronousCloseException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="随机访问"><a href="#随机访问" class="headerlink" title="随机访问"></a>随机访问</h3><ul>
<li><p>public abstract int read(ByteBuffer dst, long position)</p>
</li>
<li><p>public abstract int write(ByteBuffer src, long position)</p>
</li>
</ul>
<p>这两个方法可以直接从指定的 position 处读取和写入数据，它们不会改变 file pointer 的值。</p>
<p>其底层由下面的方法实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linux</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_pwrite0(JNIEnv *env, jclass clazz, jobject fdo,</span><br><span class="line">                            jlong address, jint len, jlong offset)</span><br><span class="line">&#123;</span><br><span class="line">    jint fd = fdval(env, fdo);</span><br><span class="line">    <span class="keyword">void</span> *buf = (<span class="keyword">void</span> *)jlong_to_ptr(address);</span><br><span class="line">	<span class="comment">// pwrite() writes up to count bytes from the buffer starting at </span></span><br><span class="line">	<span class="comment">// buf to the file descriptor fd at offset offset. The file </span></span><br><span class="line">	<span class="comment">// offset is not changed.</span></span><br><span class="line">    <span class="keyword">return</span> convertReturnVal(env, pwrite64(fd, buf, len, offset), JNI_FALSE);</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_sun_nio_ch_FileDispatcherImpl_pread0(JNIEnv *env, jclass clazz, jobject fdo,</span><br><span class="line">                            jlong address, jint len, jlong offset)</span><br><span class="line">&#123;</span><br><span class="line">    jint fd = fdval(env, fdo);</span><br><span class="line">    <span class="keyword">void</span> *buf = (<span class="keyword">void</span> *)jlong_to_ptr(address);</span><br><span class="line">	<span class="comment">// pread() reads up to count bytes from file descriptor fd at </span></span><br><span class="line">	<span class="comment">// offset offset (from the start of the file) into the buffer </span></span><br><span class="line">	<span class="comment">// starting at buf. The file offset is not changed.</span></span><br><span class="line">    <span class="keyword">return</span> convertReturnVal(env, pread64(fd, buf, len, offset), JNI_TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// windows</span></span><br><span class="line"><span class="comment">// windows 并没有像 pwrite 和 pread 类方法，可以在不改变 file potioner </span></span><br><span class="line"><span class="comment">//的情况下进行读写，所以使用 SetFilePointer 查询并保存操作之前的位置，</span></span><br><span class="line"><span class="comment">// 操作完成之后，将其恢复，从而实现相同的目的。</span></span><br></pre></td></tr></table></figure>
<h3 id="FileChannel-open"><a href="#FileChannel-open" class="headerlink" title="FileChannel.open"></a>FileChannel.open</h3><p>实现过程：</p>
<ol>
<li>调用 CreateFile 获得文件句柄(或者open/openat获得文件描述符)</li>
<li>创建 FileDescriptor 对象</li>
<li>调用 FileChannelImpl.open 方法（使用上面的fd），创建 FileChannel</li>
</ol>
<p>openjdk\jdk\src\windows\classes\sun\nio\fs\WindowsChannelFactory.java</p>
<p>由 WindowsChannelFactory.newFileChannel 实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FileChannel <span class="title">newFileChannel</span><span class="params">(String pathForWindows,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  String pathToCheck,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  Set&lt;? extends OpenOption&gt; options,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">long</span> pSecurityDescriptor)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> WindowsException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Flags flags = Flags.toFlags(options);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// default is reading; append =&gt; writing</span></span><br><span class="line">    <span class="keyword">if</span> (!flags.read &amp;&amp; !flags.write) &#123;</span><br><span class="line">        <span class="keyword">if</span> (flags.append) &#123;</span><br><span class="line">            flags.write = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            flags.read = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// validation</span></span><br><span class="line">    <span class="keyword">if</span> (flags.read &amp;&amp; flags.append)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"READ + APPEND not allowed"</span>);</span><br><span class="line">    <span class="keyword">if</span> (flags.append &amp;&amp; flags.truncateExisting)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"APPEND + TRUNCATE_EXISTING not allowed"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用 open 获得文件描述符</span></span><br><span class="line">    FileDescriptor fdObj = open(pathForWindows, pathToCheck, flags, pSecurityDescriptor);</span><br><span class="line">    <span class="comment">// 创建 FileChannelImpl 对象</span></span><br><span class="line">    <span class="keyword">return</span> FileChannelImpl.open(fdObj, flags.read, flags.write, flags.append, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Opens file based on parameters and options, returning a FileDescriptor</span></span><br><span class="line"><span class="comment"> * encapsulating the handle to the open file.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> FileDescriptor <span class="title">open</span><span class="params">(String pathForWindows,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   String pathToCheck,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   Flags flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">long</span> pSecurityDescriptor)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> WindowsException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// set to true if file must be truncated after open</span></span><br><span class="line">    <span class="keyword">boolean</span> truncateAfterOpen = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// map options</span></span><br><span class="line">    <span class="keyword">int</span> dwDesiredAccess = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (flags.read)</span><br><span class="line">        dwDesiredAccess |= GENERIC_READ;</span><br><span class="line">    <span class="keyword">if</span> (flags.write)</span><br><span class="line">        dwDesiredAccess |= GENERIC_WRITE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> dwShareMode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (flags.shareRead)</span><br><span class="line">        dwShareMode |= FILE_SHARE_READ;</span><br><span class="line">    <span class="keyword">if</span> (flags.shareWrite)</span><br><span class="line">        dwShareMode |= FILE_SHARE_WRITE;</span><br><span class="line">    <span class="keyword">if</span> (flags.shareDelete)</span><br><span class="line">        dwShareMode |= FILE_SHARE_DELETE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> dwFlagsAndAttributes = FILE_ATTRIBUTE_NORMAL;</span><br><span class="line">    <span class="keyword">int</span> dwCreationDisposition = OPEN_EXISTING;</span><br><span class="line">    <span class="keyword">if</span> (flags.write) &#123;</span><br><span class="line">        <span class="keyword">if</span> (flags.createNew) &#123;</span><br><span class="line">            dwCreationDisposition = CREATE_NEW;</span><br><span class="line">            <span class="comment">// force create to fail if file is orphaned reparse point</span></span><br><span class="line">            dwFlagsAndAttributes |= FILE_FLAG_OPEN_REPARSE_POINT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (flags.create)</span><br><span class="line">                dwCreationDisposition = OPEN_ALWAYS;</span><br><span class="line">            <span class="keyword">if</span> (flags.truncateExisting) &#123;</span><br><span class="line">                <span class="comment">// Windows doesn't have a creation disposition that exactly</span></span><br><span class="line">                <span class="comment">// corresponds to CREATE + TRUNCATE_EXISTING so we use</span></span><br><span class="line">                <span class="comment">// the OPEN_ALWAYS mode and then truncate the file.</span></span><br><span class="line">                <span class="keyword">if</span> (dwCreationDisposition == OPEN_ALWAYS) &#123;</span><br><span class="line">                    truncateAfterOpen = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    dwCreationDisposition = TRUNCATE_EXISTING;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flags.dsync || flags.sync)</span><br><span class="line">        dwFlagsAndAttributes |= FILE_FLAG_WRITE_THROUGH;</span><br><span class="line">    <span class="keyword">if</span> (flags.overlapped)</span><br><span class="line">        dwFlagsAndAttributes |= FILE_FLAG_OVERLAPPED;</span><br><span class="line">    <span class="keyword">if</span> (flags.deleteOnClose)</span><br><span class="line">        dwFlagsAndAttributes |= FILE_FLAG_DELETE_ON_CLOSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// NOFOLLOW_LINKS and NOFOLLOW_REPARSEPOINT mean open reparse point</span></span><br><span class="line">    <span class="keyword">boolean</span> okayToFollowLinks = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (dwCreationDisposition != CREATE_NEW &amp;&amp;</span><br><span class="line">        (flags.noFollowLinks ||</span><br><span class="line">         flags.openReparsePoint ||</span><br><span class="line">         flags.deleteOnClose))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (flags.noFollowLinks || flags.deleteOnClose)</span><br><span class="line">            okayToFollowLinks = <span class="keyword">false</span>;</span><br><span class="line">        dwFlagsAndAttributes |= FILE_FLAG_OPEN_REPARSE_POINT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// permission check</span></span><br><span class="line">    <span class="keyword">if</span> (pathToCheck != <span class="keyword">null</span>) &#123;</span><br><span class="line">        SecurityManager sm = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (flags.read)</span><br><span class="line">                sm.checkRead(pathToCheck);</span><br><span class="line">            <span class="keyword">if</span> (flags.write)</span><br><span class="line">                sm.checkWrite(pathToCheck);</span><br><span class="line">            <span class="keyword">if</span> (flags.deleteOnClose)</span><br><span class="line">                sm.checkDelete(pathToCheck);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// open file</span></span><br><span class="line">    <span class="keyword">long</span> handle = CreateFile(pathForWindows,</span><br><span class="line">                             dwDesiredAccess,</span><br><span class="line">                             dwShareMode,</span><br><span class="line">                             pSecurityDescriptor,</span><br><span class="line">                             dwCreationDisposition,</span><br><span class="line">                             dwFlagsAndAttributes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make sure this isn't a symbolic link.</span></span><br><span class="line">    <span class="keyword">if</span> (!okayToFollowLinks) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (WindowsFileAttributes.readAttributes(handle).isSymbolicLink())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> WindowsException(<span class="string">"File is symbolic link"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WindowsException x) &#123;</span><br><span class="line">            CloseHandle(handle);</span><br><span class="line">            <span class="keyword">throw</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// truncate file (for CREATE + TRUNCATE_EXISTING case)</span></span><br><span class="line">    <span class="keyword">if</span> (truncateAfterOpen) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SetEndOfFile(handle);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WindowsException x) &#123;</span><br><span class="line">            CloseHandle(handle);</span><br><span class="line">            <span class="keyword">throw</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make the file sparse if needed</span></span><br><span class="line">    <span class="keyword">if</span> (dwCreationDisposition == CREATE_NEW &amp;&amp; flags.sparse) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DeviceIoControlSetSparse(handle);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WindowsException x) &#123;</span><br><span class="line">            <span class="comment">// ignore as sparse option is hint</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create FileDescriptor and return</span></span><br><span class="line">    FileDescriptor fdObj = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">    fdAccess.setHandle(fdObj, handle);</span><br><span class="line">    <span class="keyword">return</span> fdObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类似地 linux上的实现由 UnixChannelFactory 完成</span></span><br><span class="line"><span class="comment">// 打开文件，获得文件描述符fd,然后创建 FileChannelImpl 对象。</span></span><br></pre></td></tr></table></figure></div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2016/10/19/IO-AsynchronousFileChannel/">AsynchronousFileChannel</a><a class="next" href="/2016/10/17/IO-Buffer/">Buffer</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/interface/" style="font-size: 15px;">interface</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/Collections/" style="font-size: 15px;">Collections</a> <a href="/tags/Collection/" style="font-size: 15px;">Collection</a> <a href="/tags/J-U-C/" style="font-size: 15px;">J.U.C</a> <a href="/tags/lock/" style="font-size: 15px;">lock</a> <a href="/tags/Semaphore/" style="font-size: 15px;">Semaphore</a> <a href="/tags/CountDownLatch/" style="font-size: 15px;">CountDownLatch</a> <a href="/tags/CyclicBarrier/" style="font-size: 15px;">CyclicBarrier</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/LinkedList/" style="font-size: 15px;">LinkedList</a> <a href="/tags/Queue/" style="font-size: 15px;">Queue</a> <a href="/tags/Set/" style="font-size: 15px;">Set</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/collection/" style="font-size: 15px;">collection</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/mvc/" style="font-size: 15px;">mvc</a> <a href="/tags/context/" style="font-size: 15px;">context</a> <a href="/tags/component-scan/" style="font-size: 15px;">component-scan</a> <a href="/tags/storm/" style="font-size: 15px;">storm</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/命令行/" style="font-size: 15px;">命令行</a> <a href="/tags/cmder/" style="font-size: 15px;">cmder</a> <a href="/tags/win/" style="font-size: 15px;">win</a> <a href="/tags/效率/" style="font-size: 15px;">效率</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/extends/" style="font-size: 15px;">extends</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/svn/" style="font-size: 15px;">svn</a> <a href="/tags/BlockingQueue/" style="font-size: 15px;">BlockingQueue</a> <a href="/tags/LinkedBlockingQueue/" style="font-size: 15px;">LinkedBlockingQueue</a> <a href="/tags/PriorityBlockingQueue/" style="font-size: 15px;">PriorityBlockingQueue</a> <a href="/tags/ConcurrentLinkedQueue/" style="font-size: 15px;">ConcurrentLinkedQueue</a> <a href="/tags/CopyOnWriteArrayList/" style="font-size: 15px;">CopyOnWriteArrayList</a> <a href="/tags/接口/" style="font-size: 15px;">接口</a> <a href="/tags/抽象类/" style="font-size: 15px;">抽象类</a> <a href="/tags/Executor/" style="font-size: 15px;">Executor</a> <a href="/tags/ExecutorService/" style="font-size: 15px;">ExecutorService</a> <a href="/tags/CompletionService/" style="font-size: 15px;">CompletionService</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 15px;">ThreadPoolExecutor</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/vundle/" style="font-size: 15px;">vundle</a> <a href="/tags/ArrayList/" style="font-size: 15px;">ArrayList</a> <a href="/tags/log/" style="font-size: 15px;">log</a> <a href="/tags/index/" style="font-size: 15px;">index</a> <a href="/tags/concepts/" style="font-size: 15px;">concepts</a> <a href="/tags/Timer/" style="font-size: 15px;">Timer</a> <a href="/tags/TimerTask/" style="font-size: 15px;">TimerTask</a> <a href="/tags/ConcurrentMap/" style="font-size: 15px;">ConcurrentMap</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 15px;">ConcurrentHashMap</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a> <a href="/tags/ReentrantReadWriteLock/" style="font-size: 15px;">ReentrantReadWriteLock</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/SynchronousQueue/" style="font-size: 15px;">SynchronousQueue</a> <a href="/tags/ScheduledExecutorService/" style="font-size: 15px;">ScheduledExecutorService</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/BigData-docker/">Windows 上安装 docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-0.路线/">Mysql学习路线</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-索引/">Mysql安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/Qunar基础框架-QSchedule/">Qunar基础框架-QSchedule</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/java集合构架中使用到的数据结构和算法/">java集合构架中使用到的数据结构和算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/20/reids-调试环境搭建/">redis-调试环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/OpenStack-安装/">OpenStack-安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/26/JVM-hotspot-GC机制/">JVM-hotspot-GC机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/11/netty-socketio + socket.io 实现消息推送/">netty-socketio + socket.io 实现消息推送</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/26/mongodb-安装/">mongodb-安装</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/a-ray-of-sunshine" title="github" target="_blank">github</a><ul></ul><a href="http://www.cnblogs.com/a-ray-of-sunshine" title="cnblog" target="_blank">cnblog</a><ul></ul><a href="http://blog.csdn.net/a_ray_of_sunshine" title="csdn" target="_blank">csdn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Shawshank.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>