<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>ESL内部实现 | Shawshank</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ESL内部实现</h1><a id="logo" href="/.">Shawshank</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ESL内部实现</h1><div class="post-meta">Oct 13, 2016</div><div class="post-content"><h2 id="ESL-Enterprise-Standard-Loader"><a href="#ESL-Enterprise-Standard-Loader" class="headerlink" title="ESL (Enterprise Standard Loader)"></a>ESL (Enterprise Standard Loader)</h2><blockquote>
<p>ESL是一个浏览器端、符合AMD的标准加载器，适合用于现代Web浏览器端应用的入口与模块管理。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>([<span class="string">'echarts'</span>, <span class="string">'echarts/chart/line'</span>, <span class="string">'echarts/chart/pie'</span>], dosomething);</span><br></pre></td></tr></table></figure>
<p>上面代码的执行流程是：</p>
<ol>
<li>require创建三个 script 标签’echarts’, ‘echarts/chart/line’, ‘echarts/chart/pie’</li>
<li>在上面动态创建的 script 标签中， 注册 onload 事件</li>
<li><p>onload 方法的实现，则是判断这个三个标签，是否全部加载完毕，当然，必然存在一个文件是最后被加载的，所以这个最后被加载的文件将调用 dosomething 方法。</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryFinishRequire</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span> &amp;&amp; !isCallbackCalled) &#123;</span><br><span class="line">        <span class="keyword">var</span> isAllCompleted = <span class="number">1</span>;</span><br><span class="line">        each(ids, <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!BUILDIN_MODULE[id]) &#123;</span><br><span class="line">                <span class="keyword">return</span> (isAllCompleted = !!modIs(id, MODULE_DEFINED));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检测并调用callback</span></span><br><span class="line">        <span class="keyword">if</span> (isAllCompleted) &#123;</span><br><span class="line">            isCallbackCalled = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            callback.apply(</span><br><span class="line">                global,</span><br><span class="line">                modGetModulesExports(ids, BUILDIN_MODULE)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><a href="https://github.com/ecomfe/esl/" target="_blank" rel="noopener">ecomfe/esl</a></p>
<p>类型功能的库：<a href="http://requirejs.org/" target="_blank" rel="noopener">RequireJS</a></p>
<p><a href="https://github.com/requirejs/requirejs/" target="_blank" rel="noopener">requirejs/requirejs</a></p>
<h2 id="require"><a href="#require" class="headerlink" title="require"></a>require</h2><p>使用 esl 的 require 可以实现动态加载 js ,例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在这里可以定义多个 package</span></span><br><span class="line"><span class="built_in">require</span>.config(&#123;</span><br><span class="line">		packages: [&#123;</span><br><span class="line">				name: <span class="string">'echarts'</span>,</span><br><span class="line">				location: <span class="string">'$&#123;pageContext.request.contextPath&#125;/js/echarts'</span>,	  </span><br><span class="line">				main: <span class="string">'echarts'</span></span><br><span class="line">			&#125;,&#123;</span><br><span class="line">				name: <span class="string">'zrender'</span>,</span><br><span class="line">				location: <span class="string">'$&#123;pageContext.request.contextPath&#125;/js/zrender'</span>, </span><br><span class="line">				main: <span class="string">'zrender'</span></span><br><span class="line">			&#125;]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一个参数指定，从哪个 package 中查找 location</span></span><br><span class="line"><span class="built_in">require</span>([<span class="string">'echarts'</span>, <span class="string">'echarts/chart/line'</span>], showLineChart);</span><br></pre></td></tr></table></figure>
<p><a href="hhttps://github.com/amdjs/amdjs-api/blob/master/CommonConfig.md" target="_blank" rel="noopener">Common-Config</a></p>
<p><a href="https://github.com/amdjs/amdjs-api/blob/master/require.md" target="_blank" rel="noopener">require(Array, Function)</a></p>
<p><a href="https://github.com/ecomfe/esl/blob/master/doc/config.md" target="_blank" rel="noopener">ESL配置</a></p>
<h2 id="why-require"><a href="#why-require" class="headerlink" title="why require?"></a>why require?</h2><ul>
<li><p>将js引入到项目中的全局变量进行了屏蔽，js 引入的功能通过变量引入 showLineChart，而不会污染整个页面中的全局变量。</p>
<p>  其实这里也存在一个问题，例如 jquery 将导出 $ 和 jQuery 这两个全局变量，如果使用这种方式，加载jquery,将 $ 的功能限制于，其回调函数，这是非常不方便的。</p>
</li>
<li><p>便于升级 require 所加载的库，因为具体的 js 都是由 require 的 packages 来描述的，如果需要升级则修改 location 即可。</p>
<p>  对于一个项目来说，通常只需要一个 require.config 即可，所以可以将 require.config 的单独放置到一个 js 当中。每一个具体的页面只需要引用这个js即可，这样当需要升级js时可以直接修改那一个js文件即可。</p>
</li>
</ul>
<h2 id="内部实现"><a href="#内部实现" class="headerlink" title="内部实现"></a>内部实现</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.1.4</span></span><br><span class="line"><span class="comment">// 121 行</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">globalRequire</span>(<span class="params">requireId, callback</span>) </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 82</span></span><br><span class="line"> <span class="keyword">var</span> actualGlobalRequire = createLocalRequire();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 1224</span></span><br><span class="line"><span class="comment">// 在这个函数中进行package的解析</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createLocalRequire</span>(<span class="params">baseId</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 765</span></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">nativeAsyncRequire</span>(<span class="params">ids, callback, baseId</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 821</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">loadModule</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 1574</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createScript</span>(<span class="params">moduleId, onload</span>) </span>&#123;</span><br></pre></td></tr></table></figure>
<h3 id="异步下载"><a href="#异步下载" class="headerlink" title="异步下载"></a>异步下载</h3><p>使用 <code>document.createElement</code> 创建一个 script 标签。然后前 src 设置成需要下载的script文件的路径。然后调用 <code>appendChild</code> 将 script 元素添加成 head 标签的子元素。由于设置了 <code>script.async = true</code>, 所以浏览器将执行异步下载。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个方法被 loadModule 方法调用用来加载 script 文件。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createScript</span>(<span class="params">moduleId, onload</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 创建script标签</span></span><br><span class="line">    <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">    script.setAttribute(<span class="string">'data-require-id'</span>, moduleId);</span><br><span class="line">    script.src = toUrl(moduleId + <span class="string">'.js'</span>);</span><br><span class="line">    script.async = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 设置回调</span></span><br><span class="line">    <span class="keyword">if</span> (script.readyState) &#123;</span><br><span class="line">        script.onreadystatechange = innerOnload;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        script.onload = innerOnload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. script 文件加载并执行完毕之后执行的回调函数</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">innerOnload</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> readyState = script.readyState;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="keyword">typeof</span> readyState === <span class="string">'undefined'</span></span><br><span class="line">            || <span class="regexp">/^(loaded|complete)$/</span>.test(readyState)</span><br><span class="line">        ) &#123;</span><br><span class="line">            script.onload = script.onreadystatechange = <span class="literal">null</span>;</span><br><span class="line">            script = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            onload();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ---------------------------------------</span></span><br><span class="line">    <span class="comment">// 4. !!!加载脚本!!!</span></span><br><span class="line">    <span class="comment">// currentlyAddingScript 变量用来跟踪当前正在添加的script文件</span></span><br><span class="line">    currentlyAddingScript = script;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将 新创建的 script 元素添加到 &lt;head&gt;&lt;/head&gt;</span></span><br><span class="line">	<span class="comment">// headElement 代表 head 标签，注意如果文档中没有 head 标签</span></span><br><span class="line">	<span class="comment">// 则可能出现问题:</span></span><br><span class="line">	<span class="comment">// var headElement = document.getElementsByTagName('head')[0];</span></span><br><span class="line">	<span class="comment">// appendChild 方法瘵新创建的 script 元素添加到 head 中。</span></span><br><span class="line">	<span class="comment">// 此时user agent(浏览器)将下载 script 文件。</span></span><br><span class="line">	<span class="comment">// 由于有 script.async 的设置，所以文件的下载将异步执行。</span></span><br><span class="line">	<span class="comment">// 而不会阻塞当前的线程的执行。</span></span><br><span class="line">    baseElement</span><br><span class="line">        ? headElement.insertBefore(script, baseElement)</span><br><span class="line">        : headElement.appendChild(script);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 由于 script 已经添加成功，所以将这个变量置为 null</span></span><br><span class="line">    currentlyAddingScript = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// ---------------------------------------</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="模块缓存"><a href="#模块缓存" class="headerlink" title="模块缓存"></a>模块缓存</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 正在加载的模块列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> loadingModules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; moduleId 模块标识</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadModule</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 加载过的模块，就不要再继续了</span></span><br><span class="line">    <span class="keyword">if</span> (loadingModules[moduleId] || modModules[moduleId]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载文件前将 moduleId 放置到 loadingModules 对象中，</span></span><br><span class="line">    <span class="comment">// 当下次还出现这个 moduleId 的时候，就可以直接返回了。</span></span><br><span class="line">    loadingModules[moduleId] = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送请求去加载模块</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">/* eslint-disable no-use-before-define */</span></span><br><span class="line">        <span class="keyword">var</span> bundleModuleId = bundlesIndex[moduleId];</span><br><span class="line">        createScript(bundleModuleId || moduleId, loaded);</span><br><span class="line">        <span class="comment">/* eslint-enable no-use-before-define */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// script标签加载完成的事件处理函数</span></span><br><span class="line">    <span class="comment">// 当 script 加载完毕之后，下面的处理按照 AMD</span></span><br><span class="line">    <span class="comment">// 进行模块的注册，其实就是记录模块的基本信息</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">loaded</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">// model 加载完毕之后，进行定义</span></span><br><span class="line">    	<span class="comment">// ==&gt; loaded</span></span><br><span class="line">    	<span class="comment">// ==&gt; modAutoDefine</span></span><br><span class="line">    	<span class="comment">// ==&gt; modUpdatePreparedState</span></span><br><span class="line">    	<span class="comment">// ==&gt; modPrepare</span></span><br><span class="line">    	<span class="comment">// ==&gt; modInitFactoryInvoker</span></span><br><span class="line">    	<span class="comment">// ==&gt; modDefined(调用回调)</span></span><br><span class="line">        modCompletePreDefine(moduleId);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// </span></span><br><span class="line">        modAutoDefine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回调函数的注册</span></span><br><span class="line"><span class="comment">// require(['echarts', 'echarts/chart/line'], dosomething);</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nativeAsyncRequire</span>(<span class="params">ids, callback, baseId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isCallbackCalled = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    each(ids, <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(BUILDIN_MODULE[id] || modIs(id, MODULE_DEFINED))) &#123;</span><br><span class="line">        	<span class="comment">// modAddDefinedListener 方法将 tryFinishRequire 这个回调</span></span><br><span class="line">        	<span class="comment">// 和上面的 ['echarts', 'echarts/chart/line'] 的两个模块</span></span><br><span class="line">        	<span class="comment">// 关联起来，这样当这几个模块中的最后一个被加载的模块</span></span><br><span class="line">        	<span class="comment">// 成功加载完毕之后 tryFinishRequire 就会执行 callback</span></span><br><span class="line">            modAddDefinedListener(id, tryFinishRequire);</span><br><span class="line">            (id.indexOf(<span class="string">'!'</span>) &gt; <span class="number">0</span></span><br><span class="line">                ? loadResource</span><br><span class="line">                : loadModule</span><br><span class="line">            )(id, baseId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    tryFinishRequire();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尝试完成require，调用callback</span></span><br><span class="line"><span class="comment">     * 在模块与其依赖模块都加载完时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">tryFinishRequire</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span> &amp;&amp; !isCallbackCalled) &#123;</span><br><span class="line">            <span class="keyword">var</span> isAllCompleted = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 检测所有的模块是否全部加载完毕</span></span><br><span class="line">            each(ids, <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!BUILDIN_MODULE[id]) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (isAllCompleted = !!modIs(id, MODULE_DEFINED));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检测并调用callback</span></span><br><span class="line">            <span class="keyword">if</span> (isAllCompleted) &#123;</span><br><span class="line">                isCallbackCalled = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                callback.apply(</span><br><span class="line">                    global,</span><br><span class="line">                    modGetModulesExports(ids, BUILDIN_MODULE)</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 描述一个模块的数据结构</span></span><br><span class="line"><span class="comment">// 模块容器</span></span><br><span class="line"><span class="keyword">var</span> modModules = &#123;&#125;;</span><br><span class="line"><span class="comment">// 模块内部信息包括</span></span><br><span class="line"><span class="comment">// -----------------------------------</span></span><br><span class="line"><span class="comment">// id: module id</span></span><br><span class="line"><span class="comment">// depsDec: 模块定义时声明的依赖</span></span><br><span class="line"><span class="comment">// deps: 模块依赖，默认为['require', 'exports', 'module']</span></span><br><span class="line"><span class="comment">// factory: 初始化函数或对象</span></span><br><span class="line"><span class="comment">// factoryDeps: 初始化函数的参数依赖</span></span><br><span class="line"><span class="comment">// exports: 模块的实际暴露对象（AMD定义）</span></span><br><span class="line"><span class="comment">// config: 用于获取模块配置信息的函数（AMD定义）</span></span><br><span class="line"><span class="comment">// state: 模块当前状态</span></span><br><span class="line"><span class="comment">// require: local require函数</span></span><br><span class="line"><span class="comment">// depMs: 实际依赖的模块集合，数组形式</span></span><br><span class="line"><span class="comment">// depMkv: 实际依赖的模块集合，表形式，便于查找</span></span><br><span class="line"><span class="comment">// depRs: 实际依赖的资源集合</span></span><br><span class="line"><span class="comment">// ------------------------------------</span></span><br><span class="line">modModules[id] = &#123;</span><br><span class="line">    id         : id,</span><br><span class="line">    depsDec    : dependencies,</span><br><span class="line">    deps       : dependencies || [<span class="string">'require'</span>, <span class="string">'exports'</span>, <span class="string">'module'</span>],</span><br><span class="line">    factoryDeps: [],</span><br><span class="line">    factory    : factory,</span><br><span class="line">    exports    : &#123;&#125;,</span><br><span class="line">    config     : moduleConfigGetter,</span><br><span class="line">    state      : MODULE_PRE_DEFINED,</span><br><span class="line">    <span class="built_in">require</span>    : createLocalRequire(id),</span><br><span class="line">    depMs      : [],</span><br><span class="line">    depMkv     : &#123;&#125;,</span><br><span class="line">    depRs      : [],</span><br><span class="line">    hang       : <span class="number">0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="执行回调"><a href="#执行回调" class="headerlink" title="执行回调"></a>执行回调</h2><h2 id="require-对名字的解析"><a href="#require-对名字的解析" class="headerlink" title="require 对名字的解析"></a>require 对名字的解析</h2><p>调用 <code>toUrl</code> 方法进行名称解析</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// toUrl(moduleId + '.js');</span></span><br><span class="line"><span class="comment">// 所以 source 参数的形式一般是 'moduleId.js' </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toUrl</span>(<span class="params">source, baseId</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 分离 模块标识 和 .extension</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 扩展名正则：扩展名可以是 [a-z0-9]+ 中的多个字符</span></span><br><span class="line">    <span class="comment">// 同时由于使用了 i ，所以是不区分大小写的</span></span><br><span class="line">    <span class="comment">// 12.js, abc.JS, qwe.Js 都可以匹配到。 </span></span><br><span class="line">    <span class="keyword">var</span> extReg = <span class="regexp">/(\.[a-z0-9]+)$/i</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// URL参数正则：url中可能带有参数，#部分代表网页中的一个位置</span></span><br><span class="line">    <span class="comment">// 其自身和http请求没有任何关系。</span></span><br><span class="line">    <span class="comment">// echarts/chart/line?param=value#location1.js</span></span><br><span class="line">    <span class="comment">// 下面的正则，将取出参数部分 ?param=value</span></span><br><span class="line">    <span class="keyword">var</span> queryReg = <span class="regexp">/(\?[^#]*)$/</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用来存储提取出的扩展名</span></span><br><span class="line">    <span class="keyword">var</span> extname = <span class="string">''</span>;</span><br><span class="line">    <span class="comment">// 用来存储提取出的id</span></span><br><span class="line">    <span class="keyword">var</span> id = source;</span><br><span class="line">    <span class="comment">// 用来存储提取出的参数</span></span><br><span class="line">    <span class="keyword">var</span> query = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (queryReg.test(source)) &#123;</span><br><span class="line">    	<span class="comment">// RegExp.$1 表示上面匹配到的第一个分组</span></span><br><span class="line">    	<span class="comment">// 也就是 query = '?param=value' </span></span><br><span class="line">        query = <span class="built_in">RegExp</span>.$<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 去掉 source 中的查询参数</span></span><br><span class="line">        source = source.replace(queryReg, <span class="string">''</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (extReg.test(source)) &#123;</span><br><span class="line">    	<span class="comment">// extname = '.js'</span></span><br><span class="line">        extname = <span class="built_in">RegExp</span>.$<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 去掉 source 中的后缀名</span></span><br><span class="line">        <span class="comment">// 此时 id = 'echarts/chart/line'</span></span><br><span class="line">        id = source.replace(extReg, <span class="string">''</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (baseId != <span class="literal">null</span>) &#123;</span><br><span class="line">        id = normalize(id, baseId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// echarts/chart/line</span></span><br><span class="line">    <span class="keyword">var</span> url = id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// paths处理和匹配</span></span><br><span class="line">    <span class="comment">// path 匹配和 packages 是互斥的。</span></span><br><span class="line">    <span class="comment">// 如果 id 和 pathsIndex 中的某个 item 中的某个 key </span></span><br><span class="line">    <span class="comment">// 匹配成功，则将其替换成 path 中对应的 value.</span></span><br><span class="line">    <span class="keyword">var</span> isPathMap;</span><br><span class="line">    indexRetrieve(id, pathsIndex, <span class="function"><span class="keyword">function</span> (<span class="params">value, key</span>) </span>&#123;</span><br><span class="line">    	<span class="comment">// 其实 key 和 url 应该是相同的，</span></span><br><span class="line">    	<span class="comment">// 所以下面的转换相当于 url = value</span></span><br><span class="line">        url = url.replace(key, value);</span><br><span class="line">        isPathMap = <span class="number">1</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packages处理和匹配</span></span><br><span class="line">    <span class="comment">// 如果 id 和  packagesIndex 中的某个 key(pkg.name) 匹配成功，则</span></span><br><span class="line">    <span class="comment">// 将 url 配置成  item.location。</span></span><br><span class="line">    <span class="keyword">if</span> (!isPathMap) &#123;</span><br><span class="line">        indexRetrieve(id, packagesIndex, <span class="function"><span class="keyword">function</span> (<span class="params">value, key, item</span>) </span>&#123;</span><br><span class="line">            url = url.replace(item.name, item.location);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相对路径时，附加baseUrl</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="regexp">/^([a-z]&#123;2,10&#125;:\/)?\//i</span>.test(url)) &#123;</span><br><span class="line">        url = requireConf.baseUrl + url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 附加 .extension 和 query</span></span><br><span class="line">    url += extname + query;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// urlArgs处理和匹配</span></span><br><span class="line">    indexRetrieve(id, urlArgsIndex, <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">        url += (url.indexOf(<span class="string">'?'</span>) &gt; <span class="number">0</span> ? <span class="string">'&amp;'</span> : <span class="string">'?'</span>) + value;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>([<span class="string">'echarts'</span>, <span class="string">'echarts/chart/line'</span>], dosomething);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 其中id参数就是 'echarts' 和 'echarts/chart/line'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">id, i</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> idInfo = parseId(id);</span><br><span class="line">    <span class="keyword">var</span> absId = normalize(idInfo.mod, baseId);</span><br><span class="line">    <span class="keyword">var</span> resId = idInfo.res;</span><br><span class="line">    <span class="keyword">var</span> normalizedId = absId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resId) &#123;</span><br><span class="line">        <span class="keyword">var</span> trueResId = absId + <span class="string">'!'</span> + resId;</span><br><span class="line">        <span class="keyword">if</span> (resId.indexOf(<span class="string">'.'</span>) !== <span class="number">0</span> &amp;&amp; bundlesIndex[trueResId]) &#123;</span><br><span class="line">            absId = normalizedId = trueResId;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            normalizedId = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    normalizedIds[i] = normalizedId;</span><br><span class="line">    modFlagAutoDefine(absId);</span><br><span class="line">    pureModules.push(absId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseId</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> segs = id.split(<span class="string">'!'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (segs[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            mod: segs[<span class="number">0</span>],</span><br><span class="line">            res: segs[<span class="number">1</span>]</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="require-对象的初始化"><a href="#require-对象的初始化" class="headerlink" title="require 对象的初始化"></a>require 对象的初始化</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * require配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @inner</span></span><br><span class="line"><span class="comment"> * @type &#123;Object&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> requireConf = &#123;</span><br><span class="line">    baseUrl    : <span class="string">'./'</span>,</span><br><span class="line">    paths      : &#123;&#125;,</span><br><span class="line">    config     : &#123;&#125;,</span><br><span class="line">    map        : &#123;&#125;,</span><br><span class="line">    packages   : [],</span><br><span class="line">    shim       : &#123;&#125;,</span><br><span class="line">    <span class="comment">// #begin-ignore</span></span><br><span class="line">    waitSeconds: <span class="number">0</span>,</span><br><span class="line">    <span class="comment">// #end-ignore</span></span><br><span class="line">    bundles    : &#123;&#125;,</span><br><span class="line">    urlArgs    : &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----</span></span><br><span class="line">paths:&#123;</span><br><span class="line">	echartsPath:<span class="string">'echarts/chart/line'</span>,</span><br><span class="line">	zrenderPath:<span class="string">'zrender'</span></span><br><span class="line">&#125;,</span><br><span class="line">packages: [</span><br><span class="line">	&#123;</span><br><span class="line">		name: <span class="string">'echarts'</span>,</span><br><span class="line">		location: <span class="string">'echarts'</span>,	  </span><br><span class="line">		main: <span class="string">'echarts'</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		name: <span class="string">'zrender'</span>,</span><br><span class="line">		location: <span class="string">'zrender/src'</span>,</span><br><span class="line">		main: <span class="string">'zrender'</span></span><br><span class="line">	&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这些配置项，都会在 require.config 方法中，转换成数组：</span></span><br><span class="line"></span><br><span class="line">paths ==&gt; pathsIndex = [&#123;<span class="attr">k</span>:<span class="string">'echartsPath'</span>,<span class="attr">v</span>:<span class="string">'echarts/chart/line'</span>,<span class="attr">reg</span>:<span class="string">'^&lt;k&gt;(\/|$)'</span>&#125;,&#123;<span class="attr">k</span>:<span class="string">'zrenderPath'</span>,<span class="attr">v</span>:<span class="string">'zrender'</span>,<span class="attr">reg</span>:<span class="string">'^&lt;k&gt;(\/|$)'</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----</span></span><br><span class="line"><span class="comment">// package 的转换方法</span></span><br><span class="line"><span class="comment">// 1. package 以字符串形式提供</span></span><br><span class="line"><span class="keyword">var</span> pkg = packageConf;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> packageConf === <span class="string">'string'</span>) &#123;</span><br><span class="line">    pkg = &#123;</span><br><span class="line">        name: packageConf.split(<span class="string">'/'</span>)[<span class="number">0</span>],</span><br><span class="line">        location: packageConf,</span><br><span class="line">        main: <span class="string">'main'</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pkg.location = pkg.location || pkg.name;</span><br><span class="line"><span class="comment">// pkg.main 默认为 'main', 如果 pkg.main 中带有 .js</span></span><br><span class="line"><span class="comment">// 后缀，则将其去掉</span></span><br><span class="line">pkg.main = (pkg.main || <span class="string">'main'</span>).replace(<span class="regexp">/\.js$/i</span>, <span class="string">''</span>);</span><br><span class="line"><span class="comment">// pkg.reg = '^&lt;pkg.name&gt;(\/|$)'</span></span><br><span class="line">pkg.reg = createPrefixRegexp(pkg.name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个方法就是我们调用的 require.config 方法</span></span><br><span class="line"><span class="comment">// 用来初始化 requireConf 对象。</span></span><br><span class="line">globalRequire.config = <span class="function"><span class="keyword">function</span> (<span class="params">conf</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conf) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> requireConf) &#123;</span><br><span class="line">            <span class="keyword">var</span> newValue = conf[key];</span><br><span class="line">            <span class="keyword">var</span> oldValue = requireConf[key];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!newValue) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (key === <span class="string">'urlArgs'</span> &amp;&amp; <span class="keyword">typeof</span> newValue === <span class="string">'string'</span>) &#123;</span><br><span class="line">                requireConf.urlArgs[<span class="string">'*'</span>] = newValue;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 简单的多处配置还是需要支持，所以配置实现为支持二级mix</span></span><br><span class="line">                <span class="keyword">if</span> (oldValue <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">                    oldValue.push.apply(oldValue, newValue);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> oldValue === <span class="string">'object'</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> newValue) &#123;</span><br><span class="line">                        oldValue[k] = newValue[k];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    requireConf[key] = newValue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        createConfIndex();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="浏览器解析html及script标签"><a href="#浏览器解析html及script标签" class="headerlink" title="浏览器解析html及script标签"></a>浏览器解析html及script标签</h2><p><a href="http://blog.csdn.net/horkychen/article/details/8888428" target="_blank" rel="noopener">[WebKit]WebCore之页面加载的设计与实现(一)</a></p>
<p><a href="https://webkit.org/blog/1188/how-webkit-loads-a-web-page/" target="_blank" rel="noopener">How WebKit Loads a Web Page</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.w3schools.com/tags/att_script_async.asp" target="_blank" rel="noopener">\&lt;script> async Attribute</a></li>
<li><a href="http://www.w3schools.com/tags/att_script_defer.asp" target="_blank" rel="noopener">\&lt;script> defer Attribute</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/web/1308_caiys_jsload/" target="_blank" rel="noopener">JavaScript 的性能优化：加载和执行</a></li>
<li><a href="http://pij.robinqu.me/Browser_Scripting/Document_Loading/ScriptTag.html" target="_blank" rel="noopener">Script标签和脚本执行顺序</a></li>
<li><a href="https://w3c.github.io/html/semantics-scripting.html" target="_blank" rel="noopener">HTML Scripting</a></li>
<li><a href="https://w3c.github.io/html/semantics-scripting.html#element-attrdef-script-async" target="_blank" rel="noopener">element-attrdef-script-async</a></li>
<li><a href="http://dev.chromium.org/" target="_blank" rel="noopener">The Chromium Projects</a></li>
<li><a href="https://src.chromium.org/viewvc" target="_blank" rel="noopener">chromium源码</a></li>
<li><a href="https://chromium.googlesource.com/" target="_blank" rel="noopener">Git repositories on chromium</a></li>
<li><a href="https://github.com/requirejs/requirejs/blob/master/require.js" target="_blank" rel="noopener">require.js</a></li>
<li><a href="https://github.com/ecomfe/esl/blob/master/src/esl.js" target="_blank" rel="noopener">esl.js</a></li>
<li><a href="https://www.w3.org/DOM/" target="_blank" rel="noopener">Document Object Model</a></li>
<li><a href="https://github.com/amdjs/amdjs-api" target="_blank" rel="noopener">amdjs-api</a></li>
<li><a href="https://github.com/amdjs/amdjs-api/blob/master/AMD.md" target="_blank" rel="noopener">Asynchronous Module Definition (AMD)</a></li>
<li><a href="http://requirejs.org/docs/api.html" target="_blank" rel="noopener">config 配置</a></li>
</ul>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2016/10/17/IO-Buffer/">Buffer</a><a class="next" href="/2016/10/12/IO-io包中的常用工具类/">io包中的常用工具类</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/interface/" style="font-size: 15px;">interface</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/Collections/" style="font-size: 15px;">Collections</a> <a href="/tags/Collection/" style="font-size: 15px;">Collection</a> <a href="/tags/J-U-C/" style="font-size: 15px;">J.U.C</a> <a href="/tags/lock/" style="font-size: 15px;">lock</a> <a href="/tags/Semaphore/" style="font-size: 15px;">Semaphore</a> <a href="/tags/CountDownLatch/" style="font-size: 15px;">CountDownLatch</a> <a href="/tags/CyclicBarrier/" style="font-size: 15px;">CyclicBarrier</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/LinkedList/" style="font-size: 15px;">LinkedList</a> <a href="/tags/Queue/" style="font-size: 15px;">Queue</a> <a href="/tags/Set/" style="font-size: 15px;">Set</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/collection/" style="font-size: 15px;">collection</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/mvc/" style="font-size: 15px;">mvc</a> <a href="/tags/context/" style="font-size: 15px;">context</a> <a href="/tags/component-scan/" style="font-size: 15px;">component-scan</a> <a href="/tags/storm/" style="font-size: 15px;">storm</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/命令行/" style="font-size: 15px;">命令行</a> <a href="/tags/cmder/" style="font-size: 15px;">cmder</a> <a href="/tags/win/" style="font-size: 15px;">win</a> <a href="/tags/效率/" style="font-size: 15px;">效率</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/extends/" style="font-size: 15px;">extends</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/svn/" style="font-size: 15px;">svn</a> <a href="/tags/BlockingQueue/" style="font-size: 15px;">BlockingQueue</a> <a href="/tags/LinkedBlockingQueue/" style="font-size: 15px;">LinkedBlockingQueue</a> <a href="/tags/PriorityBlockingQueue/" style="font-size: 15px;">PriorityBlockingQueue</a> <a href="/tags/ConcurrentLinkedQueue/" style="font-size: 15px;">ConcurrentLinkedQueue</a> <a href="/tags/CopyOnWriteArrayList/" style="font-size: 15px;">CopyOnWriteArrayList</a> <a href="/tags/接口/" style="font-size: 15px;">接口</a> <a href="/tags/抽象类/" style="font-size: 15px;">抽象类</a> <a href="/tags/Executor/" style="font-size: 15px;">Executor</a> <a href="/tags/ExecutorService/" style="font-size: 15px;">ExecutorService</a> <a href="/tags/CompletionService/" style="font-size: 15px;">CompletionService</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 15px;">ThreadPoolExecutor</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/vundle/" style="font-size: 15px;">vundle</a> <a href="/tags/ArrayList/" style="font-size: 15px;">ArrayList</a> <a href="/tags/log/" style="font-size: 15px;">log</a> <a href="/tags/index/" style="font-size: 15px;">index</a> <a href="/tags/concepts/" style="font-size: 15px;">concepts</a> <a href="/tags/Timer/" style="font-size: 15px;">Timer</a> <a href="/tags/TimerTask/" style="font-size: 15px;">TimerTask</a> <a href="/tags/ConcurrentMap/" style="font-size: 15px;">ConcurrentMap</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 15px;">ConcurrentHashMap</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a> <a href="/tags/ReentrantReadWriteLock/" style="font-size: 15px;">ReentrantReadWriteLock</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/SynchronousQueue/" style="font-size: 15px;">SynchronousQueue</a> <a href="/tags/ScheduledExecutorService/" style="font-size: 15px;">ScheduledExecutorService</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/BigData-docker/">Windows 上安装 docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-0.路线/">Mysql学习路线</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-索引/">Mysql安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/Qunar基础框架-QSchedule/">Qunar基础框架-QSchedule</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/java集合构架中使用到的数据结构和算法/">java集合构架中使用到的数据结构和算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/20/reids-调试环境搭建/">redis-调试环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/OpenStack-安装/">OpenStack-安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/26/JVM-hotspot-GC机制/">JVM-hotspot-GC机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/11/netty-socketio + socket.io 实现消息推送/">netty-socketio + socket.io 实现消息推送</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/26/mongodb-安装/">mongodb-安装</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/a-ray-of-sunshine" title="github" target="_blank">github</a><ul></ul><a href="http://www.cnblogs.com/a-ray-of-sunshine" title="cnblog" target="_blank">cnblog</a><ul></ul><a href="http://blog.csdn.net/a_ray_of_sunshine" title="csdn" target="_blank">csdn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Shawshank.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>