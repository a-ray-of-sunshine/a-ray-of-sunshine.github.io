<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>OutputStream | Shawshank</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">OutputStream</h1><a id="logo" href="/.">Shawshank</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">OutputStream</h1><div class="post-meta">Oct 2, 2016</div><div class="post-content"><h2 id="OutputStream"><a href="#OutputStream" class="headerlink" title="OutputStream"></a>OutputStream</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">OutputStream</span> <span class="keyword">implements</span> <span class="title">Closeable</span>, <span class="title">Flushable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 向流中写入 b 低8位字节，高 24 位字节被丢弃。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将缓存的字节全部写入底层的流中。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 关闭流</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ByteArrayOutputStream"><a href="#ByteArrayOutputStream" class="headerlink" title="ByteArrayOutputStream"></a>ByteArrayOutputStream</h3><p>这个类内部持有一个字节数据，write 方法就是将字节数据写入到该字节数据中。注意底层的 ByteArray 会随着不断的 write 而增大，所以底层的 Array 是无限大的。当然一旦写入的数据个数超过：Integer.MAX_VALUE，则OutOfMemoryError()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteArrayOutputStream</span> <span class="keyword">extends</span> <span class="title">OutputStream</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The buffer where data is stored.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">byte</span> buf[];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The number of valid bytes in the buffer.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>buf</p>
<p>  存储字节数据</p>
</li>
<li><p>count</p>
<p>  buf 中写入的有效字节个数</p>
</li>
</ul>
<h3 id="FileOutputStream"><a href="#FileOutputStream" class="headerlink" title="FileOutputStream"></a>FileOutputStream</h3><p>这个类的实现可以参考 openjdk1.7 的实现。</p>
<h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileOutputStream</span><span class="params">(File file, <span class="keyword">boolean</span> append)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> FileNotFoundException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 获得文件的路径</span></span><br><span class="line">    String name = (file != <span class="keyword">null</span> ? file.getPath() : <span class="keyword">null</span>);</span><br><span class="line">    SecurityManager security = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">        security.checkWrite(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建 fd 对象</span></span><br><span class="line">    <span class="keyword">this</span>.fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">    <span class="keyword">this</span>.append = append;</span><br><span class="line"></span><br><span class="line">    fd.incrementAndGetUseCount();</span><br><span class="line">    <span class="comment">// 打开文件。这是一个 native 方法</span></span><br><span class="line">	<span class="comment">// 在这个方法中将使用 name 打开文件，初始化 fd 中的文件描述符。</span></span><br><span class="line">	open(name, append);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="open-的实现"><a href="#open-的实现" class="headerlink" title="open 的实现"></a>open 的实现</h4><p>open 的实现在 jdk 中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/solaris/native/java/io</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_io_FileOutputStream_open(JNIEnv *env, jobject <span class="keyword">this</span>,</span><br><span class="line">                                   jstring path, jboolean append) &#123;</span><br><span class="line">    fileOpen(env, <span class="keyword">this</span>, path, fos_fd,</span><br><span class="line">             O_WRONLY | O_CREAT | (append ? O_APPEND : O_TRUNC));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/solaris/native/java/io/io_util_md.c</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">fileOpen(JNIEnv *env, jobject <span class="keyword">this</span>, jstring path, jfieldID fid, <span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    WITH_PLATFORM_STRING(env, path, ps) &#123;</span><br><span class="line">        FD fd;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></span><br><span class="line">        <span class="comment">/* Remove trailing slashes, since the kernel won't */</span></span><br><span class="line">        <span class="keyword">char</span> *p = (<span class="keyword">char</span> *)ps + <span class="built_in">strlen</span>(ps) - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> ((p &gt; ps) &amp;&amp; (*p == <span class="string">'/'</span>))</span><br><span class="line">            *p-- = <span class="string">'\0'</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	    <span class="comment">// ps 是转换后的路径path.</span></span><br><span class="line">		<span class="comment">// 调用 JVM_Open 方法打开文件。</span></span><br><span class="line">        fd = JVM_Open(ps, flags, <span class="number">0666</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// fd &gt;= 0 表示打开成功，返回一个有效的 fd</span></span><br><span class="line">        <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// 将 打开的文件描述符 fd 设置到 FileOutputStream.fd 对象的</span></span><br><span class="line">			<span class="comment">// fd 字段中。</span></span><br><span class="line">            SET_FD(<span class="keyword">this</span>, fd, fid);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            throwFileNotFoundException(env, path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; END_PLATFORM_STRING(env, ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JVM_Open 方法在 jvm 的实现中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/share/vm/prims/jvm.cpp</span></span><br><span class="line">JVM_LEAF(jint, JVM_Open(<span class="keyword">const</span> <span class="keyword">char</span> *fname, jint flags, jint mode))</span><br><span class="line">  JVMWrapper2(<span class="string">"JVM_Open (%s)"</span>, fname);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//%note jvm_r6</span></span><br><span class="line">  <span class="keyword">int</span> result = os::open(fname, flags, mode);</span><br><span class="line">  <span class="keyword">if</span> (result &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span>(errno) &#123;</span><br><span class="line">      <span class="keyword">case</span> EEXIST:</span><br><span class="line">        <span class="keyword">return</span> JVM_EEXIST;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">JVM_END</span><br><span class="line"></span><br><span class="line"><span class="comment">// os::open 的 linux 实现在</span></span><br><span class="line"><span class="comment">// src/os/linux/vm/os_linux.cpp 中</span></span><br><span class="line"><span class="comment">// 其中参数:</span></span><br><span class="line"><span class="comment">// oflag == O_WRONLY | O_CREAT | (append ? O_APPEND : O_TRUNC)</span></span><br><span class="line"><span class="comment">// mode  == 0666</span></span><br><span class="line"><span class="keyword">int</span> os::open(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">int</span> oflag, <span class="keyword">int</span> mode) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(path) &gt; MAX_PATH - <span class="number">1</span>) &#123;</span><br><span class="line">    errno = ENAMETOOLONG;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="keyword">int</span> o_delete = (oflag &amp; O_DELETE);</span><br><span class="line">  oflag = oflag &amp; ~O_DELETE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// open64 等价于 open 方法，这是一个 linux 系统调用，</span></span><br><span class="line">  <span class="comment">// 用来打开文件。其中参数：</span></span><br><span class="line">  <span class="comment">// oflag = O_WRONLY | O_CREAT | O_APPEND</span></span><br><span class="line">  <span class="comment">// O_WRONLY: write-only</span></span><br><span class="line">  <span class="comment">// O_CREAT: If the file does not exist it will be created.</span></span><br><span class="line">  <span class="comment">// O_APPEND: The  file is opened in append mode.</span></span><br><span class="line">  <span class="comment">// mode specifies the permissions to use in case a new file is created.</span></span><br><span class="line">  <span class="comment">// mode = 0666 表示，如果要打开的文件存在，则新创建的文件的权限为 666</span></span><br><span class="line">  <span class="comment">// 也就是 rw-rw-rw-</span></span><br><span class="line">  fd = ::open64(path, oflag, mode);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//If the open succeeded, the file might still be a directory</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat64</span> <span class="title">buf64</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret = ::fstat64(fd, &amp;buf64);</span><br><span class="line">    <span class="keyword">int</span> st_mode = buf64.st_mode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">-1</span>) &#123;</span><br><span class="line">	  <span class="comment">// 可以看到，如果文件成功打开，但是如果是目录的话，则 close 文件。</span></span><br><span class="line">      <span class="keyword">if</span> ((st_mode &amp; S_IFMT) == S_IFDIR) &#123;</span><br><span class="line">        errno = EISDIR;</span><br><span class="line">        ::close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ::close(fd);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="write-过程"><a href="#write-过程" class="headerlink" title="write 过程"></a>write 过程</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_io_FileOutputStream_write(JNIEnv *env, jobject <span class="keyword">this</span>, jint byte, jboolean append) &#123;</span><br><span class="line">    writeSingle(env, <span class="keyword">this</span>, byte, append, fos_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">writeSingle(JNIEnv *env, jobject <span class="keyword">this</span>, jint byte, jboolean append, jfieldID fid) &#123;</span><br><span class="line">    <span class="comment">// Discard the 24 high-order bits of byte. See OutputStream#write(int)</span></span><br><span class="line">	<span class="comment">// 可以看到，在这里直接将 int 类型的 byte, 直接强制转换成 char 类型</span></span><br><span class="line">	<span class="comment">// 注意这是 c 语言中的 char 类型，占一个字节，和 java 中的 char 完全不同。</span></span><br><span class="line">    <span class="keyword">char</span> c = (<span class="keyword">char</span>) byte;</span><br><span class="line">    jint n;</span><br><span class="line">	<span class="comment">// 获得文件描述符。</span></span><br><span class="line">    FD fd = GET_FD(<span class="keyword">this</span>, fid);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, <span class="string">"Stream Closed"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 写入一个字节。</span></span><br><span class="line">    <span class="keyword">if</span> (append == JNI_TRUE) &#123;</span><br><span class="line">        n = (jint)IO_Append(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        n = (jint)IO_Write(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n == JVM_IO_ERR) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"Write error"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n == JVM_IO_INTR) &#123;</span><br><span class="line">        JNU_ThrowByName(env, <span class="string">"java/io/InterruptedIOException"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/solaris/natvie/java/io/io_util_md.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Append JVM_Write</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_Write JVM_Write</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// jvm.cpp</span></span><br><span class="line">JVM_LEAF(jint, JVM_Write(jint fd, <span class="keyword">char</span> *buf, jint nbytes))</span><br><span class="line">  JVMWrapper2(<span class="string">"JVM_Write (0x%x)"</span>, fd);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//%note jvm_r6</span></span><br><span class="line">  <span class="keyword">return</span> (jint)os::write(fd, buf, nbytes);</span><br><span class="line">JVM_END</span><br><span class="line"></span><br><span class="line"><span class="comment">// os_linux.inline.hpp</span></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">size_t</span> os::write(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">int</span> nBytes) &#123;</span><br><span class="line">  <span class="keyword">size_t</span> res;</span><br><span class="line">  <span class="comment">// 其中 write 方法为一个系统调用：</span></span><br><span class="line">  <span class="comment">// writes up to count bytes from the buffer pointed buf to the file referred to by the file descriptor fd.</span></span><br><span class="line">  RESTARTABLE((<span class="keyword">size_t</span>) ::write(fd, buf, (<span class="keyword">size_t</span>) nBytes), res);</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="close-过程"><a href="#close-过程" class="headerlink" title="close 过程"></a>close 过程</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">fileClose(JNIEnv *env, jobject <span class="keyword">this</span>, jfieldID fid)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 1. 获得 fd</span></span><br><span class="line">    FD fd = GET_FD(<span class="keyword">this</span>, fid);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the fd to -1 before closing it so that the timing window</span></span><br><span class="line"><span class="comment">     * of other threads using the wrong fd (closed but recycled fd,</span></span><br><span class="line"><span class="comment">     * that gets re-opened with some other filename) is reduced.</span></span><br><span class="line"><span class="comment">     * Practically the chance of its occurance is low, however, we are</span></span><br><span class="line"><span class="comment">     * taking extra precaution over here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="comment">// 2. 关闭底层的fd之前，将 FileOutputStream.fd 中的 fd 字段</span></span><br><span class="line">	<span class="comment">// 置为无效，即 -1.</span></span><br><span class="line">    SET_FD(<span class="keyword">this</span>, <span class="number">-1</span>, fid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Don't close file descriptors 0, 1, or 2. If we close these stream</span></span><br><span class="line"><span class="comment">     * then a subsequent file open or socket will use them. Instead we</span></span><br><span class="line"><span class="comment">     * just redirect these file descriptors to /dev/null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= STDIN_FILENO &amp;&amp; fd &lt;= STDERR_FILENO) &#123;</span><br><span class="line">        <span class="keyword">int</span> devnull = open(<span class="string">"/dev/null"</span>, O_WRONLY);</span><br><span class="line">        <span class="keyword">if</span> (devnull &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            SET_FD(<span class="keyword">this</span>, fd, fid); <span class="comment">// restore fd</span></span><br><span class="line">            JNU_ThrowIOExceptionWithLastError(env, <span class="string">"open /dev/null failed"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dup2(devnull, fd);</span><br><span class="line">            close(devnull);</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">// 调用 JVM_Close 进行关闭。</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JVM_Close(fd) == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"close failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">JVM_LEAF(jint, JVM_Close(jint fd))</span><br><span class="line">  JVMWrapper2(<span class="string">"JVM_Close (0x%x)"</span>, fd);</span><br><span class="line">  <span class="comment">//%note jvm_r6</span></span><br><span class="line">  <span class="keyword">return</span> os::close(fd);</span><br><span class="line">JVM_END</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">int</span> os::close(<span class="keyword">int</span> fd) &#123;</span><br><span class="line">  <span class="comment">// close 方法为 linux 系统调用，用来关闭文件 fd.</span></span><br><span class="line">  <span class="keyword">return</span> ::close(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>close()  closes  a  file  descriptor, so that it no longer refers to any file and may be reused.  Any record locks (see fcntl(2)) held on the file it was associated with, and owned by the  process,  are  removed  (regardless  of  the  file descriptor that was used to obtain the lock).</p>
<p>If  fd is the last file descriptor referring to the underlying open file description (see open(2)), the resources associated with the open file description are freed; if the descriptor was the last reference to  a  file  which  has  been removed using unlink(2) the file is deleted.</p>
</blockquote>
<p>以上引用来自，linux 对 close 方法的描述，可以看到 close 方法的重要性，所以当流使用完毕一定要及时关闭。否则，底层的文件将一直被占用，无法释放，造成了资源的浪费。</p>
<h3 id="BufferedOutputStream"><a href="#BufferedOutputStream" class="headerlink" title="BufferedOutputStream"></a>BufferedOutputStream</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferedOutputStream</span> <span class="keyword">extends</span> <span class="title">FilterOutputStream</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The internal buffer where data is stored.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">byte</span> buf[];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BufferedOutputStream</span><span class="params">(OutputStream out)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(out, <span class="number">8192</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Flush the internal buffer */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flushBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            out.write(buf, <span class="number">0</span>, count);</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内部持有一个默认的 8K 的缓冲区 buf, write 操作优先写入这个buffer. 直到 buf 满了，调用 flushBuffer 将缓冲区内部的数据写入到底层的流中。</p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2016/10/03/IO-可打印流/">可打印流</a><a class="next" href="/2016/09/29/centos6.5安装CDH5.5.1/">centos6.5安装CDH5.5.1</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/interface/" style="font-size: 15px;">interface</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/Collections/" style="font-size: 15px;">Collections</a> <a href="/tags/Collection/" style="font-size: 15px;">Collection</a> <a href="/tags/J-U-C/" style="font-size: 15px;">J.U.C</a> <a href="/tags/lock/" style="font-size: 15px;">lock</a> <a href="/tags/Semaphore/" style="font-size: 15px;">Semaphore</a> <a href="/tags/CountDownLatch/" style="font-size: 15px;">CountDownLatch</a> <a href="/tags/CyclicBarrier/" style="font-size: 15px;">CyclicBarrier</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/LinkedList/" style="font-size: 15px;">LinkedList</a> <a href="/tags/Queue/" style="font-size: 15px;">Queue</a> <a href="/tags/Set/" style="font-size: 15px;">Set</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/collection/" style="font-size: 15px;">collection</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/mvc/" style="font-size: 15px;">mvc</a> <a href="/tags/context/" style="font-size: 15px;">context</a> <a href="/tags/component-scan/" style="font-size: 15px;">component-scan</a> <a href="/tags/storm/" style="font-size: 15px;">storm</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/命令行/" style="font-size: 15px;">命令行</a> <a href="/tags/cmder/" style="font-size: 15px;">cmder</a> <a href="/tags/win/" style="font-size: 15px;">win</a> <a href="/tags/效率/" style="font-size: 15px;">效率</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/extends/" style="font-size: 15px;">extends</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/svn/" style="font-size: 15px;">svn</a> <a href="/tags/BlockingQueue/" style="font-size: 15px;">BlockingQueue</a> <a href="/tags/LinkedBlockingQueue/" style="font-size: 15px;">LinkedBlockingQueue</a> <a href="/tags/PriorityBlockingQueue/" style="font-size: 15px;">PriorityBlockingQueue</a> <a href="/tags/ConcurrentLinkedQueue/" style="font-size: 15px;">ConcurrentLinkedQueue</a> <a href="/tags/CopyOnWriteArrayList/" style="font-size: 15px;">CopyOnWriteArrayList</a> <a href="/tags/接口/" style="font-size: 15px;">接口</a> <a href="/tags/抽象类/" style="font-size: 15px;">抽象类</a> <a href="/tags/Executor/" style="font-size: 15px;">Executor</a> <a href="/tags/ExecutorService/" style="font-size: 15px;">ExecutorService</a> <a href="/tags/CompletionService/" style="font-size: 15px;">CompletionService</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 15px;">ThreadPoolExecutor</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/vundle/" style="font-size: 15px;">vundle</a> <a href="/tags/ArrayList/" style="font-size: 15px;">ArrayList</a> <a href="/tags/log/" style="font-size: 15px;">log</a> <a href="/tags/index/" style="font-size: 15px;">index</a> <a href="/tags/concepts/" style="font-size: 15px;">concepts</a> <a href="/tags/Timer/" style="font-size: 15px;">Timer</a> <a href="/tags/TimerTask/" style="font-size: 15px;">TimerTask</a> <a href="/tags/ConcurrentMap/" style="font-size: 15px;">ConcurrentMap</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 15px;">ConcurrentHashMap</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a> <a href="/tags/ReentrantReadWriteLock/" style="font-size: 15px;">ReentrantReadWriteLock</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/SynchronousQueue/" style="font-size: 15px;">SynchronousQueue</a> <a href="/tags/ScheduledExecutorService/" style="font-size: 15px;">ScheduledExecutorService</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/BigData-docker/">Windows 上安装 docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-0.路线/">Mysql学习路线</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-索引/">Mysql安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/Qunar基础框架-QSchedule/">Qunar基础框架-QSchedule</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/java集合构架中使用到的数据结构和算法/">java集合构架中使用到的数据结构和算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/20/reids-调试环境搭建/">redis-调试环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/OpenStack-安装/">OpenStack-安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/26/JVM-hotspot-GC机制/">JVM-hotspot-GC机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/11/netty-socketio + socket.io 实现消息推送/">netty-socketio + socket.io 实现消息推送</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/26/mongodb-安装/">mongodb-安装</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/a-ray-of-sunshine" title="github" target="_blank">github</a><ul></ul><a href="http://www.cnblogs.com/a-ray-of-sunshine" title="cnblog" target="_blank">cnblog</a><ul></ul><a href="http://blog.csdn.net/a_ray_of_sunshine" title="csdn" target="_blank">csdn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Shawshank.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>