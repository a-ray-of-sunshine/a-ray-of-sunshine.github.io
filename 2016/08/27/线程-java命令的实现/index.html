<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>线程-java命令的实现 | Shawshank</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">线程-java命令的实现</h1><a id="logo" href="/.">Shawshank</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">线程-java命令的实现</h1><div class="post-meta">Aug 27, 2016</div><div class="post-content"><p>// 不同平台所共享的入口<br>java.c hotspot/src/share/tools/launcher</p>
<p>// 不同平台提供相应的实现<br>java_md.c </p>
<ul>
<li><p>win32</p>
<p>  hotspot/src/os/windows/launcher</p>
</li>
<li><p>posix</p>
<p>  hotspot/src/os/posix/launcher</p>
</li>
</ul>
<h2 id="解析主类和运行时环境"><a href="#解析主类和运行时环境" class="headerlink" title="解析主类和运行时环境"></a>解析主类和运行时环境</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Entry point.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv)</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 核心过程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 根据输入参数及运行的环境获取 java 执行环境</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateExecutionEnvironment 由 java_md.c 实现</span></span><br><span class="line"><span class="comment">// 在不同的平台上实现获得环境变量的方法不同</span></span><br><span class="line"><span class="comment">// 所以交由不同的平台来实现。</span></span><br><span class="line"><span class="comment">// 通过这个方法，初始化 jrepath &amp; jvmpath</span></span><br><span class="line">CreateExecutionEnvironment(&amp;argc, &amp;argv,</span><br><span class="line">                           jrepath, <span class="keyword">sizeof</span>(jrepath),</span><br><span class="line">                           jvmpath, <span class="keyword">sizeof</span>(jvmpath),</span><br><span class="line">                           original_argv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 加载虚拟机</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 jvmpath 加载虚拟机的 dll （或者 so 文件）</span></span><br><span class="line"><span class="comment">// 并初始化变量 InvocationFunctions ifn</span></span><br><span class="line"><span class="comment">// ifn 中的 CreateJavaVM 是一个函数指针，用来创建 JVM</span></span><br><span class="line">LoadJavaVM(jvmpath, &amp;ifn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 设置 CLASSPATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set default CLASSPATH */</span></span><br><span class="line"><span class="keyword">if</span> ((s = getenv(<span class="string">"CLASSPATH"</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="comment">// 如果没有CLASSPATH，则默认为当前目录</span></span><br><span class="line">    s = <span class="string">"."</span>;</span><br><span class="line">&#125;</span><br><span class="line">SetClassPath(s);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 创建新的线程来创建 JVM 然后调用 main 方法。</span></span><br><span class="line"><span class="comment">/* Create a new thread to create JVM and invoke main method */</span></span><br><span class="line"><span class="comment">// ContinueInNewThread 由不同的平台实现。所以在</span></span><br><span class="line"><span class="comment">// java_md.c 中</span></span><br><span class="line"><span class="comment">// 注意这里的 JavaMain 函数将成为新线程的入口点</span></span><br><span class="line"><span class="keyword">return</span> ContinueInNewThread(JavaMain, threadStackSize, (<span class="keyword">void</span>*)&amp;args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Pointers to the needed JNI invocation API, initialized by LoadJavaVM.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 函数指针：用来创建 JVM</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">jint</span> <span class="params">(JNICALL *CreateJavaVM_t)</span><span class="params">(JavaVM **pvm, <span class="keyword">void</span> **env, <span class="keyword">void</span> *args)</span></span>;</span><br><span class="line"><span class="comment">// 函数指针：获取 JVM 的初始化参数</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">jint</span> <span class="params">(JNICALL *GetDefaultJavaVMInitArgs_t)</span><span class="params">(<span class="keyword">void</span> *args)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    CreateJavaVM_t CreateJavaVM;</span><br><span class="line">    GetDefaultJavaVMInitArgs_t GetDefaultJavaVMInitArgs;</span><br><span class="line">&#125; InvocationFunctions;</span><br></pre></td></tr></table></figure>
<p>ContinueInNewThread</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建新的线程。</span></span><br><span class="line"><span class="comment">// 这里的 continuation 就是新的线程的入口 JavaMain</span></span><br><span class="line"><span class="comment">// 这个方法一经调用，新线程创建成功将开始执行 JavaMain 方法了。</span></span><br><span class="line">HANDLE thread_handle =</span><br><span class="line">  (HANDLE)_beginthreadex(<span class="literal">NULL</span>,</span><br><span class="line">                         (<span class="keyword">unsigned</span>)stack_size,</span><br><span class="line">                         continuation,</span><br><span class="line">                         args,</span><br><span class="line">                         STACK_SIZE_PARAM_IS_A_RESERVATION,</span><br><span class="line">                         &amp;thread_id);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (thread_handle) &#123;</span><br><span class="line">  <span class="comment">// 如果新线程创建成功，则当前线程进入等待状态</span></span><br><span class="line">  <span class="comment">// 直到新线程执行结束</span></span><br><span class="line">  WaitForSingleObject(thread_handle, INFINITE);</span><br><span class="line">  <span class="comment">// 获得 JVM 线程的返回结果</span></span><br><span class="line">  GetExitCodeThread(thread_handle, &amp;rslt);</span><br><span class="line">  <span class="comment">// 关闭线程句柄</span></span><br><span class="line">  CloseHandle(thread_handle);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 如果新线程创建抵账，则直接由当前线程开始运行 JVM</span></span><br><span class="line">  rslt = continuation(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JavaMain</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> JNICALL <span class="title">JavaMain</span><span class="params">(<span class="keyword">void</span> * _args)</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 初始化 JVM</span></span><br><span class="line"><span class="comment">/* Initialize the virtual machine */</span></span><br><span class="line"><span class="comment">// 初始化下面两个变量</span></span><br><span class="line">JavaVM *vm = <span class="number">0</span>;</span><br><span class="line">JNIEnv *env = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 初始化 JVM 及相关的所有子系统，加载相关的 JAVA 类</span></span><br><span class="line"><span class="comment">// 初始化 env ，提供 JNI 接口</span></span><br><span class="line">InitializeJVM(&amp;vm, &amp;env, &amp;ifn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Get the application's main class.</span></span><br><span class="line">mainClassName = GetMainClassName(env, jarfile);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Get the application's main method</span></span><br><span class="line">mainID = (*env)-&gt;GetStaticMethodID(env, mainClass, <span class="string">"main"</span>,</span><br><span class="line">                                   <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. Build argument array</span></span><br><span class="line">mainArgs = NewPlatformStringArray(env, argv, argc);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 调用主类的 main 方法 Invoke main method.</span></span><br><span class="line"><span class="comment">// 整个调用过程由 JNI 变量 env 完成。</span></span><br><span class="line">(*env)-&gt;CallStaticVoidMethod(env, mainClass, mainID, mainArgs);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. 销毁 JVM</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Wait for all non-daemon threads to end, then destroy the VM.</span></span><br><span class="line"><span class="comment"> * This will actually create a trivial new Java waiter thread</span></span><br><span class="line"><span class="comment"> * named "DestroyJavaVM", but this will be seen as a different</span></span><br><span class="line"><span class="comment"> * thread from the one that executed main, even though they are</span></span><br><span class="line"><span class="comment"> * the same C thread.  This allows mainThread.join() and</span></span><br><span class="line"><span class="comment"> * mainThread.isAlive() to work as expected.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// DestroyJavaVM 其实现在 jni.cpp 中 jni_DestroyJavaVM</span></span><br><span class="line">(*vm)-&gt;DestroyJavaVM(vm);</span><br></pre></td></tr></table></figure>
<h3 id="加载虚拟机-LoadJavaVM"><a href="#加载虚拟机-LoadJavaVM" class="headerlink" title="加载虚拟机 LoadJavaVM"></a>加载虚拟机 LoadJavaVM</h3><p>LoadJavaVM 在 java.c 的 main 函数中被调用<br>其定义在 java_md.c 中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LoadJavaVM(<span class="keyword">const</span> <span class="keyword">char</span> *jvmpath, InvocationFunctions *ifn)&#123;</span><br><span class="line"><span class="comment">// 1. 加载 jvm.dll</span></span><br><span class="line">HINSTANCE handle;</span><br><span class="line">handle = LoadLibrary(jvmpath)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 获得核心入口函数</span></span><br><span class="line"><span class="comment">/* Now get the function addresses */</span></span><br><span class="line">ifn-&gt;CreateJavaVM =</span><br><span class="line">    (<span class="keyword">void</span> *)GetProcAddress(handle, <span class="string">"JNI_CreateJavaVM"</span>);</span><br><span class="line">ifn-&gt;GetDefaultJavaVMInitArgs =</span><br><span class="line">    (<span class="keyword">void</span> *)GetProcAddress(handle, <span class="string">"JNI_GetDefaultJavaVMInitArgs"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化虚拟机-InitializeJVM"><a href="#初始化虚拟机-InitializeJVM" class="headerlink" title="初始化虚拟机 InitializeJVM"></a>初始化虚拟机 InitializeJVM</h3><p>InitializeJVM 在 java.c 的 JavaMain 函数中被调用<br>其定义在 java.c 中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">InitializeJVM</span><span class="params">(JavaVM **pvm, JNIEnv **penv, InvocationFunctions *ifn)</span></span>&#123;</span><br><span class="line">    JavaVMInitArgs args;</span><br><span class="line">    jint r;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;args, <span class="number">0</span>, <span class="keyword">sizeof</span>(args));</span><br><span class="line">    args.version  = JNI_VERSION_1_2;</span><br><span class="line">    args.nOptions = numOptions;</span><br><span class="line">	<span class="comment">// options 全局变量，</span></span><br><span class="line">    args.options  = options;</span><br><span class="line">    args.ignoreUnrecognized = JNI_FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ifn 在 LoadJavaVM 被初始化</span></span><br><span class="line">	<span class="comment">// CreateJavaVM 对应 JNI_CreateJavaVM</span></span><br><span class="line">	<span class="comment">// 这个函数定义在 jni.cpp 中</span></span><br><span class="line">	r = ifn-&gt;CreateJavaVM(pvm, (<span class="keyword">void</span> **)penv, &amp;args);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> r == JNI_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="JNI-CreateJavaVM"><a href="#JNI-CreateJavaVM" class="headerlink" title="JNI_CreateJavaVM"></a>JNI_CreateJavaVM</h2><p>// jni.cpp<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个方法的作用是 创建 JVM</span></span><br><span class="line"><span class="comment">// 初始化参数 vm &amp; penv</span></span><br><span class="line">_<span class="function">JNI_IMPORT_OR_EXPORT_ jint JNICALL <span class="title">JNI_CreateJavaVM</span><span class="params">(JavaVM **vm, <span class="keyword">void</span> **penv, <span class="keyword">void</span> *args)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 1. 创建 VM</span></span><br><span class="line">	result = Threads::create_vm((JavaVMInitArgs*) args, &amp;can_try_again);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 初始化参数</span></span><br><span class="line">	JavaThread *thread = JavaThread::current();</span><br><span class="line">	<span class="comment">// main_vm 是一个全局变量，提供了 5 个接口指针</span></span><br><span class="line">    *vm = (JavaVM *)(&amp;main_vm);</span><br><span class="line">	<span class="comment">// JNIEnv 包括由函数指针构成的结构体</span></span><br><span class="line">	<span class="comment">// 相当于 JVM 提供的 一系列接口，加载类，执行类的方法都依靠这个指针</span></span><br><span class="line">	<span class="comment">// 这里的 penv 指向的 变量 是 线程对应  thread 在创建的时候</span></span><br><span class="line">	<span class="comment">// 初始化好的，new JavaThread 中 调用 initialize，</span></span><br><span class="line">	<span class="comment">// initialize 调用 set_jni_functions(jni_functions());</span></span><br><span class="line">	<span class="comment">// jni 的功能都实现在 jni.cpp 中。</span></span><br><span class="line">    *(JNIEnv**)penv = thread-&gt;jni_environment();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JavaVM_</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNIInvokeInterface_</span> *<span class="title">functions</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"></span><br><span class="line">    <span class="function">jint <span class="title">DestroyJavaVM</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> functions-&gt;DestroyJavaVM(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">jint <span class="title">AttachCurrentThread</span><span class="params">(<span class="keyword">void</span> **penv, <span class="keyword">void</span> *args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> functions-&gt;AttachCurrentThread(<span class="keyword">this</span>, penv, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">jint <span class="title">DetachCurrentThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> functions-&gt;DetachCurrentThread(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">jint <span class="title">GetEnv</span><span class="params">(<span class="keyword">void</span> **penv, jint version)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> functions-&gt;GetEnv(<span class="keyword">this</span>, penv, version);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">jint <span class="title">AttachCurrentThreadAsDaemon</span><span class="params">(<span class="keyword">void</span> **penv, <span class="keyword">void</span> *args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> functions-&gt;AttachCurrentThreadAsDaemon(<span class="keyword">this</span>, penv, args);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JavaVM_</span> <span class="title">main_vm</span> = &#123;</span>&amp;jni_InvokeInterface&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNIInvokeInterface_</span> <span class="title">jni_InvokeInterface</span> = &#123;</span></span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line"></span><br><span class="line">    jni_DestroyJavaVM,</span><br><span class="line">    jni_AttachCurrentThread,</span><br><span class="line">    jni_DetachCurrentThread,</span><br><span class="line">    jni_GetEnv,</span><br><span class="line">    jni_AttachCurrentThreadAsDaemon</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Thread.cpp</span></span><br><span class="line"><span class="comment">// 这个方法的主要作用就是创建 main_thread 对象，代表 JVM 主线程。</span></span><br><span class="line"><span class="comment">// 初始化 java 运行时环境，载入 java 运行时系统</span></span><br><span class="line"><span class="comment">// 这个方法是创建 JVM 的核心</span></span><br><span class="line">jint Threads::create_vm(JavaVMInitArgs* args, <span class="keyword">bool</span>* canTryAgain) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. Initialize TLS</span></span><br><span class="line"><span class="comment">// 为 main_thread 分配 TLS 索引</span></span><br><span class="line">ThreadLocalStorage::init();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 创建代表当前主线程的 JavaThread 对应 main_thread.</span></span><br><span class="line">JavaThread* main_thread = <span class="keyword">new</span> JavaThread();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 当 main_thread 放置成 TLS 中</span></span><br><span class="line"><span class="comment">// Attach the main thread to this os thread</span></span><br><span class="line"><span class="comment">// main_thread-&gt;initialize_thread_local_storage 实现：</span></span><br><span class="line"><span class="comment">// ThreadLocalStorage::set_thread(this);</span></span><br><span class="line">main_thread-&gt;initialize_thread_local_storage();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="如何获得当前线程"><a href="#如何获得当前线程" class="headerlink" title="如何获得当前线程"></a>如何获得当前线程</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> JavaThread* JavaThread::current() &#123;</span><br><span class="line">  Thread* thread = ThreadLocalStorage::thread();</span><br><span class="line">  assert(thread != <span class="literal">NULL</span> &amp;&amp; thread-&gt;is_Java_thread(), <span class="string">"just checking"</span>);</span><br><span class="line">  <span class="keyword">return</span> (JavaThread*)thread;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ThreadLocalStorage 这个类是由不同平台实现的</span></span><br><span class="line"><span class="comment">// ThreadLocalStorage 类定义在 runtime/threadLocalStorage.hpp</span></span><br><span class="line"><span class="comment">// Interface for thread local storage</span></span><br><span class="line"><span class="comment">// Fast variant of ThreadLocalStorage::get_thread_slow</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function">Thread*   <span class="title">get_thread</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get raw thread id: e.g., %g7 on sparc, fs or gs on x86</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">uintptr_t</span> _raw_thread_id();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalStorage</span> :</span> AllStatic &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span>    <span class="title">set_thread</span><span class="params">(Thread* thread)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> Thread* <span class="title">get_thread_slow</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span>    <span class="title">invalidate_all</span><span class="params">()</span> </span>&#123; pd_invalidate_all(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Machine dependent stuff</span></span><br><span class="line"><span class="comment">// win32 实现定义在: </span></span><br><span class="line"><span class="comment">// hotspot\src\os_cpu\windows_x86\vm\threadLS_windows_x86.hpp</span></span><br><span class="line"><span class="comment">// Processor dependent parts of ThreadLocalStorage</span></span><br><span class="line"><span class="comment">// ---- win32 ----</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> _thread_ptr_offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Java Thread</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> Thread* <span class="title">thread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Thread*)TlsGetValue(thread_index());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> Thread* <span class="title">get_thread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Thread*)TlsGetValue(thread_index());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">set_thread_ptr_offset</span><span class="params">( <span class="keyword">int</span> offset )</span> </span>&#123; _thread_ptr_offset = offset; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">get_thread_ptr_offset</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _thread_ptr_offset; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---- win32 ----</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// Accessor</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span>  <span class="title">thread_index</span><span class="params">()</span>              </span>&#123; <span class="keyword">return</span> _thread_index; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">set_thread_index</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123; _thread_index = index; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialization</span></span><br><span class="line">  <span class="comment">// Called explicitly from VMThread::activate_system instead of init_globals.</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">is_initialized</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span>     _thread_index;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span>    <span class="title">generate_code_for_get_thread</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Processor dependent parts of set_thread and initialization</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pd_set_thread</span><span class="params">(Thread* thread)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pd_init</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">// Invalidate any thread cacheing or optimization schemes.</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pd_invalidate_all</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ThreadLocalStorage 类的 实现部分定义在</span></span><br><span class="line"><span class="comment">// hotspot\src\share\vm\runtime\threadLocalStorage.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 win32 平台上还包括下面的文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"os_windows.inline.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"thread_windows.inline.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ----share实现部分---</span></span><br><span class="line"><span class="comment">// static member initialization</span></span><br><span class="line"><span class="keyword">int</span> ThreadLocalStorage::_thread_index = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">Thread* ThreadLocalStorage::get_thread_slow() &#123;</span><br><span class="line">  <span class="keyword">return</span> (Thread*) os::thread_local_storage_at(ThreadLocalStorage::thread_index());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ThreadLocalStorage::set_thread(Thread* thread) &#123;</span><br><span class="line">  <span class="comment">// 调用具体平台的实现</span></span><br><span class="line">  pd_set_thread(thread);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The following ensure that any optimization tricks we have tried</span></span><br><span class="line">  <span class="comment">// did not backfire on us:</span></span><br><span class="line">  guarantee(get_thread()      == thread, <span class="string">"must be the same thread, quickly"</span>);</span><br><span class="line">  guarantee(get_thread_slow() == thread, <span class="string">"must be the same thread, slowly"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ThreadLocalStorage::init() &#123;</span><br><span class="line">  assert(!is_initialized(),</span><br><span class="line">         <span class="string">"More than one attempt to initialize threadLocalStorage"</span>);</span><br><span class="line">  <span class="comment">// 在 win32 平台上面 pd_init 是空实现</span></span><br><span class="line">  pd_init();</span><br><span class="line">  <span class="comment">// 初始化 thread_index 为一个 TLS index.</span></span><br><span class="line">  set_thread_index(os::allocate_thread_local_storage());</span><br><span class="line">  generate_code_for_get_thread();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> ThreadLocalStorage::is_initialized() &#123;</span><br><span class="line">    <span class="keyword">return</span> (thread_index() != <span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ----share实现部分---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// -----win32 实现部分，-----</span></span><br><span class="line"><span class="comment">// hotspot\src\os_cpu\windows_x86\vm\threadLS_windows_x86.cpp</span></span><br><span class="line"><span class="keyword">int</span> ThreadLocalStorage::_thread_ptr_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">call_wrapper_dummy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We need to call the os_exception_wrapper once so that it sets</span></span><br><span class="line"><span class="comment">// up the offset from FS of the thread pointer.</span></span><br><span class="line"><span class="keyword">void</span> ThreadLocalStorage::generate_code_for_get_thread() &#123;</span><br><span class="line">      os::os_exception_wrapper( (<span class="keyword">java_call_t</span>)call_wrapper_dummy,</span><br><span class="line">                                <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ThreadLocalStorage::pd_init() &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ThreadLocalStorage::pd_set_thread(Thread* thread)  &#123;</span><br><span class="line">  <span class="comment">// 将 thread 对应放置到 TLS</span></span><br><span class="line">  os::thread_local_storage_at_put(ThreadLocalStorage::thread_index(), thread);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ------win32------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// os_windows.cpp</span></span><br><span class="line"><span class="comment">// Allocates a thread local storage (TLS) index.</span></span><br><span class="line"><span class="comment">// 这个函数返回一个 TLS 索引，</span></span><br><span class="line"><span class="comment">// 分配</span></span><br><span class="line"><span class="keyword">int</span> os::allocate_thread_local_storage() &#123;</span><br><span class="line">  <span class="keyword">return</span> TlsAlloc();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放</span></span><br><span class="line"><span class="keyword">void</span> os::free_thread_local_storage(<span class="keyword">int</span> index) &#123;</span><br><span class="line">  TlsFree(index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置</span></span><br><span class="line"><span class="keyword">void</span> os::thread_local_storage_at_put(<span class="keyword">int</span> index, <span class="keyword">void</span>* value) &#123;</span><br><span class="line">  TlsSetValue(index, value);</span><br><span class="line">  assert(thread_local_storage_at(index) == value, <span class="string">"Just checking"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取</span></span><br><span class="line"><span class="keyword">void</span>* os::thread_local_storage_at(<span class="keyword">int</span> index) &#123;</span><br><span class="line">  <span class="keyword">return</span> TlsGetValue(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">JVM_ENTRY(jobject, JVM_CurrentThread(JNIEnv* env, jclass threadClass))</span><br><span class="line">  JVMWrapper(<span class="string">"JVM_CurrentThread"</span>);</span><br><span class="line">  oop jthread = thread-&gt;threadObj();</span><br><span class="line">  assert (thread != <span class="literal">NULL</span>, <span class="string">"no current thread!"</span>);</span><br><span class="line">  <span class="keyword">return</span> JNIHandles::make_local(env, jthread);</span><br><span class="line">JVM_END</span><br><span class="line"></span><br><span class="line">因为每一个 JavaThread 都有一个 _jni_environment，所以每一个线程调用 native 方法时 其 JNIEnv 是不同的，应该是当前线程的 JNIEnv 变量。</span><br><span class="line"></span><br><span class="line">JavaThread ------&gt;  +-----------------+ --&#125;</span><br><span class="line">					|                 |   |</span><br><span class="line">					|   other_vars    |   |</span><br><span class="line">					+-----------------+   |---&gt; in_bytes(jni_environment_offset())                               </span><br><span class="line">					|                 |   |</span><br><span class="line">					|_jni_environment |   |</span><br><span class="line">(<span class="keyword">intptr_t</span>)env &lt;---- +-----------------+ --&#125;</span><br><span class="line">					|                 |</span><br><span class="line">					|   other_vars    |</span><br><span class="line">					+-----------------+</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JavaThread</span>:</span> <span class="keyword">public</span> Thread &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	JNIEnv        _jni_environment;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">从上图可以观察到：当一个线程调用 Thread.currentThread() 时，</span><br><span class="line"></span><br><span class="line">env 变量是已知的，同时这个 env 变量也是当前 JavaThread 对象的一个成员变量，则依据 env 在 JavaThread 中的类结构</span><br><span class="line">的位置，可以计算出 env 所以 JavaThread 的偏移量，此时计算 当前的线程对象：</span><br><span class="line"></span><br><span class="line">JavaThread *thread = (JavaThread*)((<span class="keyword">intptr_t</span>)env - in_bytes(jni_environment_offset()));</span><br><span class="line"></span><br><span class="line">所以 Thread.currentThread 是依据 env 所在的内存布局，计算而来，这样计算非常快速。</span><br></pre></td></tr></table></figure>
<h2 id="新启动的-java-线程"><a href="#新启动的-java-线程" class="headerlink" title="新启动的 java 线程"></a>新启动的 java 线程</h2><p>对于第一个新启动的线程，都会将其自身 JavaThread 对象放置到 TLS 中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The first routine called by a new Java thread</span></span><br><span class="line"><span class="keyword">void</span> JavaThread::run() &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize thread local storage; set before calling MutexLocker</span></span><br><span class="line">  <span class="comment">// 调用 TLS ThreadLocalStorage::set_thread(this);</span></span><br><span class="line">  <span class="keyword">this</span>-&gt;initialize_thread_local_storage();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2016/08/30/JVM-JNI/">JVM-JNI</a><a class="next" href="/2016/08/27/线程-线程本地存储/">线程-线程本地存储</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/interface/" style="font-size: 15px;">interface</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/Collections/" style="font-size: 15px;">Collections</a> <a href="/tags/Collection/" style="font-size: 15px;">Collection</a> <a href="/tags/J-U-C/" style="font-size: 15px;">J.U.C</a> <a href="/tags/lock/" style="font-size: 15px;">lock</a> <a href="/tags/Semaphore/" style="font-size: 15px;">Semaphore</a> <a href="/tags/CyclicBarrier/" style="font-size: 15px;">CyclicBarrier</a> <a href="/tags/CountDownLatch/" style="font-size: 15px;">CountDownLatch</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/LinkedList/" style="font-size: 15px;">LinkedList</a> <a href="/tags/Queue/" style="font-size: 15px;">Queue</a> <a href="/tags/Set/" style="font-size: 15px;">Set</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/collection/" style="font-size: 15px;">collection</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/mvc/" style="font-size: 15px;">mvc</a> <a href="/tags/context/" style="font-size: 15px;">context</a> <a href="/tags/component-scan/" style="font-size: 15px;">component-scan</a> <a href="/tags/storm/" style="font-size: 15px;">storm</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/命令行/" style="font-size: 15px;">命令行</a> <a href="/tags/cmder/" style="font-size: 15px;">cmder</a> <a href="/tags/win/" style="font-size: 15px;">win</a> <a href="/tags/效率/" style="font-size: 15px;">效率</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/extends/" style="font-size: 15px;">extends</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/svn/" style="font-size: 15px;">svn</a> <a href="/tags/BlockingQueue/" style="font-size: 15px;">BlockingQueue</a> <a href="/tags/LinkedBlockingQueue/" style="font-size: 15px;">LinkedBlockingQueue</a> <a href="/tags/PriorityBlockingQueue/" style="font-size: 15px;">PriorityBlockingQueue</a> <a href="/tags/ConcurrentLinkedQueue/" style="font-size: 15px;">ConcurrentLinkedQueue</a> <a href="/tags/CopyOnWriteArrayList/" style="font-size: 15px;">CopyOnWriteArrayList</a> <a href="/tags/接口/" style="font-size: 15px;">接口</a> <a href="/tags/抽象类/" style="font-size: 15px;">抽象类</a> <a href="/tags/Executor/" style="font-size: 15px;">Executor</a> <a href="/tags/ExecutorService/" style="font-size: 15px;">ExecutorService</a> <a href="/tags/CompletionService/" style="font-size: 15px;">CompletionService</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 15px;">ThreadPoolExecutor</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/vundle/" style="font-size: 15px;">vundle</a> <a href="/tags/ArrayList/" style="font-size: 15px;">ArrayList</a> <a href="/tags/log/" style="font-size: 15px;">log</a> <a href="/tags/index/" style="font-size: 15px;">index</a> <a href="/tags/concepts/" style="font-size: 15px;">concepts</a> <a href="/tags/Timer/" style="font-size: 15px;">Timer</a> <a href="/tags/TimerTask/" style="font-size: 15px;">TimerTask</a> <a href="/tags/ConcurrentMap/" style="font-size: 15px;">ConcurrentMap</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 15px;">ConcurrentHashMap</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a> <a href="/tags/ReentrantReadWriteLock/" style="font-size: 15px;">ReentrantReadWriteLock</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/SynchronousQueue/" style="font-size: 15px;">SynchronousQueue</a> <a href="/tags/ScheduledExecutorService/" style="font-size: 15px;">ScheduledExecutorService</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/BigData-docker/">Windows 上安装 docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-0.路线/">Mysql学习路线</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/mysql-索引/">Mysql安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/Qunar基础框架-QSchedule/">Qunar基础框架-QSchedule</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/java集合构架中使用到的数据结构和算法/">java集合构架中使用到的数据结构和算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/20/reids-调试环境搭建/">redis-调试环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/OpenStack-安装/">OpenStack-安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/26/JVM-hotspot-GC机制/">JVM-hotspot-GC机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/11/netty-socketio + socket.io 实现消息推送/">netty-socketio + socket.io 实现消息推送</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/26/mongodb-安装/">mongodb-安装</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/a-ray-of-sunshine" title="github" target="_blank">github</a><ul></ul><a href="http://www.cnblogs.com/a-ray-of-sunshine" title="cnblog" target="_blank">cnblog</a><ul></ul><a href="http://blog.csdn.net/a_ray_of_sunshine" title="csdn" target="_blank">csdn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Shawshank.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>